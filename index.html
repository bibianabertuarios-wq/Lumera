<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumera - Cuando tu cuerpo cambia, tener un plan lo cambia todo</title>
    <meta name="description" content="Acompa√±amiento personalizado para mujeres 40+ | Personalized support for women 40+">
    <meta name="keywords" content="bienestar mujeres 40+, nutrici√≥n personalizada, salud mujer, wellness, women health">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3, h4, h5, h6 { 
            font-family: 'Cormorant', serif;
            font-weight: 500;
            letter-spacing: -0.02em;
        }
        
        body {
            background: #fafaf9;
        }
        
        /* DISE√ëO ELEGANTE - CSS Adicional */
        
        /* Bot√≥n Premium sutil */
        .btn-premium {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4c1 100%);
            color: #78716c;
            font-weight: 500;
            padding: 0.625rem 1.5rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.15);
        }
        
        .btn-premium:hover {
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.25);
            transform: translateY(-1px);
        }
        
        /* Bot√≥n CTA elegante */
        .btn-cta-elegant {
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            color: white;
            padding: 1rem 2.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            font-size: 1rem;
            letter-spacing: 0.01em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(167, 139, 250, 0.2);
        }
        
        .btn-cta-elegant:hover {
            box-shadow: 0 8px 24px rgba(167, 139, 250, 0.3);
            transform: translateY(-2px);
        }
        
        /* Tarjetas elegantes */
        .card-elegant {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            border: 1px solid rgba(120, 113, 108, 0.08);
        }
        
        .card-elegant:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transform: translateY(-4px);
        }
        
        /* Input elegante */
        .input-elegant {
            background: white;
            border: 1.5px solid rgba(120, 113, 108, 0.15);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: #44403c;
        }
        
        .input-elegant:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
        }
        
        .input-elegant::placeholder {
            color: #a8a29e;
        }
        
        /* Navbar sutil */
        .navbar-elegant {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(120, 113, 108, 0.08);
        }
        
        /* Badge sutil */
        .badge-subtle {
            background: rgba(167, 139, 250, 0.1);
            color: #7c3aed;
            padding: 0.375rem 1rem;
            border-radius: 9999px;
            font-size: 0.8125rem;
            font-weight: 500;
            letter-spacing: 0.025em;
        }
        
        /* Stats elegante */
        .stats-elegant {
            background: linear-gradient(135deg, 
                rgba(167, 139, 250, 0.08) 0%, 
                rgba(192, 132, 252, 0.06) 100%
            );
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(167, 139, 250, 0.12);
        }
        
        /* HERO H√çBRIDO - Elegancia + Impacto */
        .hero-title-hybrid {
            font-family: 'Cormorant', serif;
            font-weight: 600;
            font-size: 4.25rem;
            line-height: 1.1;
            letter-spacing: -0.03em;
            color: #292524;
        }
        
        .hero-subtitle-hybrid {
            font-family: 'Cormorant', serif;
            font-weight: 700;
            display: inline-block;
            background: linear-gradient(135deg, #78716c 0%, #292524 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gradient-text { background: linear-gradient(135deg, #78716c 0%, #57534e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-12px); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in-up {
            opacity: 0;
            animation: fadeInUp 0.7s ease forwards;
        }
        .fade-in-up:nth-child(1) { animation-delay: 0.1s; }
        .fade-in-up:nth-child(2) { animation-delay: 0.25s; }
        .fade-in-up:nth-child(3) { animation-delay: 0.4s; }

        .divider-elegant {
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, #a78bfa, #c084fc);
            margin: 0 auto;
            border-radius: 2px;
        }

        .testimonial-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(120, 113, 108, 0.08);
            position: relative;
        }
        .testimonial-card::before {
            content: '"';
            font-family: 'Cormorant', serif;
            font-size: 5rem;
            line-height: 1;
            color: rgba(167, 139, 250, 0.15);
            position: absolute;
            top: 0.5rem;
            left: 1.5rem;
        }
        
        /* ANIMACI√ìN PING PARA BADGE - NUEVO ‚ú® */
        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        
        .animate-ping {
            animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // SUPABASE ACTIVADO
        const SUPABASE_URL = 'https://pyekwpmbdnmglrjieexc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZWt3cG1iZG5tZ2xyamllZXhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0ODM0OTgsImV4cCI6MjA4MTA1OTQ5OH0.zQl7GF3E6BhDqW3bEMixAbdDcOsW8BsFOBeAGa-5bzY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // LEMON SQUEEZY - Configuraci√≥n
        const LEMON_CONFIG = {
            storeId: '271685',
            variantId: '1230606'
        };
        
        const PRICES = {
            emea: {
                price: '‚Ç¨4.99',
                monthly: '‚Ç¨4.99',
                annual: '‚Ç¨39.99',
                annualOriginal: '‚Ç¨59.88',
                annualSavings: '‚Ç¨20',
                currency: 'EUR',
                monthlyVariantId: '2d480891-baaa-4968-9c7b-9b4a6e2c04db',
                annualVariantId: 'd3ff3973-7f9e-413c-89dc-9255874779d7'
            },
            latam: {
                price: '$5.49',
                monthly: '$5.49',
                annual: '$43.99',
                annualOriginal: '$65.88',
                annualSavings: '$22',
                currency: 'USD',
                monthlyVariantId: '2d480891-baaa-4968-9c7b-9b4a6e2c04db',
                annualVariantId: 'd3ff3973-7f9e-413c-89dc-9255874779d7'
            },
            usa: {
                price: '$5.49',
                monthly: '$5.49',
                annual: '$43.99',
                annualOriginal: '$65.88',
                annualSavings: '$22',
                currency: 'USD',
                monthlyVariantId: '2d480891-baaa-4968-9c7b-9b4a6e2c04db',
                annualVariantId: 'd3ff3973-7f9e-413c-89dc-9255874779d7'
            }
        };

        const LumeraApp = () => {
            const [language, setLanguage] = useState('es');
            const [darkMode, setDarkMode] = useState(false);
            const [session, setSession] = useState(null);
            const [authMode, setAuthMode] = useState('login');
            const [authData, setAuthData] = useState({ email: '', password: '' });
            const [showPasswordReset, setShowPasswordReset] = useState(false);
            const [resetEmail, setResetEmail] = useState('');
            const [showAuth, setShowAuth] = useState(true); // FORZAR TRUE AL INICIO
            const [loading, setLoading] = useState(true);
            const [currentUser, setCurrentUser] = useState(null);
            const [currentPage, setCurrentPage] = useState('home');
            const [showQuiz, setShowQuiz] = useState(false);
            const [quizStep, setQuizStep] = useState(1);
            const [symptoms, setSymptoms] = useState([]);
            const [periodLog, setPeriodLog] = useState([]);
            const [userMessages, setUserMessages] = useState([]);
            const [exerciseGoal, setExerciseGoal] = useState('hormonal');
            const [userRegion, setUserRegion] = useState('latam');
            const [showTutorial, setShowTutorial] = useState(false);
            const [editingProfile, setEditingProfile] = useState(false);
            const [profileEdits, setProfileEdits] = useState({});
            const [showBmiInfo, setShowBmiInfo] = useState(false);
            const [showBmrInfo, setShowBmrInfo] = useState(false);
            const [showTdeeInfo, setShowTdeeInfo] = useState(false);
            
            // CHAT LUMI
            const [showLumiChat, setShowLumiChat] = useState(false);
            const [showEditProfile, setShowEditProfile] = useState(false);
            const [editingWeight, setEditingWeight] = useState('');
            const [editingActivity, setEditingActivity] = useState('moderate');
            const [lumiMessages, setLumiMessages] = useState([]);
            const [lumiInput, setLumiInput] = useState('');
            const [lumiLoading, setLumiLoading] = useState(false);
            const [dailyQuestions, setDailyQuestions] = useState(0);
            const [lastQuestionDate, setLastQuestionDate] = useState(null);
            
            // MODAL PATR√ìN D√çA 3
            const [showPatternModal, setShowPatternModal] = useState(false);
            const [patternResult, setPatternResult] = useState(null);
            const [patternShown, setPatternShown] = useState(false);

            // LUMI PROACTIVA - NUEVO ‚ú®
            const [unreadLumiMessages, setUnreadLumiMessages] = useState(0);
            const [showProactiveModal, setShowProactiveModal] = useState(false);
            const [proactiveMessages, setProactiveMessages] = useState([]);
            const [showPlanModal, setShowPlanModal] = useState(false);

            // TRIAL BANNER
            const [trialDaysRemaining, setTrialDaysRemaining] = useState(3);
            const [showTrialBanner, setShowTrialBanner] = useState(true);
            
            // DASHBOARD PREMIUM - NUEVO
            const [showProfileModal, setShowProfileModal] = useState(false);
            const [editWeight, setEditWeight] = useState('');
            const [editHeight, setEditHeight] = useState('');
            const [editAge, setEditAge] = useState('');
            const [editActivityLevel, setEditActivityLevel] = useState('moderate');
            const [editGoal, setEditGoal] = useState('maintain');
            const [showDashboardModal, setShowDashboardModal] = useState(false);
            const [showWelcomePremium, setShowWelcomePremium] = useState(false);
            const [chartData, setChartData] = useState(null);
            const [aiCookingTips, setAiCookingTips] = useState({}); // {recipeName: [tip1, tip2, tip3]}
            const [loadingTips, setLoadingTips] = useState({}); // {recipeName: true/false}
            const [aiExercises, setAiExercises] = useState(null);
            const [loadingExercises, setLoadingExercises] = useState(false);
            
            // MENUS - Estado global
            const [menus, setMenus] = useState({ es: {}, en: {} });
            const [menusLoading, setMenusLoading] = useState(true);
            
            const [formData, setFormData] = useState({
                profileName: '',
                age: '',
                height: '',
                weight: '',
                activity_level: 'moderate', // sedentary, light, moderate, active, very_active
                conditions: [],
            });

            const [symptomForm, setSymptomForm] = useState({
                sleep: 5,
                energy: 5,
                mood: 5,
                hotFlashes: 0,
                anxiety: 5,
                vaginalDryness: 0,
                brainFog: 0,
                memory: 5,
                date: new Date().toISOString().split('T')[0]
            });

            const [periodForm, setPeriodForm] = useState({
                intensity: 5,
                duration: 5,
                symptoms: '',
                date: new Date().toISOString().split('T')[0]
            });

            const [communityMessage, setCommunityMessage] = useState('');
            const [communityPosts, setCommunityPosts] = useState([]);
            const [loadingPosts, setLoadingPosts] = useState(true);

            // REFS PARA GR√ÅFICOS
            const chartRefSleep = useRef(null);
            const chartRefEnergy = useRef(null);
            const chartRefMood = useRef(null);
            const chartRefHotFlashes = useRef(null);
            const chartRefPeriod = useRef(null);

            const chartsRef = useRef({
                sleep: null,
                energy: null,
                mood: null,
                hotFlashes: null,
                period: null
            });

            const t = {
                es: {
                    app_name: 'Lumera',
                    home: 'Inicio',
                    nutrition: 'Nutrici√≥n',
                    exercise: 'Ejercicio',
                    symptoms: 'S√≠ntomas',
                    period: 'Per√≠odo',
                    myths: 'Mitos',
                    tips: 'Consejos',
                    workshops: 'Talleres',
                    community: 'Comunidad',
                    save: 'Guardar',
                    cancel: 'Cancelar',
                    next: 'Siguiente',
                    exit: 'Salir',
                    ingredients: 'Ingredientes',
                    preparation: 'Preparaci√≥n',
                    why: 'Por qu√©',
                    benefits: 'Beneficios',
                    day: 'D√≠a',
                    breakfast: 'Desayuno',
                    lunch: 'Almuerzo',
                    dinner: 'Cena',
                    snack: 'Snack',
                    personalized: 'Personalizado para ti',
                    download: 'Descargar',
                    addRecord: 'Registrar',
                    strength: 'Ganar Fuerza',
                    weightLoss: 'Perder Peso',
                    hormonal: 'Equilibrio Hormonal'
                },
                en: {
                    app_name: 'Lumera',
                    home: 'Home',
                    nutrition: 'Nutrition',
                    exercise: 'Exercise',
                    symptoms: 'Symptoms',
                    period: 'Period',
                    myths: 'Myths',
                    tips: 'Tips',
                    workshops: 'Workshops',
                    community: 'Community',
                    save: 'Save',
                    cancel: 'Cancel',
                    next: 'Next',
                    exit: 'Exit',
                    ingredients: 'Ingredients',
                    preparation: 'Preparation',
                    why: 'Why',
                    benefits: 'Benefits',
                    day: 'Day',
                    breakfast: 'Breakfast',
                    lunch: 'Lunch',
                    dinner: 'Dinner',
                    snack: 'Snack',
                    personalized: 'Personalized for you',
                    download: 'Download',
                    addRecord: 'Record',
                    strength: 'Build Strength',
                    weightLoss: 'Lose Weight',
                    hormonal: 'Hormonal Balance'
                }
            };

            // CARGAR DATOS
            useEffect(() => {
                // CARGAR SESI√ìN DESDE SUPABASE
                const checkSession = async () => {
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session) {
                        // Cargar perfil del usuario (el m√°s reciente)
                        const { data: profiles } = await supabase
                            .from('users')
                            .select('*')
                            .eq('id', session.user.id)
                            .order('updated_at', { ascending: false })
                            .limit(1);
                        
                        const profile = profiles?.[0];
                        
                        setSession(session);
                        console.log('üìä Perfil cargado:', profile);
                        console.log('üìã Health conditions:', profile?.health_conditions);
                        setCurrentUser(profile || { id: session.user.id, email: session.user.email });
                        setShowAuth(false);
                        
                        // Si no tiene perfil completo, mostrar quiz
                        if (!profile?.profile_name) {
                            setShowQuiz(true);
                        }
                        
                        console.log('‚úÖ Sesi√≥n cargada desde Supabase');
                    } else {
                        setShowAuth(true);
                        setShowQuiz(false);
                    }
                    
                    setLoading(false);
                };
                
                checkSession();
                
                // Listener para cambios de auth
                const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_OUT') {
                        setSession(null);
                        setCurrentUser(null);
                        setShowAuth(true);
                    } else if (event === 'SIGNED_IN' && session) {
                        setSession(session);
                        
                        // Cargar perfil
                        const { data: profile } = await supabase
                            .from('users')
                            .select('*')
                            .eq('id', session.user.id)
                            .single();
                        
                        if (profile) {
                            setCurrentUser(profile);
                            setShowAuth(false);
                            if (!profile.profile_name) {
                                setShowQuiz(true);
                            }
                        } else {
                            // Usuario nueva por Google, crear perfil b√°sico
                            const { data: newProfile } = await supabase
                                .from('users')
                                .insert([{
                                    id: session.user.id,
                                    email: session.user.email,
                                    created_at: new Date().toISOString()
                                }])
                                .select();
                            
                            setCurrentUser(newProfile?.[0] || { id: session.user.id, email: session.user.email });
                            setShowAuth(false);
                            setShowQuiz(true);
                        }
                    }
                });
                
                return () => subscription.unsubscribe();
            }, []);

            // CARGAR POSTS DE COMUNIDAD
            useEffect(() => {
                const loadCommunityPosts = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('community_posts')
                            .select('*')
                            .eq('is_approved', true)
                            .eq('language', language)
                            .order('created_at', { ascending: false })
                            .limit(20);
                        
                        if (error) {
                            console.error('Error loading community posts:', error);
                        } else {
                            setCommunityPosts(data || []);
                        }
                    } catch (err) {
                        console.error('Error:', err);
                    } finally {
                        setLoadingPosts(false);
                    }
                };
                
                if (session) {
                    loadCommunityPosts();
                }
            }, [language, session]);

            // CARGAR MENSAJES PROACTIVOS DE LUMI ‚ú®
            useEffect(() => {
                if (!currentUser) return;

                const todayKey = `lumiGreeted_${currentUser.id}_${new Date().toDateString()}`;
                const alreadyGreetedToday = localStorage.getItem(todayKey);

                // Calcular si es d√≠a 3 de trial
                const trialDaysLeftNow = (() => {
                    if (!currentUser?.created_at) return 99;
                    const created = new Date(currentUser.created_at);
                    const daysPassed = (new Date() - created) / (1000 * 60 * 60 * 24);
                    return Math.max(0, Math.ceil(3 - daysPassed));
                })();
                const isDay3Trial = trialDaysLeftNow <= 1 && currentUser.subscription_status !== 'active';

                // Generar saludo local diario garantizado
                const buildDailyGreeting = () => {
                    const userName = currentUser.profile_name || (language === 'es' ? 'amiga' : 'friend');
                    const hour = new Date().getHours();
                    const greetEs = hour < 12 ? 'Buenos d√≠as' : hour < 19 ? 'Buenas tardes' : 'Buenas noches';
                    const greetEn = hour < 12 ? 'Good morning' : hour < 19 ? 'Good afternoon' : 'Good evening';

                    if (isDay3Trial) {
                        return {
                            id: 'local-day3-' + Date.now(),
                            message_type: 'pattern_insight',
                            message_text: language === 'es'
                                ? `${greetEs} ${userName} üíú Es tu tercer d√≠a con Lumera y ya tengo algo importante para ti. He analizado tus registros y detect√© patrones reales en tus s√≠ntomas. √Åbrelos tocando el coraz√≥n abajo üîç ‚Äî son datos de tu cuerpo, no suposiciones.`
                                : `${greetEn} ${userName} üíú It's your third day with Lumera and I already have something important for you. I've analyzed your records and found real patterns in your symptoms. Open them by tapping the heart below üîç ‚Äî these are real data from your body, not guesses.`,
                            created_at: new Date().toISOString(),
                            read_at: null
                        };
                    }

                    const dayVariants = language === 'es'
                        ? [
                            `${greetEs} ${userName} üíú Estoy aqu√≠ para acompa√±arte hoy. ¬øC√≥mo te encuentras?`,
                            `${greetEs} ${userName} üåø Un nuevo d√≠a para cuidarte. ¬øC√≥mo dormiste anoche?`,
                            `${greetEs} ${userName} ‚ú® Me alegra verte. ¬øQuieres registrar c√≥mo te sientes hoy?`,
                            `${greetEs} ${userName} üíú Recuerda: peque√±os pasos cada d√≠a marcan la diferencia. ¬øC√≥mo est√°s hoy?`,
                            `${greetEs} ${userName} üå∏ Tu cuerpo hace algo incre√≠ble cada d√≠a. ¬øC√≥mo te sientes esta ma√±ana?`,
                        ]
                        : [
                            `${greetEn} ${userName} üíú I'm here for you today. How are you feeling?`,
                            `${greetEn} ${userName} üåø A new day to take care of yourself. How did you sleep last night?`,
                            `${greetEn} ${userName} ‚ú® Good to see you. Would you like to log how you're feeling today?`,
                            `${greetEn} ${userName} üíú Remember: small steps every day make a big difference. How are you today?`,
                            `${greetEn} ${userName} üå∏ Your body does something incredible every day. How are you feeling this morning?`,
                        ];

                    const dayOfWeek = new Date().getDay();
                    return {
                        id: 'local-greeting-' + Date.now(),
                        message_type: 'greeting',
                        message_text: dayVariants[dayOfWeek % dayVariants.length],
                        created_at: new Date().toISOString(),
                        read_at: null
                    };
                };

                const loadProactiveMessages = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('lumi_proactive_messages')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .is('read_at', null)
                            .order('created_at', { ascending: false });

                        if (!error && data && data.length > 0) {
                            // Hay mensajes reales sin leer en BD ‚Üí mostrarlos
                            setProactiveMessages(data);
                            setUnreadLumiMessages(data.length);
                            const timer = setTimeout(() => setShowProactiveModal(true), 2000);
                            return () => clearTimeout(timer);
                        }

                        // Sin mensajes en BD ‚Üí saludo diario local
                        // Solo mostrar popup si no salud√≥ hoy todav√≠a
                        const greeting = buildDailyGreeting();
                        setProactiveMessages([greeting]);
                        setUnreadLumiMessages(1);

                        if (!alreadyGreetedToday) {
                            localStorage.setItem(todayKey, '1');
                            const timer = setTimeout(() => setShowProactiveModal(true), 2000);
                            return () => clearTimeout(timer);
                        }
                        // Ya salud√≥ hoy ‚Üí badge visible pero sin popup autom√°tico
                    } catch (err) {
                        console.error('Error LUMI proactive:', err);
                        // Fallback: saludo diario aunque falle Supabase
                        const greeting = buildDailyGreeting();
                        setProactiveMessages([greeting]);
                        setUnreadLumiMessages(1);
                        if (!alreadyGreetedToday) {
                            localStorage.setItem(todayKey, '1');
                            const timer = setTimeout(() => setShowProactiveModal(true), 2000);
                            return () => clearTimeout(timer);
                        }
                    }
                };

                loadProactiveMessages();

                // Recargar cada 5 minutos para detectar mensajes nuevos de BD
                const interval = setInterval(loadProactiveMessages, 5 * 60 * 1000);
                return () => clearInterval(interval);
            }, [currentUser]);

            // CARGAR S√çNTOMAS DESDE SUPABASE - CR√çTICO ‚ú®
            useEffect(() => {
                if (!currentUser) return;
                
                const loadSymptoms = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('symptoms')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .order('symptom_date', { ascending: false })
                            .limit(30);
                        
                        if (error) {
                            console.error('Error cargando s√≠ntomas:', error);
                            return;
                        }
                        
                        if (data && data.length > 0) {
                            setSymptoms(data);
                            console.log('‚úÖ S√≠ntomas cargados:', data.length);
                        }
                    } catch (err) {
                        console.error('Error:', err);
                    }
                };
                
                loadSymptoms();
            }, [currentUser]);

            // GUARDAR PREFERENCIAS LOCALMENTE
            useEffect(() => {
                localStorage.setItem('lumeraDark', JSON.stringify(darkMode));
                localStorage.setItem('lumeraLang', language);
                localStorage.setItem('lumeraSymptoms', JSON.stringify(symptoms));
                localStorage.setItem('lumeraPeriod', JSON.stringify(periodLog));
                localStorage.setItem('lumeraMessages', JSON.stringify(userMessages));
            }, [darkMode, language, symptoms, periodLog, userMessages]);

            // CALCULAR D√çAS RESTANTES DE TRIAL
            useEffect(() => {
                if (!currentUser) return;
                
                // Calcular d√≠as de trial restantes
                const trialStartDate = new Date(currentUser.created_at);
                const today = new Date();
                const daysSinceStart = Math.floor((today - trialStartDate) / (1000 * 60 * 60 * 24));
                const daysLeft = Math.max(0, 3 - daysSinceStart);
                
                setTrialDaysRemaining(daysLeft);
                
                // Mostrar banner solo si no es premium
                setShowTrialBanner(currentUser.subscription_status !== 'active');
            }, [currentUser]);


            // GR√ÅFICOS DE S√çNTOMAS
            useEffect(() => {
                if (symptoms.length === 0) return;

                const labels = symptoms.map(s => {
                    const d = new Date(s.symptom_date || s.date);
                    return d.toLocaleDateString(language === 'es' ? 'es-ES' : 'en-US', { month: 'short', day: 'numeric' });
                }).slice(-14);
                const sleepData = symptoms.map(s => s.sleep || 0).slice(-14);
                const energyData = symptoms.map(s => s.energy || 0).slice(-14);
                const moodData = symptoms.map(s => s.mood || 0).slice(-14);
                const hotFlashesData = symptoms.map(s => s.hot_flashes || s.hotFlashes || 0).slice(-14);

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: true, max: 10 } }
                };

                setTimeout(() => {
                    if (chartRefSleep.current && window.Chart) {
                        if (chartsRef.current.sleep) chartsRef.current.sleep.destroy();
                        chartsRef.current.sleep = new window.Chart(chartRefSleep.current, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{ label: language === 'es' ? 'Sue√±o' : 'Sleep', data: sleepData, borderColor: '#9333ea', backgroundColor: 'rgba(147,51,234,0.1)', borderWidth: 2, fill: true, tension: 0.4 }]
                            },
                            options: chartOptions
                        });
                    }

                    if (chartRefEnergy.current && window.Chart) {
                        if (chartsRef.current.energy) chartsRef.current.energy.destroy();
                        chartsRef.current.energy = new window.Chart(chartRefEnergy.current, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{ label: language === 'es' ? 'Energ√≠a' : 'Energy', data: energyData, borderColor: '#ec4899', backgroundColor: 'rgba(236,72,153,0.1)', borderWidth: 2, fill: true, tension: 0.4 }]
                            },
                            options: chartOptions
                        });
                    }

                    if (chartRefMood.current && window.Chart) {
                        if (chartsRef.current.mood) chartsRef.current.mood.destroy();
                        chartsRef.current.mood = new window.Chart(chartRefMood.current, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{ label: language === 'es' ? '√Ånimo' : 'Mood', data: moodData, borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.1)', borderWidth: 2, fill: true, tension: 0.4 }]
                            },
                            options: chartOptions
                        });
                    }

                    if (chartRefHotFlashes.current && window.Chart) {
                        if (chartsRef.current.hotFlashes) chartsRef.current.hotFlashes.destroy();
                        chartsRef.current.hotFlashes = new window.Chart(chartRefHotFlashes.current, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{ label: language === 'es' ? 'Sofocos' : 'Hot Flashes', data: hotFlashesData, backgroundColor: '#f97316', borderColor: '#ea580c', borderWidth: 1 }]
                            },
                            options: chartOptions
                        });
                    }
                }, 100);
            }, [symptoms, language]);

            // GR√ÅFICOS DE PER√çODO
            useEffect(() => {
                if (periodLog.length === 0) return;

                const labels = periodLog.map(p => p.date).slice(-12);
                const intensityData = periodLog.map(p => p.intensity).slice(-12);
                const durationData = periodLog.map(p => p.duration).slice(-12);

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: true } }
                };

                setTimeout(() => {
                    if (chartRefPeriod.current && window.Chart) {
                        if (chartsRef.current.period) chartsRef.current.period.destroy();
                        chartsRef.current.period = new window.Chart(chartRefPeriod.current, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    { label: language === 'es' ? 'Intensidad' : 'Intensity', data: intensityData, backgroundColor: '#ec4899', borderColor: '#be185d', borderWidth: 1 },
                                    { label: language === 'es' ? 'Duraci√≥n (d√≠as)' : 'Duration (days)', data: durationData, backgroundColor: '#f97316', borderColor: '#c2410c', borderWidth: 1 }
                                ]
                            },
                            options: chartOptions
                        });
                    }
                }, 100);
            }, [periodLog, language]);

            // SISTEMA DE FILTRO DE INTOLERANCIAS Y SUSTITUCIONES
            const applyDietaryRestrictions = (ingredient, userConditions) => {
                console.log('üîç FILTRO:', { ingredient: ingredient.name, userConditions });
                if (!userConditions || userConditions.length === 0) {
                    console.log('‚ö†Ô∏è No hay condiciones, devolviendo ingrediente sin cambios');
                    return ingredient;
                }
                
                // NORMALIZAR condiciones a espa√±ol (funciona con ambos idiomas)
                // FIX: Hacer case-insensitive con toLowerCase()
                const normalizeCondition = (cond) => {
                    const condLower = cond.toLowerCase().trim();
                    const mapping = {
                        'lactose-free': 'sin lactosa',
                        'gluten-free': 'sin gluten',
                        'vegetarian': 'vegetariana',
                        'vegan': 'vegana',
                        'hypertension': 'hipertensi√≥n',
                        'hipertensi√≥n': 'hipertensi√≥n',
                        'arthritis': 'artritis',
                        'anxiety': 'ansiedad',
                        'diabetes': 'diabetes'
                    };
                    return mapping[condLower] || condLower;
                };
                
                const normalizedConditions = userConditions.map(normalizeCondition);
                console.log('üìã Condiciones normalizadas:', normalizedConditions);
                
                let modifiedIng = { ...ingredient };
                
                const restrictions = {
                    'sin lactosa': {
                        prohibited: ['leche', 'milk', 'yogur', 'yogurt', 'queso', 'cheese', 'nata', 'cream', 'mantequilla', 'butter'],
                        substitute: (ing) => {
                            const nameLower = ing.name.toLowerCase();
                            
                            if (nameLower.includes('leche') || nameLower.includes('milk')) {
                                return { 
                                    ...ing, 
                                    name: language === 'es' ? 'Leche sin lactosa' : 'Lactose-free milk',
                                    why: ing.why + (language === 'es' ? ' ‚ú® Versi√≥n sin lactosa para tu digesti√≥n.' : ' ‚ú® Lactose-free version for your digestion.')
                                };
                            }
                            if (nameLower.includes('yogur') || nameLower.includes('yogurt')) {
                                return { 
                                    ...ing, 
                                    name: language === 'es' ? 'Yogur sin lactosa' : 'Lactose-free yogurt',
                                    why: ing.why + (language === 'es' ? ' ‚ú® Versi√≥n sin lactosa.' : ' ‚ú® Lactose-free version.')
                                };
                            }
                            if (nameLower.includes('queso') || nameLower.includes('cheese')) {
                                return { 
                                    ...ing, 
                                    name: language === 'es' ? 'Queso sin lactosa' : 'Lactose-free cheese',
                                    why: ing.why + (language === 'es' ? ' ‚ú® Disponible sin lactosa.' : ' ‚ú® Available lactose-free.')
                                };
                            }
                            if (nameLower.includes('mantequilla') || nameLower.includes('butter')) {
                                return { 
                                    ...ing, 
                                    name: language === 'es' ? 'Aceite de oliva' : 'Olive oil',
                                    qty: Math.ceil(ing.qty * 0.8),
                                    unit: 'ml',
                                    why: language === 'es' ? 'Grasa saludable sin lactosa.' : 'Healthy fat without lactose.'
                                };
                            }
                            return null;
                        }
                    },
                    'sin gluten': {
                        prohibited: ['avena', 'oats', 'pan', 'bread', 'pasta', 'harina', 'flour'],
                        substitute: (ing) => {
                            const nameLower = ing.name.toLowerCase();
                            
                            if (nameLower.includes('avena') || nameLower.includes('oats')) {
                                return { ...ing, name: language === 'es' ? 'Avena certificada sin gluten' : 'Certified gluten-free oats', why: ing.why + (language === 'es' ? ' ‚ú® Certificada libre de gluten.' : ' ‚ú® Certified gluten-free.') };
                            }
                            if (nameLower.includes('pan') || nameLower.includes('bread')) {
                                return { ...ing, name: language === 'es' ? 'Pan sin gluten' : 'Gluten-free bread', why: ing.why + (language === 'es' ? ' ‚ú® Versi√≥n sin gluten.' : ' ‚ú® Gluten-free version.') };
                            }
                            if (nameLower.includes('pasta')) {
                                return { ...ing, name: language === 'es' ? 'Pasta de arroz' : 'Rice pasta', why: language === 'es' ? 'Alternativa sin gluten con misma energ√≠a.' : 'Gluten-free alternative with same energy.' };
                            }
                            if (nameLower.includes('harina') || nameLower.includes('flour')) {
                                return { ...ing, name: language === 'es' ? 'Harina sin gluten' : 'Gluten-free flour', why: language === 'es' ? 'Mezcla sin gluten certificada.' : 'Certified gluten-free mix.' };
                            }
                            return { ...ing, name: language === 'es' ? 'Arroz integral' : 'Brown rice', why: language === 'es' ? 'Alternativa sin gluten segura.' : 'Safe gluten-free alternative.' };
                        }
                    },
                    'vegetariana': {
                        prohibited: ['pescado', 'fish', 'carne', 'meat', 'pollo', 'chicken', 'pavo', 'turkey', 'at√∫n', 'tuna', 'salm√≥n', 'salmon'],
                        substitute: (ing) => {
                            const nameLower = ing.name.toLowerCase();
                            
                            if (nameLower.includes('pescado') || nameLower.includes('fish') || nameLower.includes('salm√≥n') || nameLower.includes('salmon') || nameLower.includes('at√∫n') || nameLower.includes('tuna')) {
                                return { ...ing, name: language === 'es' ? 'Tofu firme' : 'Firm tofu', qty: Math.ceil(ing.qty * 1.2), unit: 'g', why: language === 'es' ? 'Prote√≠na vegetal completa que absorbe sabores.' : 'Complete plant protein that absorbs flavors.' };
                            }
                            return { ...ing, name: language === 'es' ? 'Lentejas cocidas' : 'Cooked lentils', qty: Math.ceil(ing.qty * 0.8), unit: 'g', why: language === 'es' ? 'Prote√≠na vegetal completa. M√°s econ√≥mica y nutritiva.' : 'Complete plant protein. More economical and nutritious.' };
                        }
                    },
                    'vegana': {
                        prohibited: ['pescado', 'fish', 'carne', 'meat', 'pollo', 'chicken', 'huevo', 'egg', 'leche', 'milk', 'yogur', 'yogurt', 'queso', 'cheese', 'miel', 'honey'],
                        substitute: (ing) => {
                            const nameLower = ing.name.toLowerCase();
                            
                            if (nameLower.includes('huevo') || nameLower.includes('egg')) {
                                return { ...ing, name: language === 'es' ? 'Tofu revuelto' : 'Scrambled tofu', qty: Math.ceil(ing.qty * 2.5), unit: 'g', why: language === 'es' ? 'Prote√≠na vegetal vers√°til. Misma textura.' : 'Versatile plant protein. Same texture.' };
                            }
                            if (nameLower.includes('leche') || nameLower.includes('milk')) {
                                return { ...ing, name: language === 'es' ? 'Leche de soja fortificada' : 'Fortified soy milk', why: language === 'es' ? 'Opci√≥n vegetal m√°s econ√≥mica y proteica.' : 'Most economical and protein-rich plant option.' };
                            }
                            if (nameLower.includes('yogur') || nameLower.includes('yogurt')) {
                                return { ...ing, name: language === 'es' ? 'Yogur de soja' : 'Soy yogurt', why: language === 'es' ? 'Alternativa vegetal con probi√≥ticos.' : 'Plant alternative with probiotics.' };
                            }
                            if (nameLower.includes('queso') || nameLower.includes('cheese')) {
                                return { ...ing, name: language === 'es' ? 'Levadura nutricional' : 'Nutritional yeast', qty: Math.ceil(ing.qty * 0.3), unit: 'g', why: language === 'es' ? 'Sabor a queso + B12. Perfecto.' : 'Cheesy flavor + B12. Perfect.' };
                            }
                            if (nameLower.includes('pescado') || nameLower.includes('fish')) {
                                return { ...ing, name: language === 'es' ? 'Tempeh marinado' : 'Marinated tempeh', qty: Math.ceil(ing.qty * 0.9), unit: 'g', why: language === 'es' ? 'Prote√≠na fermentada con omega-3.' : 'Fermented protein with omega-3.' };
                            }
                            if (nameLower.includes('carne') || nameLower.includes('meat') || nameLower.includes('pollo') || nameLower.includes('chicken')) {
                                return { ...ing, name: language === 'es' ? 'Garbanzos cocidos' : 'Cooked chickpeas', qty: Math.ceil(ing.qty * 0.7), unit: 'g', why: language === 'es' ? 'Prote√≠na vegetal econ√≥mica y completa.' : 'Economical and complete plant protein.' };
                            }
                            if (nameLower.includes('miel') || nameLower.includes('honey')) {
                                return { ...ing, name: language === 'es' ? 'Sirope de arce' : 'Maple syrup', why: language === 'es' ? 'Dulzor natural vegano.' : 'Natural vegan sweetness.' };
                            }
                            return null;
                        }
                    },
                    'diabetes': {
                        prohibited: [],
                        modify: (ing) => {
                            const nameLower = ing.name.toLowerCase();
                            
                            // Eliminar az√∫cares a√±adidos
                            if (nameLower.includes('miel') || nameLower.includes('honey') || nameLower.includes('az√∫car') || nameLower.includes('sugar') || nameLower.includes('sirope') || nameLower.includes('syrup')) {
                                return null;
                            }
                            
                            // Convertir carbohidratos refinados a integrales
                            if (nameLower.includes('arroz blanco') || nameLower.includes('white rice')) {
                                return { ...ing, name: language === 'es' ? 'Arroz integral' : 'Brown rice', qty: Math.ceil(ing.qty * 0.7), why: language === 'es' ? 'Menor √≠ndice gluc√©mico. Mejor para diabetes.' : 'Lower glycemic index. Better for diabetes.' };
                            }
                            if (nameLower.includes('pan blanco') || nameLower.includes('white bread')) {
                                return { ...ing, name: language === 'es' ? 'Pan integral' : 'Whole wheat bread', qty: Math.ceil(ing.qty * 0.7), why: language === 'es' ? 'Integral = menos picos de az√∫car.' : 'Whole grain = fewer sugar spikes.' };
                            }
                            
                            return ing;
                        }
                    }
                };
                
                // Aplicar restricciones
                for (const condition of normalizedConditions) {
                    console.log('üîé Revisando condici√≥n:', condition);
                    const restriction = restrictions[condition];
                    if (!restriction) {
                        console.log('‚ö†Ô∏è No hay restricci√≥n definida para:', condition);
                        continue;
                    }
                    
                    // Proteger contra modifiedIng null o sin name
                    if (!modifiedIng || !modifiedIng.name) continue;

                    // Verificar si ingrediente est√° prohibido
                    const ingNameLower = modifiedIng.name.toLowerCase();
                    const isProhibited = restriction.prohibited && restriction.prohibited.some(p => ingNameLower.includes(p));
                    
                    console.log('üîç Ingrediente:', ingNameLower, '| Prohibido:', isProhibited);
                    
                    if (isProhibited) {
                        console.log('üö´ PROHIBIDO! Aplicando sustituci√≥n...');
                        if (restriction.substitute) {
                            const substituted = restriction.substitute(modifiedIng);
                            if (substituted) {
                                console.log('‚úÖ Sustituido por:', substituted.name);
                                return substituted;
                            }
                        }
                        return null; // Eliminar si no tiene sustituto
                    }
                    
                    // Aplicar modificaciones (como diabetes)
                    if (restriction.modify) {
                        const modified = restriction.modify(modifiedIng);
                        if (!modified) return null;
                        modifiedIng = modified;
                    }
                }
                
                return modifiedIng;
            };

            // CACHE DE TRADUCCIONES (para no consultar DB cada vez)
            let ingredientTranslationsCache = null;

            // CARGAR TRADUCCIONES DE INGREDIENTES
            const loadIngredientTranslations = async () => {
                if (ingredientTranslationsCache) return ingredientTranslationsCache;
                
                try {
                    const { data, error } = await supabase
                        .from('ingredient_translations')
                        .select('*');
                    
                    if (error) {
                        console.error('‚ùå Error cargando traducciones:', error);
                        return {};
                    }
                    
                    // Convertir array a objeto para b√∫squeda r√°pida
                    const translations = {};
                    data.forEach(item => {
                        translations[item.standard.toLowerCase()] = {
                            latam: item.latam,
                            emea: item.emea,
                            usa: item.usa
                        };
                    });
                    
                    ingredientTranslationsCache = translations;
                    console.log('‚úÖ Traducciones cargadas:', Object.keys(translations).length);
                    return translations;
                } catch (err) {
                    console.error('‚ùå Error:', err);
                    return {};
                }
            };

            // TRADUCIR INGREDIENTE SEG√öN REGI√ìN
            const translateIngredient = async (ingredientName, region) => {
                if (!ingredientName) return ingredientName;
                
                const translations = await loadIngredientTranslations();
                const regionKey = region?.toLowerCase() || 'latam';
                
                // Normalizar nombre del ingrediente (quitar acentos, min√∫sculas)
                const normalized = ingredientName.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                
                // Buscar traducci√≥n
                for (const [standard, trans] of Object.entries(translations)) {
                    const standardNorm = standard.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    
                    // Si el ingrediente contiene el t√©rmino est√°ndar
                    if (normalized.includes(standardNorm) || standardNorm.includes(normalized)) {
                        const translated = trans[regionKey] || trans.latam || ingredientName;
                        
                        // Reemplazar solo la palabra espec√≠fica
                        return ingredientName.toLowerCase().replace(
                            new RegExp(standard, 'gi'),
                            translated
                        );
                    }
                }
                
                return ingredientName; // Si no hay traducci√≥n, devolver original
            };

            // TRADUCIR TODOS LOS INGREDIENTES DE UNA RECETA
            const translateRecipeIngredients = async (recipe, region) => {
                if (!recipe || !recipe.ingredients) return recipe;
                
                const translatedIngredients = await Promise.all(
                    recipe.ingredients.map(async (ing) => {
                        // Si es string (formato Supabase: "Salm√≥n 180g")
                        if (typeof ing === 'string') {
                            // Parsear: "Salm√≥n 180g" ‚Üí {ingredient: "Salm√≥n", qty: 180, unit: "g"}
                            const match = ing.match(/^(.+?)\s+(\d+(?:\.\d+)?)(g|ml|kg|l|ud|cdta|cda|pizca|ramitas?|dientes?)$/i);
                            if (match) {
                                const [, name, qty, unit] = match;
                                const translatedName = await translateIngredient(name.trim(), region);
                                return {
                                    ingredient: translatedName,
                                    name: translatedName,
                                    qty: parseFloat(qty),
                                    unit: unit
                                };
                            } else {
                                // Si no hay cantidad (ej: "Sal al gusto")
                                const translatedName = await translateIngredient(ing, region);
                                return {
                                    ingredient: translatedName,
                                    name: translatedName
                                };
                            }
                        }
                        
                        // Si ya es objeto
                        const translatedName = await translateIngredient(ing.ingredient || ing.name, region);
                        return {
                            ...ing,
                            ingredient: translatedName,
                            name: translatedName
                        };
                    })
                );
                
                return {
                    ...recipe,
                    ingredients: translatedIngredients
                };
            };

            // AJUSTAR CALOR√çAS SEG√öN TDEE DEL USUARIO
            const adjustCaloriesForUser = (recipe, userTDEE) => {
                // Permitir ajuste en trial y premium
                if (!userTDEE) return recipe;
                
                // Calcular factor de ajuste (target: 25-30% del TDEE por comida principal)
                const targetMealCalories = {
                    'Desayuno': userTDEE * 0.25,
                    'Almuerzo': userTDEE * 0.35,
                    'Cena': userTDEE * 0.30,
                    'Snack': userTDEE * 0.10
                };
                
                const target = targetMealCalories[recipe.meal] || recipe.calories;
                const factor = target / recipe.calories;
                
                // Ajustar cantidades de ingredientes
                const adjustedIngredients = recipe.ingredients.map(ing => ({
                    ...ing,
                    qty: ing.qty ? Math.round(ing.qty * factor * 10) / 10 : ing.qty // Redondear a 1 decimal si existe qty
                }));
                
                return {
                    ...recipe,
                    calories: Math.round(target),
                    ingredients: adjustedIngredients,
                    personalized: true
                };
            };

            // MEN√öS 7 D√çAS
            const getWeekMenus = async () => {
                try {
                    // Obtener regi√≥n del usuario
                    const userLang = language;
                    const region = (currentUser?.region || userRegion || 'LATAM').toLowerCase();
                    
                    console.log('üó∫Ô∏è getWeekMenus ‚Üí region:', region, '| currentUser.region:', currentUser?.region, '| userRegion state:', userRegion);
                    
                    // Cargar traducciones primero
                    await loadIngredientTranslations();
                    
                    // Consultar Supabase
                    let query = supabase
                        .from('menus')
                        .select('*')
                        .eq('locale', userLang);
                    
                  // Filtrar por regi√≥n para ambos idiomas
query = query.eq('region', region.toUpperCase()); 
                    
                    const { data: recipes, error } = await query;
                    
                    if (error) {
                        console.error('‚ùå Error:', error);
                        return getFallbackMenus();
                    }
                    
                    if (!recipes || recipes.length === 0) {
                        console.warn('‚ö†Ô∏è Sin men√∫s para', userLang, 'region:', region);
                        return getFallbackMenus();
                    }
                    
                    console.log(`‚úÖ ${recipes.length} men√∫s cargados para idioma ${userLang}, traduciendo ingredientes para regi√≥n ${region}...`);
                    
                    // Traducir ingredientes de cada receta
                    const translatedRecipes = await Promise.all(
                        recipes.map(async (recipe) => {
                            // Traducir y parsear cada ingrediente
                            const translatedIngredients = await Promise.all(
                                (recipe.ingredients || []).map(async (ing) => {
                                    // Si es string (formato Supabase: "Salm√≥n 180g")
                                    if (typeof ing === 'string') {
                                        // Parsear: "Salm√≥n 180g" ‚Üí {ingredient: "Salm√≥n", qty: 180, unit: "g"}
                                        const match = ing.match(/^(.+?)\s+(\d+(?:\.\d+)?)(g|ml|kg|l|ud|cdta|cda|pizca|ramitas?|dientes?)$/i);
                                        if (match) {
                                            const [, name, qty, unit] = match;
                                            const translatedName = await translateIngredient(name.trim(), region);
                                            return {
                                                ingredient: translatedName,
                                                name: translatedName,
                                                qty: parseFloat(qty),
                                                unit: unit
                                            };
                                        } else {
                                            // Si no hay cantidad (ej: "Sal al gusto")
                                            const translatedName = await translateIngredient(ing, region);
                                            return {
                                                ingredient: translatedName,
                                                name: translatedName
                                            };
                                        }
                                    }
                                    
                                    // Si ya es objeto
                                    const translatedName = await translateIngredient(ing.ingredient || ing.name, region);
                                    return {
                                        ...ing,
                                        ingredient: translatedName,
                                        name: translatedName
                                    };
                                })
                            );
                            
                            return {
                                ...recipe,
                                ingredients: translatedIngredients
                            };
                        })
                    );
                    
                    console.log(`‚úÖ Ingredientes traducidos para regi√≥n ${region}`);
                    
                    // Organizar por S√çNTOMA (no por d√≠a)
                    const menusBySymptom = {};
                    translatedRecipes.forEach(recipe => {
                        const symptom = recipe.symptom || 'general';
                        if (!menusBySymptom[symptom]) menusBySymptom[symptom] = [];
                        menusBySymptom[symptom].push({
                            name: recipe.name,
                            meal: recipe.meal_type,
                            calories: recipe.calories,
                            protein: recipe.protein,
                            carbs: recipe.carbs,
                            fats: recipe.fats,
                            ingredients: recipe.ingredients,
                            steps: recipe.steps,
                            why: recipe.why,
                            hormonalBenefit: recipe.hormonal_benefit,
                            keyNutrients: recipe.key_nutrients || [],
                            cookingTips: recipe.cooking_tips,
                            nutrientTips: recipe.nutrient_tips || [],
                            menuFocus: recipe.menu_focus,
                            horario: recipe.recommended_time || recipe.horario,
                            whyHorario: recipe.time_reason || recipe.why_horario
                        });
                    });
                    
                    // Log para debug
                    console.log('üìä Men√∫s por s√≠ntoma:', Object.keys(menusBySymptom).join(', '));
                    
                    // Ordenar por tipo de comida (garantizar orden correcto)
                    const mealOrder = {
                        'desayuno': 1,
                        'breakfast': 1,
                        'almuerzo': 2,
                        'lunch': 2,
                        'snack': 3,
                        'cena': 4,
                        'dinner': 4
                    };
                    
                    Object.keys(menusBySymptom).forEach(symptom => {
                        menusBySymptom[symptom].sort((a, b) => {
                            const orderA = mealOrder[a.meal?.toLowerCase()] || 999;
                            const orderB = mealOrder[b.meal?.toLowerCase()] || 999;
                            return orderA - orderB;
                        });
                    });
                    
                    return { [userLang]: menusBySymptom };
                } catch (error) {
                    console.error('‚ùå Error:', error);
                    return getFallbackMenus();
                }
            };

            const getFallbackMenus = () => {
                const baseMenus = {
                    es: {
                        lunes: [
                            { 
                                name: 'Bowl de Avena que Te Cuida', 
                                meal: 'Desayuno',
                                horario: '7:00-9:00 AM',
                                whyHorario: 'Tu cortisol est√° alto naturalmente al despertar. Carbohidratos complejos en este momento estabilizan tu energ√≠a para todo el d√≠a sin picos de insulina.',
                                calories: 420, 
                                time: '12 min', 
                                ingredients: [
                                    { name: 'Avena integral', qty: 50, unit: 'g', why: 'Te mantendr√° llena hasta el almuerzo sin picos de az√∫car que te dejen sin energ√≠a a media ma√±ana.', region: { latam: 'Avena', emea: 'Avena', usa: 'Oats' }, eco: 'Cualquier marca', gourmet: 'Avena org√°nica' }, 
                                    { name: 'Leche fortificada', qty: 200, unit: 'ml', why: 'Tus huesos necesitan calcio extra ahora. Esta leche te da justo lo que piden.', region: { latam: 'Leche', emea: 'Leche', usa: 'Milk' }, eco: 'Leche de vaca', gourmet: 'Leche de almendras fortificada' }, 
                                    { name: 'Semillas de ch√≠a', qty: 15, unit: 'g', why: 'Tienen un tipo de grasa que ayuda a calmar los sofocos. Muchas mujeres notan la diferencia en d√≠as.', region: { latam: 'Ch√≠a', emea: 'Semillas de ch√≠a', usa: 'Chia seeds' }, eco: 'Semillas de lino molidas', gourmet: 'Ch√≠a org√°nica' },
                                    { name: 'Frutos rojos', qty: 80, unit: 'g', why: 'Protegen tu cerebro cuando sientes esa niebla mental. Son como un escudo para tu claridad.', region: { latam: 'Frutillas o moras', emea: 'Ar√°ndanos', usa: 'Blueberries' }, eco: 'Congelados (mismos nutrientes)', gourmet: 'Frescos org√°nicos' },
                                    { name: 'Frutos secos', qty: 10, unit: 'g', why: 'Te ayudan a dormir mejor por la noche. Tienen algo que tu cuerpo convierte en calma.', region: { latam: 'Man√≠ o nueces', emea: 'Almendras', usa: 'Almonds or walnuts' }, eco: 'Cacahuetes', gourmet: 'Almendras crudas' }
                                ], 
                                steps: ['Calienta la leche 2 minutos', 'Echa la avena y remueve mientras cocina 8 minutos', 'A√±ade las semillas los √∫ltimos 2 minutos', 'Sirve y decora con los frutos rojos y los frutos secos por encima'], 
                                why: 'Este desayuno te da energ√≠a constante toda la ma√±ana. El magnesio de las semillas te ayudar√° con los sofocos, y las grasas buenas calman la inflamaci√≥n que sientes en las articulaciones.'
                            },
                            { 
                                name: 'Pescado con Todo lo que Necesitas', 
                                meal: 'Almuerzo',
                                horario: '12:00-2:00 PM', 
                                whyHorario: 'Tu digesti√≥n est√° en su pico. Prote√≠na y grasas buenas ahora se absorben mejor y mantienen tu energ√≠a estable toda la tarde.',
                                calories: 540, 
                                time: '25 min', 
                                ingredients: [
                                    { name: 'Pescado graso', qty: 150, unit: 'g', why: 'Este pescado tiene las grasas que tu cuerpo dej√≥ de producir. Calman dolores y te dan claridad mental.', region: { latam: 'Jurel o at√∫n', emea: 'Sardinas o caballa', usa: 'Salmon or sardines' }, eco: 'Sardinas en lata (mismos beneficios)', gourmet: 'Salm√≥n fresco' }, 
                                    { name: 'Quinoa o arroz', qty: 120, unit: 'g', why: 'Prote√≠na completa que mantiene tus m√∫sculos fuertes. Ahora los pierdes m√°s r√°pido y esto lo frena.', region: { latam: 'Quinoa (barata all√≠)', emea: 'Quinoa', usa: 'Quinoa' }, eco: 'Arroz integral', gourmet: 'Quinoa tricolor' },
                                    { name: 'Espinacas', qty: 100, unit: 'g', why: 'Hierro para cuando tus reglas se vuelven locas. Y vitamina K para tus huesos.', region: { latam: 'Acelga o espinaca', emea: 'Espinacas', usa: 'Spinach' }, eco: 'Espinacas congeladas', gourmet: 'Baby spinach fresca' },
                                    { name: 'Aguacate', qty: 50, unit: 'g', why: 'Grasa buena que ayuda a absorber todo lo nutritivo del plato. Un lubricante para tu cuerpo.', region: { latam: 'Palta (abundante)', emea: 'Aguacate', usa: 'Avocado' }, eco: 'Aceite de oliva (1 cda)', gourmet: 'Aguacate Hass' },
                                    { name: 'Lim√≥n', qty: 0.5, unit: 'ud', why: 'Multiplica por 3 el hierro que absorbes. Un truco simple que funciona.', region: { latam: 'Lim√≥n', emea: 'Lim√≥n', usa: 'Lemon' }, eco: 'Siempre asequible', gourmet: 'Limones org√°nicos' }
                                ], 
                                steps: ['Pon a cocer la quinoa o el arroz (tarda 15 minutos)', 'Mientras, haz el pescado a la plancha 6-8 minutos por lado (o calienta las sardinas si son de lata)', 'Saltea las espinacas 3 minutos con un poco de ajo si quieres', 'Mezcla todo en el plato, a√±ade el aguacate en trozos o el aceite, y exprime el lim√≥n por encima'], 
                                why: 'Este plato tiene TODO lo que tu cuerpo pide ahora: grasas que calman, prote√≠na que fortalece, hierro que energiza. Es como darle a tu cuerpo exactamente lo que necesita para sentirse bien.'
                            },
                            { 
                                name: 'Lentejas que Te Abrazan', 
                                meal: 'Cena',
                                horario: '7:00-8:30 PM',
                                whyHorario: '2-3 horas antes de dormir. Tu cuerpo necesita tiempo para digerir. Prote√≠na vegetal ligera prepara tu sue√±o sin pesadez.',
                                calories: 410, 
                                time: '35 min', 
                                ingredients: [
                                    { name: 'Lentejas', qty: 150, unit: 'g', why: 'Tienen algo que tu cerebro convierte en la hormona del sue√±o. Cena esto y dormir√°s mejor.', region: { latam: 'Lentejas', emea: 'Lentejas', usa: 'Lentils' }, eco: 'Lentejas secas (muy baratas)', gourmet: 'Lentejas rojas (m√°s r√°pidas)' }, 
                                    { name: 'Zanahoria', qty: 100, unit: 'g', why: 'Vitamina A para tu piel y mucosas que est√°n m√°s secas ahora. Las hidrata desde dentro.', region: { latam: 'Zanahoria', emea: 'Zanahoria', usa: 'Carrots' }, eco: 'Siempre asequible', gourmet: 'Zanahorias baby' },
                                    { name: 'Pimiento', qty: 80, unit: 'g', why: 'Vitamina C a tope. Ayuda a que tu cuerpo aproveche todo el hierro de las lentejas.', region: { latam: 'Aj√≠ morr√≥n', emea: 'Pimiento rojo', usa: 'Bell pepper' }, eco: 'De temporada', gourmet: 'Pimientos org√°nicos' },
                                    { name: 'C√∫rcuma', qty: 1, unit: 'cdta', why: 'Antiinflamatorio natural. Si te duelen las articulaciones, esto ayuda de verdad.', region: { latam: 'C√∫rcuma molida', emea: 'C√∫rcuma', usa: 'Turmeric' }, eco: 'C√∫rcuma molida', gourmet: 'C√∫rcuma fresca' },
                                    { name: 'Verduras de hoja', qty: 50, unit: 'g', why: 'Magnesio que relaja tus m√∫sculos. Te prepara para dormir profundo.', region: { latam: 'Acelga', emea: 'Espinacas', usa: 'Kale or spinach' }, eco: 'Acelga', gourmet: 'Kale org√°nico' }
                                ], 
                                steps: ['Sofr√≠e cebolla, zanahoria y pimiento unos 5 minutos hasta que huelan bien', 'A√±ade las lentejas, las especias y caldo o agua', 'Deja cocinar 20-35 minutos (depende del tipo de lenteja)', 'Los √∫ltimos 3 minutos echa las verduras de hoja'], 
                                why: 'Esta cena es ligera pero te llena. Tiene ingredientes que le dicen a tu cuerpo: "es hora de relajarse". El magnesio relaja, el tript√≥fano se convierte en melatonina, y la c√∫rcuma calma cualquier dolor que no te deje dormir.'
                            },
                            { 
                                name: 'Snack Pre-Sue√±o Perfecto', 
                                meal: 'Snack',
                                horario: '9:00-10:00 PM',
                                whyHorario: '1-2 horas antes de acostarte. Calcio se absorbe mejor de noche. Tript√≥fano necesita 60-90 min para convertirse en melatonina.',
                                calories: 280, 
                                time: '5 min', 
                                ingredients: [
                                    { name: 'Yogur natural', qty: 170, unit: 'g', why: 'Calcio que tu cuerpo absorbe mejor por la noche. Y bacterias buenas para tu digesti√≥n.', region: { latam: 'Yogur natural', emea: 'Yogur', usa: 'Plain yogurt' }, eco: 'Yogur natural b√°sico', gourmet: 'Yogur griego 0%' }, 
                                    { name: 'Nueces', qty: 20, unit: 'g', why: 'Tienen melatonina natural. Como una pastilla para dormir, pero de verdad.', region: { latam: 'Man√≠ o nueces', emea: 'Nueces', usa: 'Walnuts' }, eco: 'Cacahuetes', gourmet: 'Nueces de California' },
                                    { name: 'Fruta fresca', qty: 1, unit: 'ud', why: 'Algo de az√∫car natural que ayuda al tript√≥fano a llegar a tu cerebro y convertirse en sue√±o.', region: { latam: 'Pl√°tano o manzana', emea: 'Kiwi', usa: 'Kiwi or apple' }, eco: 'Manzana o pl√°tano', gourmet: 'Kiwi (tiene serotonina)' },
                                    { name: 'Semillas molidas', qty: 10, unit: 'g', why: 'Act√∫an como estr√≥genos suaves en tu cuerpo. Muchas mujeres notan menos sofocos con esto.', region: { latam: 'Lino molido', emea: 'Semillas de lino', usa: 'Ground flaxseed' }, eco: 'Lino molido en casa', gourmet: 'Mix ch√≠a + lino' }
                                ], 
                                steps: ['Pon el yogur en un bol', 'Pica las nueces y √©chalas', 'Corta la fruta en trozos', 'Espolvorea las semillas molidas por encima'], 
                                why: 'Come esto 1-2 horas antes de acostarte. Tiene todo para preparar tu cuerpo para un sue√±o profundo: calcio que se absorbe de noche, melatonina natural de las nueces, y algo dulce que calma la ansiedad nocturna.'
                            }
                        ],
                        martes: [
                            { name: 'Huevos Revueltos', meal: 'Desayuno', calories: 340, time: '10 min', ingredients: [{ name: 'Huevos', qty: 2, unit: 'piezas', why: 'Prote√≠na completa' }], steps: ['Revuelve huevos'], why: 'Prote√≠na pura' },
                            { name: 'Salm√≥n al Horno', meal: 'Almuerzo', calories: 480, time: '20 min', ingredients: [{ name: 'Salm√≥n', qty: 200, unit: 'g', why: 'Omega-3' }], steps: ['Hornea salm√≥n'], why: 'Reduce inflamaci√≥n' },
                            { name: 'Tofu a la Plancha', meal: 'Cena', calories: 320, time: '15 min', ingredients: [{ name: 'Tofu firme', qty: 250, unit: 'g', why: 'Prote√≠na vegetal' }], steps: ['Sofr√≠e tofu'], why: 'Opci√≥n vegana' },
                            { name: 'Batido Verde', meal: 'Snack', calories: 200, time: '5 min', ingredients: [{ name: 'Espinacas', qty: 50, unit: 'g', why: 'Minerales' }], steps: ['Lic√∫a'], why: 'Snack refrescante' }
                        ],
                        miercoles: [
                            { name: 'Granola Casera', meal: 'Desayuno', calories: 380, time: '10 min', ingredients: [{ name: 'Granola', qty: 50, unit: 'g', why: 'Fibra' }], steps: ['Sirve'], why: 'Desayuno c√≥modo' },
                            { name: 'Pavo con Boniato', meal: 'Almuerzo', calories: 460, time: '25 min', ingredients: [{ name: 'Pechuga pavo', qty: 250, unit: 'g', why: 'Prote√≠na magra' }], steps: ['Cocina'], why: 'Comida completa' },
                            { name: 'Garbanzos al Horno', meal: 'Cena', calories: 360, time: '20 min', ingredients: [{ name: 'Garbanzos cocidos', qty: 250, unit: 'g', why: 'Prote√≠na vegetal' }], steps: ['Hornea'], why: 'Cena vegetariana' },
                            { name: 'Frutos Secos', meal: 'Snack', calories: 220, time: '2 min', ingredients: [{ name: 'Almendras', qty: 30, unit: 'g', why: 'Prote√≠na' }], steps: ['Sirve'], why: 'Snack energ√©tico' }
                        ],
                        jueves: [
                            { name: 'Pudding de Ch√≠a', meal: 'Desayuno', calories: 320, time: '8 min', ingredients: [{ name: 'Semillas ch√≠a', qty: 30, unit: 'g', why: 'Omega-3' }], steps: ['Mezcla'], why: 'Desayuno que hidrata' },
                            { name: 'At√∫n a la Plancha', meal: 'Almuerzo', calories: 500, time: '15 min', ingredients: [{ name: 'Filete at√∫n', qty: 200, unit: 'g', why: 'Omega-3' }], steps: ['Asa at√∫n'], why: 'Pescado azul' },
                            { name: 'Pollo al Horno', meal: 'Cena', calories: 400, time: '30 min', ingredients: [{ name: 'Muslo pollo', qty: 250, unit: 'g', why: 'Prote√≠na' }], steps: ['Hornea'], why: 'Cena reconfortante' },
                            { name: 'Manzana con Almendras', meal: 'Snack', calories: 200, time: '3 min', ingredients: [{ name: 'Manzana', qty: 1, unit: 'pieza', why: 'Fibra' }], steps: ['Sirve'], why: 'Snack dulce' }
                        ],
                        viernes: [
                            { name: 'Panqueques Integrales', meal: 'Desayuno', calories: 400, time: '20 min', ingredients: [{ name: 'Harina integral', qty: 100, unit: 'g', why: 'Fibra' }], steps: ['Cocina'], why: 'Desayuno festivo' },
                            { name: 'Merluza a la Sal', meal: 'Almuerzo', calories: 420, time: '25 min', ingredients: [{ name: 'Filete merluza', qty: 250, unit: 'g', why: 'Prote√≠na magra' }], steps: ['Hornea'], why: 'Pescado blanco' },
                            { name: 'Pasta de Verdura', meal: 'Cena', calories: 380, time: '20 min', ingredients: [{ name: 'Pasta integral', qty: 150, unit: 'g', why: 'Fibra' }], steps: ['Cuece'], why: 'Cl√°sico italiano' },
                            { name: 'Chocolate Oscuro', meal: 'Snack', calories: 200, time: '2 min', ingredients: [{ name: 'Chocolate 85%', qty: 30, unit: 'g', why: 'Antioxidantes' }], steps: ['Sirve'], why: 'Snack gourmet' }
                        ],
                        sabado: [
                            { name: 'Brunch Completo', meal: 'Desayuno', calories: 450, time: '25 min', ingredients: [{ name: 'Huevos', qty: 2, unit: 'piezas', why: 'Prote√≠na' }], steps: ['Fr√≠e'], why: 'Brunch italiano' },
                            { name: 'Carne Magra', meal: 'Almuerzo', calories: 520, time: '20 min', ingredients: [{ name: 'Carne magra', qty: 250, unit: 'g', why: 'Prote√≠na' }], steps: ['Asa'], why: 'Prote√≠na fuerte' },
                            { name: 'Ratatouille', meal: 'Cena', calories: 300, time: '30 min', ingredients: [{ name: 'Verduras variadas', qty: 400, unit: 'g', why: 'Vitaminas' }], steps: ['Sofr√≠e'], why: 'Cena francesa' },
                            { name: 'T√© con Galletas', meal: 'Snack', calories: 180, time: '5 min', ingredients: [{ name: 'T√© verde', qty: 250, unit: 'ml', why: 'Antioxidantes' }], steps: ['Prepara'], why: 'Merienda acogedora' }
                        ],
                        domingo: [
                            { name: 'Smoothie Bowl', meal: 'Desayuno', calories: 420, time: '10 min', ingredients: [{ name: 'Ar√°ndanos', qty: 100, unit: 'g', why: 'Antioxidantes' }], steps: ['Mezcla'], why: 'Desayuno festivo' },
                            { name: 'Pollo Asado', meal: 'Almuerzo', calories: 500, time: '40 min', ingredients: [{ name: 'Pollo entero', qty: 400, unit: 'g', why: 'Prote√≠na' }], steps: ['Asa'], why: 'Almuerzo abundante' },
                            { name: 'Ceviche Vegetal', meal: 'Cena', calories: 320, time: '20 min', ingredients: [{ name: 'Palmitos', qty: 200, unit: 'g', why: 'Prote√≠na vegetal' }], steps: ['Mezcla'], why: 'Cena sofisticada' },
                            { name: 'Frutas de Temporada', meal: 'Snack', calories: 150, time: '5 min', ingredients: [{ name: 'Frutas variadas', qty: 300, unit: 'g', why: 'Vitaminas' }], steps: ['Sirve'], why: 'Snack natural' }
                        ]
                    },
                    en: {
                        lunes: [
                            { 
                                name: 'Oatmeal Bowl That Cares for You', 
                                meal: 'Breakfast',
                                horario: '7:00-9:00 AM',
                                whyHorario: 'Your cortisol is naturally high when you wake up. Complex carbs at this time stabilize your energy for the whole day without insulin spikes.',
                                calories: 420, 
                                time: '12 min', 
                                ingredients: [
                                    { name: 'Whole oats', qty: 50, unit: 'g', why: 'Will keep you full until lunch without sugar crashes that leave you drained mid-morning.', region: { latam: 'Avena', emea: 'Oats', usa: 'Oats' }, eco: 'Any brand', gourmet: 'Organic oats' }, 
                                    { name: 'Fortified milk', qty: 200, unit: 'ml', why: 'Your bones need extra calcium now. This milk gives you exactly what they ask for.', region: { latam: 'Leche', emea: 'Milk', usa: 'Milk' }, eco: 'Cow milk', gourmet: 'Fortified almond milk' }, 
                                    { name: 'Chia seeds', qty: 15, unit: 'g', why: 'They have a type of fat that helps calm hot flashes. Many women notice the difference in days.', region: { latam: 'Ch√≠a', emea: 'Chia seeds', usa: 'Chia seeds' }, eco: 'Ground flax seeds', gourmet: 'Organic chia' },
                                    { name: 'Berries', qty: 80, unit: 'g', why: 'They protect your brain when you feel that mental fog. They\'re like a shield for your clarity.', region: { latam: 'Frutillas o moras', emea: 'Blueberries', usa: 'Blueberries' }, eco: 'Frozen (same nutrients)', gourmet: 'Fresh organic' },
                                    { name: 'Nuts', qty: 10, unit: 'g', why: 'Help you sleep better at night. They have something your body converts into calm.', region: { latam: 'Man√≠ o nueces', emea: 'Almonds', usa: 'Almonds or walnuts' }, eco: 'Peanuts', gourmet: 'Raw almonds' }
                                ], 
                                steps: ['Heat the milk for 2 minutes', 'Add the oats and stir while cooking for 8 minutes', 'Add the seeds in the last 2 minutes', 'Serve and top with berries and nuts'], 
                                why: 'This breakfast gives you steady energy all morning. The magnesium from the seeds will help with hot flashes, and the good fats calm the inflammation you feel in your joints.'
                            },
                            { 
                                name: 'Fish with Everything You Need', 
                                meal: 'Lunch',
                                horario: '12:00-2:00 PM', 
                                whyHorario: 'Your digestion is at its peak. Protein and good fats are better absorbed now and keep your energy stable all afternoon.',
                                calories: 540, 
                                time: '25 min', 
                                ingredients: [
                                    { name: 'Fatty fish', qty: 150, unit: 'g', why: 'This fish has the fats your body stopped producing. They calm pain and give you mental clarity.', region: { latam: 'Jurel o at√∫n', emea: 'Sardines or mackerel', usa: 'Salmon or sardines' }, eco: 'Canned sardines (same benefits)', gourmet: 'Fresh salmon' }, 
                                    { name: 'Quinoa or rice', qty: 120, unit: 'g', why: 'Complete protein that keeps your muscles strong. Now you lose them faster and this slows it down.', region: { latam: 'Quinoa (cheap there)', emea: 'Quinoa', usa: 'Quinoa' }, eco: 'Brown rice', gourmet: 'Tricolor quinoa' },
                                    { name: 'Spinach', qty: 100, unit: 'g', why: 'Iron for when your periods go crazy. And vitamin K for your bones.', region: { latam: 'Acelga o espinaca', emea: 'Spinach', usa: 'Spinach' }, eco: 'Frozen spinach', gourmet: 'Fresh baby spinach' },
                                    { name: 'Avocado', qty: 50, unit: 'g', why: 'Good fat that helps absorb all the nutrients from the dish. A lubricant for your body.', region: { latam: 'Palta (abundant)', emea: 'Avocado', usa: 'Avocado' }, eco: 'Olive oil (1 tbsp)', gourmet: 'Hass avocado' },
                                    { name: 'Lemon', qty: 0.5, unit: 'pc', why: 'Multiplies by 3 the iron you absorb. A simple trick that works.', region: { latam: 'Lim√≥n', emea: 'Lemon', usa: 'Lemon' }, eco: 'Always affordable', gourmet: 'Organic lemons' }
                                ], 
                                steps: ['Cook the quinoa or rice (takes 15 minutes)', 'Meanwhile, grill the fish for 6-8 minutes per side (or heat the sardines if canned)', 'Saut√© the spinach for 3 minutes with some garlic if you like', 'Mix everything on the plate, add the avocado in chunks or the oil, and squeeze the lemon on top'], 
                                why: 'This dish has EVERYTHING your body asks for now: fats that calm, protein that strengthens, iron that energizes. It\'s like giving your body exactly what it needs to feel good.'
                            },
                            { 
                                name: 'Lentils That Hug You', 
                                meal: 'Dinner',
                                horario: '7:00-8:30 PM',
                                whyHorario: '2-3 hours before bed. Your body needs time to digest. Light plant protein prepares your sleep without heaviness.',
                                calories: 410, 
                                time: '35 min', 
                                ingredients: [
                                    { name: 'Lentils', qty: 150, unit: 'g', why: 'They have something your brain converts into the sleep hormone. Eat this for dinner and you\'ll sleep better.', region: { latam: 'Lentejas', emea: 'Lentils', usa: 'Lentils' }, eco: 'Dry lentils (very cheap)', gourmet: 'Red lentils (faster)' }, 
                                    { name: 'Carrot', qty: 100, unit: 'g', why: 'Vitamin A for your skin and mucous membranes that are drier now. It hydrates them from within.', region: { latam: 'Zanahoria', emea: 'Carrot', usa: 'Carrots' }, eco: 'Always affordable', gourmet: 'Baby carrots' },
                                    { name: 'Bell pepper', qty: 80, unit: 'g', why: 'Lots of vitamin C. Helps your body take advantage of all the iron from the lentils.', region: { latam: 'Aj√≠ morr√≥n', emea: 'Red pepper', usa: 'Bell pepper' }, eco: 'In season', gourmet: 'Organic peppers' },
                                    { name: 'Turmeric', qty: 1, unit: 'tsp', why: 'Natural anti-inflammatory. If your joints hurt, this really helps.', region: { latam: 'C√∫rcuma molida', emea: 'Turmeric', usa: 'Turmeric' }, eco: 'Ground turmeric', gourmet: 'Fresh turmeric' },
                                    { name: 'Leafy greens', qty: 50, unit: 'g', why: 'Magnesium that relaxes your muscles. Prepares you for deep sleep.', region: { latam: 'Acelga', emea: 'Spinach', usa: 'Kale or spinach' }, eco: 'Chard', gourmet: 'Organic kale' }
                                ], 
                                steps: ['Saut√© onion, carrot and pepper for about 5 minutes until they smell good', 'Add the lentils, spices and broth or water', 'Let cook for 20-35 minutes (depends on the type of lentil)', 'Add the leafy greens in the last 3 minutes'], 
                                why: 'This dinner is light but filling. It has ingredients that tell your body: "it\'s time to relax". Magnesium relaxes, tryptophan converts to melatonin, and turmeric calms any pain that won\'t let you sleep.'
                            },
                            { 
                                name: 'Perfect Pre-Sleep Snack', 
                                meal: 'Snack',
                                horario: '9:00-10:00 PM',
                                whyHorario: '1-2 hours before bed. Calcium is better absorbed at night. Tryptophan needs 60-90 min to convert to melatonin.',
                                calories: 280, 
                                time: '5 min', 
                                ingredients: [
                                    { name: 'Plain yogurt', qty: 170, unit: 'g', why: 'Calcium that your body absorbs better at night. And good bacteria for your digestion.', region: { latam: 'Yogur natural', emea: 'Yogurt', usa: 'Plain yogurt' }, eco: 'Basic plain yogurt', gourmet: 'Greek yogurt 0%' }, 
                                    { name: 'Walnuts', qty: 20, unit: 'g', why: 'They have natural melatonin. Like a sleeping pill, but real.', region: { latam: 'Man√≠ o nueces', emea: 'Walnuts', usa: 'Walnuts' }, eco: 'Peanuts', gourmet: 'California walnuts' },
                                    { name: 'Fresh fruit', qty: 1, unit: 'pc', why: 'Some natural sugar that helps tryptophan reach your brain and convert into sleep.', region: { latam: 'Pl√°tano o manzana', emea: 'Kiwi', usa: 'Kiwi or apple' }, eco: 'Apple or banana', gourmet: 'Kiwi (has serotonin)' },
                                    { name: 'Ground seeds', qty: 10, unit: 'g', why: 'They act like gentle estrogens in your body. Many women notice fewer hot flashes with this.', region: { latam: 'Lino molido', emea: 'Flax seeds', usa: 'Ground flaxseed' }, eco: 'Flax ground at home', gourmet: 'Chia + flax mix' }
                                ], 
                                steps: ['Put the yogurt in a bowl', 'Chop the walnuts and add them', 'Cut the fruit into pieces', 'Sprinkle the ground seeds on top'], 
                                why: 'Eat this 1-2 hours before bed. It has everything to prepare your body for deep sleep: calcium absorbed at night, natural melatonin from walnuts, and something sweet that calms nighttime anxiety.'
                            }
                        ],
                        martes: [
                            { name: 'Scrambled Eggs', meal: 'Breakfast', calories: 340, time: '10 min', ingredients: [{ name: 'Eggs', qty: 2, unit: 'pcs', why: 'Complete protein', region: { latam: 'Huevos', emea: 'Eggs', usa: 'Eggs' } }], steps: ['Scramble eggs'], why: 'Pure protein' },
                            { name: 'Baked Salmon', meal: 'Lunch', calories: 480, time: '20 min', ingredients: [{ name: 'Salmon', qty: 200, unit: 'g', why: 'Omega-3', region: { latam: 'Salm√≥n', emea: 'Salmon', usa: 'Salmon' } }], steps: ['Bake salmon'], why: 'Reduces inflammation' },
                            { name: 'Grilled Tofu', meal: 'Dinner', calories: 320, time: '15 min', ingredients: [{ name: 'Firm tofu', qty: 250, unit: 'g', why: 'Plant protein', region: { latam: 'Tofu', emea: 'Tofu', usa: 'Tofu' } }], steps: ['Saut√© tofu'], why: 'Vegan option' },
                            { name: 'Green Smoothie', meal: 'Snack', calories: 200, time: '5 min', ingredients: [{ name: 'Spinach', qty: 50, unit: 'g', why: 'Minerals', region: { latam: 'Espinacas', emea: 'Spinach', usa: 'Spinach' } }], steps: ['Blend'], why: 'Refreshing snack' }
                        ],
                        miercoles: [
                            { name: 'Homemade Granola', meal: 'Breakfast', calories: 380, time: '10 min', ingredients: [{ name: 'Granola', qty: 50, unit: 'g', why: 'Fiber', region: { latam: 'Granola', emea: 'Granola', usa: 'Granola' } }], steps: ['Serve'], why: 'Convenient breakfast' },
                            { name: 'Turkey with Sweet Potato', meal: 'Lunch', calories: 460, time: '25 min', ingredients: [{ name: 'Turkey breast', qty: 250, unit: 'g', why: 'Lean protein', region: { latam: 'Pavo', emea: 'Turkey', usa: 'Turkey' } }], steps: ['Cook'], why: 'Complete meal' },
                            { name: 'Roasted Chickpeas', meal: 'Dinner', calories: 360, time: '20 min', ingredients: [{ name: 'Cooked chickpeas', qty: 250, unit: 'g', why: 'Plant protein', region: { latam: 'Garbanzos', emea: 'Chickpeas', usa: 'Chickpeas' } }], steps: ['Roast'], why: 'Vegetarian dinner' },
                            { name: 'Mixed Nuts', meal: 'Snack', calories: 220, time: '2 min', ingredients: [{ name: 'Almonds', qty: 30, unit: 'g', why: 'Protein', region: { latam: 'Almendras', emea: 'Almonds', usa: 'Almonds' } }], steps: ['Serve'], why: 'Energetic snack' }
                        ],
                        jueves: [
                            { name: 'Chia Pudding', meal: 'Breakfast', calories: 320, time: '8 min', ingredients: [{ name: 'Chia seeds', qty: 30, unit: 'g', why: 'Omega-3', region: { latam: 'Ch√≠a', emea: 'Chia', usa: 'Chia' } }], steps: ['Mix'], why: 'Hydrating breakfast' },
                            { name: 'Grilled Tuna', meal: 'Lunch', calories: 500, time: '15 min', ingredients: [{ name: 'Tuna fillet', qty: 200, unit: 'g', why: 'Omega-3', region: { latam: 'At√∫n', emea: 'Tuna', usa: 'Tuna' } }], steps: ['Grill tuna'], why: 'Blue fish' },
                            { name: 'Baked Chicken', meal: 'Dinner', calories: 400, time: '30 min', ingredients: [{ name: 'Chicken thigh', qty: 250, unit: 'g', why: 'Protein', region: { latam: 'Pollo', emea: 'Chicken', usa: 'Chicken' } }], steps: ['Bake'], why: 'Comforting dinner' },
                            { name: 'Apple with Almonds', meal: 'Snack', calories: 200, time: '3 min', ingredients: [{ name: 'Apple', qty: 1, unit: 'pc', why: 'Fiber', region: { latam: 'Manzana', emea: 'Apple', usa: 'Apple' } }], steps: ['Serve'], why: 'Sweet snack' }
                        ],
                        viernes: [
                            { name: 'Whole Wheat Pancakes', meal: 'Breakfast', calories: 400, time: '20 min', ingredients: [{ name: 'Whole wheat flour', qty: 100, unit: 'g', why: 'Fiber', region: { latam: 'Harina integral', emea: 'Flour', usa: 'Flour' } }], steps: ['Cook'], why: 'Festive breakfast' },
                            { name: 'Salt-baked Hake', meal: 'Lunch', calories: 420, time: '25 min', ingredients: [{ name: 'Hake fillet', qty: 250, unit: 'g', why: 'Lean protein', region: { latam: 'Merluza', emea: 'Hake', usa: 'Hake' } }], steps: ['Bake'], why: 'White fish' },
                            { name: 'Vegetable Pasta', meal: 'Dinner', calories: 380, time: '20 min', ingredients: [{ name: 'Whole wheat pasta', qty: 150, unit: 'g', why: 'Fiber', region: { latam: 'Pasta', emea: 'Pasta', usa: 'Pasta' } }], steps: ['Cook'], why: 'Italian classic' },
                            { name: 'Dark Chocolate', meal: 'Snack', calories: 200, time: '2 min', ingredients: [{ name: 'Dark chocolate 85%', qty: 30, unit: 'g', why: 'Antioxidants', region: { latam: 'Chocolate', emea: 'Chocolate', usa: 'Chocolate' } }], steps: ['Serve'], why: 'Gourmet snack' }
                        ],
                        sabado: [
                            { name: 'Complete Brunch', meal: 'Breakfast', calories: 450, time: '25 min', ingredients: [{ name: 'Eggs', qty: 2, unit: 'pcs', why: 'Protein', region: { latam: 'Huevos', emea: 'Eggs', usa: 'Eggs' } }], steps: ['Fry'], why: 'Italian brunch' },
                            { name: 'Lean Meat', meal: 'Lunch', calories: 520, time: '20 min', ingredients: [{ name: 'Lean meat', qty: 250, unit: 'g', why: 'Protein', region: { latam: 'Carne', emea: 'Meat', usa: 'Meat' } }], steps: ['Grill'], why: 'Strong protein' },
                            { name: 'Ratatouille', meal: 'Dinner', calories: 300, time: '30 min', ingredients: [{ name: 'Mixed vegetables', qty: 400, unit: 'g', why: 'Vitamins', region: { latam: 'Verduras', emea: 'Vegetables', usa: 'Vegetables' } }], steps: ['Saut√©'], why: 'French dinner' },
                            { name: 'Tea with Cookies', meal: 'Snack', calories: 180, time: '5 min', ingredients: [{ name: 'Green tea', qty: 250, unit: 'ml', why: 'Antioxidants', region: { latam: 'T√©', emea: 'Tea', usa: 'Tea' } }], steps: ['Prepare'], why: 'Cozy afternoon' }
                        ],
                        domingo: [
                            { name: 'Smoothie Bowl', meal: 'Breakfast', calories: 420, time: '10 min', ingredients: [{ name: 'Blueberries', qty: 100, unit: 'g', why: 'Antioxidants', region: { latam: 'Ar√°ndanos', emea: 'Blueberries', usa: 'Blueberries' } }], steps: ['Mix'], why: 'Festive breakfast' },
                            { name: 'Roast Chicken', meal: 'Lunch', calories: 500, time: '40 min', ingredients: [{ name: 'Whole chicken', qty: 400, unit: 'g', why: 'Protein', region: { latam: 'Pollo', emea: 'Chicken', usa: 'Chicken' } }], steps: ['Roast'], why: 'Abundant lunch' },
                            { name: 'Vegetable Ceviche', meal: 'Dinner', calories: 320, time: '20 min', ingredients: [{ name: 'Hearts of palm', qty: 200, unit: 'g', why: 'Plant protein', region: { latam: 'Palmitos', emea: 'Palm hearts', usa: 'Hearts of palm' } }], steps: ['Mix'], why: 'Sophisticated dinner' },
                            { name: 'Seasonal Fruits', meal: 'Snack', calories: 150, time: '5 min', ingredients: [{ name: 'Mixed fruits', qty: 300, unit: 'g', why: 'Vitamins', region: { latam: 'Frutas', emea: 'Fruits', usa: 'Fruits' } }], steps: ['Serve'], why: 'Natural snack' }
                        ]
                    }
                };
                
                // ‚úÖ PERSONALIZACI√ìN SEG√öN NIVEL
                if (!currentUser) return baseMenus;
                
                const personalizedMenusES = {};
                const personalizedMenusEN = {};
                const userRegionKey = (currentUser?.region || 'latam').toLowerCase();
                console.log('üó∫Ô∏è getFallbackMenus ‚Üí userRegionKey:', userRegionKey, '| currentUser.region:', currentUser?.region, '| userRegion state:', userRegion);

                // Detectar s√≠ntoma dominante (solo trial/premium)
                let dominantSymptom = null;
                if ((tier === 'trial' || tier === 'premium') && symptoms && symptoms.length > 0) {
                    const recent = symptoms.slice(-3);
                    const scores = {};
                    recent.forEach(s => {
                        // S√≠ntomas directos del objeto
                        ['sleep','energy','mood','hotFlashes','anxiety','brainFog'].forEach(k => {
                            if (s[k] !== undefined) {
                                const label = { sleep: 'Insomnio', energy: 'Fatiga', mood: 'Cambios de Humor', hotFlashes: 'Sofocos', anxiety: 'Ansiedad', brainFog: 'Niebla Mental' }[k];
                                if (!scores[label]) scores[label] = [];
                                // Invertir sue√±o y energ√≠a: bajo = peor
                                const val = (k === 'sleep' || k === 'energy') ? (10 - (s[k] || 0)) : (s[k] || 0);
                                scores[label].push(val);
                            }
                        });
                        // S√≠ntomas del objeto symptoms nested
                        Object.keys(s.symptoms || {}).forEach(sym => {
                            if (!scores[sym]) scores[sym] = [];
                            scores[sym].push(s.symptoms[sym] || 0);
                        });
                    });
                    let maxAvg = 0;
                    Object.keys(scores).forEach(sym => {
                        const avg = scores[sym].reduce((a,b) => a+b, 0) / scores[sym].length;
                        if (avg > maxAvg) { maxAvg = avg; dominantSymptom = sym; }
                    });
                    if (maxAvg < 4) dominantSymptom = null;
                }
                
                // Personalizar para ESPA√ëOL
                for (const [day, recipes] of Object.entries(baseMenus.es)) {
                    personalizedMenusES[day] = recipes.map(recipe => {
                        
                        // 1. SWAP DE REGI√ìN (todos los niveles)
                        let regionalIngredients = recipe.ingredients.map(ing => {
                            if (ing.region && ing.region[userRegionKey]) {
                                return { ...ing, name: ing.region[userRegionKey] };
                            }
                            return ing;
                        });

                        // 2. FREE ‚Üí solo region swap, sin personalizaci√≥n
                        if (tier === 'free') {
                            return { ...recipe, ingredients: regionalIngredients };
                        }

                        // 3. TRIAL / PREMIUM ‚Üí restricciones diet√©ticas
                        regionalIngredients = regionalIngredients
                            .map(ing => applyDietaryRestrictions(ing, currentUser.health_conditions))
                            .filter(ing => ing !== null);
                        
                        let finalRecipe = { ...recipe, ingredients: regionalIngredients };
                        
                        // 4. TRIAL / PREMIUM ‚Üí ajuste de calor√≠as por TDEE
                        if (currentUser.tdee) {
                            finalRecipe = adjustCaloriesForUser(finalRecipe, currentUser.tdee);
                        }

                        // 5. TRIAL / PREMIUM ‚Üí etiquetar s√≠ntoma dominante
                        if (dominantSymptom) {
                            finalRecipe.symptomFocus = dominantSymptom;
                            finalRecipe.personalized = true;
                        }
                        
                        return finalRecipe;
                    });
                }
                
                // Personalizar para INGL√âS
                for (const [day, recipes] of Object.entries(baseMenus.en)) {
                    personalizedMenusEN[day] = recipes.map(recipe => {
                        
                        // 1. SWAP DE REGI√ìN (todos los niveles)
                        let regionalIngredients = recipe.ingredients.map(ing => {
                            if (ing.region && ing.region[userRegionKey]) {
                                return { ...ing, name: ing.region[userRegionKey] };
                            }
                            return ing;
                        });

                        // 2. FREE ‚Üí solo region swap, sin personalizaci√≥n
                        if (tier === 'free') {
                            return { ...recipe, ingredients: regionalIngredients };
                        }

                        // 3. TRIAL / PREMIUM ‚Üí restricciones diet√©ticas
                        regionalIngredients = regionalIngredients
                            .map(ing => applyDietaryRestrictions(ing, currentUser.health_conditions))
                            .filter(ing => ing !== null);
                        
                        let finalRecipe = { ...recipe, ingredients: regionalIngredients };
                        
                        // 4. TRIAL / PREMIUM ‚Üí ajuste de calor√≠as por TDEE
                        if (currentUser.tdee) {
                            finalRecipe = adjustCaloriesForUser(finalRecipe, currentUser.tdee);
                        }

                        // 5. TRIAL / PREMIUM ‚Üí etiquetar s√≠ntoma dominante
                        if (dominantSymptom) {
                            finalRecipe.symptomFocus = dominantSymptom;
                            finalRecipe.personalized = true;
                        }
                        
                        return finalRecipe;
                    });
                }
                
                return {
                    es: personalizedMenusES,
                    en: personalizedMenusEN
                };
            }; // Fin de getFallbackMenus
            
            // Sincronizar userRegion con el perfil cuando se carga
            useEffect(() => {
                if (currentUser?.region) {
                    console.log('üîÑ Sincrono regi√≥n desde perfil:', currentUser.region);
                    setUserRegion(currentUser.region.toLowerCase());
                }
            }, [currentUser]);

            // Cargar men√∫s al inicio y cuando cambie idioma/regi√≥n
            useEffect(() => {
                const loadMenus = async () => {
                    setMenusLoading(true);
                    const loadedMenus = await getWeekMenus();
                    setMenus(loadedMenus);
                    setMenusLoading(false);
                };
                if (currentUser) {
                    loadMenus();
                }
            }, [language, userRegion, currentUser]);

            // EJERCICIOS
            const getExercises = () => {
                const allExercises = {
                    strength: [
                        { 
                            name: 'Sentadillas', 
                            duration: '20 min', 
                            difficulty: 'Moderada', 
                            freq: '3x semana', 
                            day: language === 'es' ? 'Lunes' : 'Monday', 
                            why: language === 'es' ? 'Aumenta densidad √≥sea (1-3% anual). Previene osteoporosis crucial en esta etapa.' : 'Increases bone density (1-3% per year). Prevents osteoporosis critical at this stage.', 
                            science: language === 'es' ? 'Ejercicio de resistencia aumenta masa √≥sea m√°s que cardio. Pierdes 1% √≥seo anual sin ejercicio.' : 'Resistance exercise increases bone mass more than cardio. You lose 1% bone annually without exercise.',
                            steps: language === 'es' ? [
                                'Pies separados ancho de hombros, dedos ligeramente hacia afuera',
                                'Mant√©n espalda recta, pecho hacia afuera, brazos adelante para equilibrio',
                                'Baja doblando rodillas y caderas como si te sentaras (3 segundos)',
                                'Baja hasta muslos paralelos al suelo, rodillas NO pasan dedos pies',
                                'Sube empujando con talones, apretando gl√∫teos (2 segundos)',
                                'Haz 3 series x 10-15 repeticiones, descansa 60 seg entre series',
                                'Si te cuesta: Pon silla detr√°s, baja hasta tocarla sin sentarte',
                                'Equipo: NINGUNO (peso corporal)'
                            ] : [
                                'Feet shoulder-width apart, toes slightly outward',
                                'Keep back straight, chest out, arms forward for balance',
                                'Lower by bending knees and hips like sitting in chair (3 seconds)',
                                'Lower until thighs parallel to ground, knees DON\'T pass toes',
                                'Rise pushing through heels, squeezing glutes (2 seconds)',
                                'Do 3 sets x 10-15 reps, rest 60 sec between sets',
                                'If difficult: Put chair behind, lower until touching without sitting',
                                'Equipment: NONE (bodyweight)'
                            ]
                        },
                        { 
                            name: language === 'es' ? 'Flexiones en Pared' : 'Wall Push-ups', 
                            duration: '15 min', 
                            difficulty: language === 'es' ? 'F√°cil-Moderada' : 'Easy-Moderate', 
                            freq: '2x semana', 
                            day: language === 'es' ? 'Mi√©rcoles' : 'Wednesday', 
                            why: language === 'es' ? 'Fortalece pecho, brazos y core. Mejora postura sin impacto en mu√±ecas.' : 'Strengthens chest, arms and core. Improves posture without wrist impact.', 
                            science: language === 'es' ? 'P√©rdida de estr√≥geno causa p√©rdida de 0.5-1% muscular anual. Ejercicio de resistencia ralentiza esto.' : 'Estrogen loss causes 0.5-1% muscle loss annually. Resistance exercise slows this.',
                            steps: language === 'es' ? [
                                'P√°rate frente a pared, distancia 60-80cm',
                                'Manos en pared altura hombros, separadas ancho hombros',
                                'Cuerpo forma l√≠nea recta desde cabeza a talones, abdomen tenso',
                                'Baja pecho hacia pared doblando codos (3 segundos)',
                                'Codos a 45¬∞ del cuerpo, nariz casi toca pared',
                                'Empuja para volver arriba sin bloquear codos (2 segundos)',
                                'Haz 3 series x 10-15 repeticiones, descansa 60 seg',
                                'Progresi√≥n: Semana 3-4 usa mesa m√°s baja, semana 5+ banco',
                                'Equipo: Solo pared'
                            ] : [
                                'Stand facing wall, 60-80cm away',
                                'Hands on wall shoulder height, shoulder-width apart',
                                'Body forms straight line head to heels, abs tight',
                                'Lower chest to wall bending elbows (3 seconds)',
                                'Elbows 45¬∞ from body, nose almost touches wall',
                                'Push back up without locking elbows (2 seconds)',
                                'Do 3 sets x 10-15 reps, rest 60 sec',
                                'Progression: Week 3-4 use lower table, week 5+ bench',
                                'Equipment: Just wall'
                            ]
                        },
                        { 
                            name: language === 'es' ? 'Levantamiento de Mancuernas' : 'Dumbbell Lifting', 
                            duration: '25 min', 
                            difficulty: 'Moderada', 
                            freq: '3x semana', 
                            day: language === 'es' ? 'Viernes' : 'Friday', 
                            why: language === 'es' ? 'Incrementa fuerza y masa muscular. Acelera metabolismo 5-7%.' : 'Increases strength and muscle mass. Accelerates metabolism 5-7%.', 
                            science: language === 'es' ? 'Cada kg de m√∫sculo quema 6 calor√≠as en reposo. Es tu aliado metab√≥lico en esta etapa.' : 'Each kg of muscle burns 6 calories at rest. It\'s your metabolism ally at this stage.',
                            steps: language === 'es' ? [
                                'Pies separados ancho hombros, rodillas ligeramente flexionadas',
                                'Mancuernas a los lados, palmas hacia cuerpo (2-5kg para empezar)',
                                'Levanta brazos laterales hasta altura hombros formando T',
                                'Mant√©n codos ligeramente flexionados, no uses impulso del cuerpo',
                                'Baja controlado en 3 segundos',
                                'Haz 3 series x 10-12 repeticiones, descansa 60 seg',
                                'NO subas m√°s arriba de hombros, NO balancees cuerpo',
                                'Alternativa SIN mancuernas: Usa botellas de agua 1L',
                                'Equipo: Mancuernas 2-5kg O botellas de agua'
                            ] : [
                                'Feet shoulder-width, knees slightly bent',
                                'Dumbbells at sides, palms facing body (4-10lbs to start)',
                                'Lift arms laterally to shoulder height forming T',
                                'Keep elbows slightly bent, don\'t use body momentum',
                                'Lower controlled in 3 seconds',
                                'Do 3 sets x 10-12 reps, rest 60 sec',
                                'DON\'T raise above shoulders, DON\'T swing body',
                                'Alternative WITHOUT dumbbells: Use 1L water bottles',
                                'Equipment: 4-10lb dumbbells OR water bottles'
                            ]
                        },
                        { 
                            name: language === 'es' ? 'Planchas Abdominales' : 'Planks', 
                            duration: '10 min', 
                            difficulty: 'Moderada', 
                            freq: '3x semana', 
                            day: language === 'es' ? 'Martes' : 'Tuesday', 
                            why: language === 'es' ? 'Fortalece core. Mejora estabilidad y postura.' : 'Strengthens core. Improves stability and posture.', 
                            science: language === 'es' ? 'Core fuerte previene ca√≠das (comunes en mujeres 40-55) y reduce dolor de espalda 60%.' : 'Strong core prevents falls (common in 40-55 year old women) and reduces back pain 60%.',
                            steps: language === 'es' ? [
                                'Posici√≥n inicial: Apoya antebrazos en el suelo, codos bajo hombros',
                                'Extiende piernas atr√°s, apoyada en puntas de pies',
                                'Forma l√≠nea recta desde cabeza a talones (NO hundas caderas)',
                                'Activa abdomen como si te fueran a golpear, aprieta gl√∫teos',
                                'Mant√©n la posici√≥n: Principiante 20-30 seg, Intermedio 45-60 seg',
                                'Descansa 30-60 seg entre series',
                                'Haz 3-4 series totales',
                                'Variante m√°s f√°cil: Apoya rodillas en suelo en vez de pies',
                                'Equipo: Solo colchoneta'
                            ] : [
                                'Starting position: Support on forearms, elbows under shoulders',
                                'Extend legs back, supported on toes',
                                'Form straight line from head to heels (DON\'T sag hips)',
                                'Engage abs as if about to be punched, squeeze glutes',
                                'Hold position: Beginner 20-30 sec, Intermediate 45-60 sec',
                                'Rest 30-60 sec between sets',
                                'Do 3-4 total sets',
                                'Easier variant: Support knees on floor instead of feet',
                                'Equipment: Just mat'
                            ]
                        },
                        { 
                            name: language === 'es' ? 'Desplantes' : 'Lunges', 
                            duration: '20 min', 
                            difficulty: 'Moderada', 
                            freq: '2x semana', 
                            day: language === 'es' ? 'Jueves' : 'Thursday', 
                            why: language === 'es' ? 'Trabaja piernas y equilibrio. Funcional para vida diaria.' : 'Works legs and balance. Functional for daily life.', 
                            science: language === 'es' ? 'Mejora propiocepci√≥n. Previene lesiones por ca√≠das que son 3x m√°s frecuentes en esta etapa.' : 'Improves proprioception. Prevents fall injuries which are 3x more frequent at this stage.',
                            steps: language === 'es' ? [
                                'P√°rate derecha, pies ancho de caderas',
                                'Da un paso largo adelante con pierna derecha',
                                'Baja cadera hasta rodilla trasera casi toca suelo',
                                'Rodilla delantera a 90¬∞, NO pasa dedos pie',
                                'Empuja con tal√≥n delantero para volver arriba',
                                'Alterna piernas o haz todas de un lado primero',
                                'Haz 3 series x 10-12 repeticiones por pierna',
                                'Principiante: Ag√°rrate de silla para equilibrio',
                                'Equipo: NINGUNO (o silla de apoyo)'
                            ] : [
                                'Stand straight, feet hip-width apart',
                                'Take long step forward with right leg',
                                'Lower hips until back knee almost touches floor',
                                'Front knee at 90¬∞, DON\'T pass toes',
                                'Push through front heel to return up',
                                'Alternate legs or do all one side first',
                                'Do 3 sets x 10-12 reps per leg',
                                'Beginner: Hold chair for balance',
                                'Equipment: NONE (or chair for support)'
                            ]
                        },
                        { 
                            name: language === 'es' ? 'Remo con Banda' : 'Rowing with Band', 
                            duration: '15 min', 
                            difficulty: language === 'es' ? 'F√°cil-Moderada' : 'Easy-Moderate', 
                            freq: '2x semana', 
                            day: language === 'es' ? 'S√°bado' : 'Saturday', 
                            why: language === 'es' ? 'Fortalece espalda. Mejora postura que se debilita con cambios hormonales.' : 'Strengthens back. Improves posture that weakens with hormonal changes.', 
                            science: language === 'es' ? 'Estr√≥geno soportaba musculatura. Sin √©l, necesitas refuerzo activo. Remo restaura alineaci√≥n.' : 'Estrogen supported muscles. Without it, you need active reinforcement. Rowing restores alignment.',
                            steps: language === 'es' ? [
                                'Si√©ntate en suelo, piernas extendidas adelante',
                                'Pasa banda el√°stica por plantas de pies, agarra extremos',
                                'Espalda recta, pecho hacia afuera',
                                'Tira banda hacia tu abdomen, codos pegados al cuerpo',
                                'Aprieta om√≥platos atr√°s al final del movimiento',
                                'Vuelve controlado a posici√≥n inicial',
                                'Haz 3 series x 12-15 repeticiones',
                                'Sin banda: Usa toalla pasada bajo pies',
                                'Equipo: Banda el√°stica ‚Ç¨5-10 O toalla'
                            ] : [
                                'Sit on floor, legs extended forward',
                                'Pass elastic band under feet, grab ends',
                                'Back straight, chest out',
                                'Pull band to abdomen, elbows close to body',
                                'Squeeze shoulder blades back at end of movement',
                                'Return controlled to starting position',
                                'Do 3 sets x 12-15 reps',
                                'Without band: Use towel passed under feet',
                                'Equipment: Elastic band ‚Ç¨5-10 OR towel'
                            ]
                        }
                    ],
                    weightLoss: [
                        { 
                            name: language === 'es' ? 'Caminata R√°pida' : 'Brisk Walking', 
                            duration: '30 min', 
                            difficulty: language === 'es' ? 'F√°cil' : 'Easy', 
                            freq: '5-7x semana', 
                            day: language === 'es' ? 'Diariamente' : 'Daily', 
                            why: language === 'es' ? 'Quema 200-300 calor√≠as. Accesible, bajo impacto, social.' : 'Burns 200-300 calories. Accessible, low impact, social.', 
                            science: language === 'es' ? 'Cardio moderado mejora sensibilidad insul√≠nica (baja en esta etapa). Reduce sofocos 30-40%.' : 'Moderate cardio improves insulin sensitivity (low at this stage). Reduces hot flashes 30-40%.',
                            steps: language === 'es' ? [
                                'Ritmo r√°pido: Puedes hablar pero no cantar (zona aer√≥bica)',
                                'Brazos doblados a 90¬∞, mu√©velos al ritmo de pasos',
                                'Tal√≥n toca suelo primero, impulsa con dedos',
                                'Postura recta, mirada al frente, hombros relajados',
                                'Primeros 5 min: Calentamiento ritmo suave',
                                'Minutos 6-25: Ritmo r√°pido constante',
                                '√öltimos 5 min: Enfriamiento bajando ritmo',
                                'Ideal: Parques, paseo mar√≠timo, caminadoras',
                                'Equipo: Zapatillas c√≥modas'
                            ] : [
                                'Brisk pace: Can talk but not sing (aerobic zone)',
                                'Arms bent 90¬∞, move with step rhythm',
                                'Heel touches ground first, push off with toes',
                                'Straight posture, look forward, shoulders relaxed',
                                'First 5 min: Warm-up gentle pace',
                                'Minutes 6-25: Constant brisk pace',
                                'Last 5 min: Cool down slowing pace',
                                'Ideal: Parks, boardwalk, treadmills',
                                'Equipment: Comfortable shoes'
                            ]
                        },
                        { 
                            name: language === 'es' ? 'Bicicleta Est√°tica' : 'Stationary Bike', 
                            duration: '30 min', 
                            difficulty: 'Moderada', 
                            freq: '3-4x semana', 
                            day: language === 'es' ? 'Lunes, Mi√©rcoles, Viernes' : 'Mon, Wed, Fri', 
                            why: language === 'es' ? 'Quema 250-400 calor√≠as. Sin impacto articular.' : 'Burns 250-400 calories. No joint impact.', 
                            science: language === 'es' ? 'Cardio aer√≥bico reduce grasa visceral (la m√°s peligrosa). Disminuye riesgo cardiovascular 35%.' : 'Aerobic cardio reduces visceral fat (the most dangerous). Reduces cardiovascular risk 35%.',
                            steps: language === 'es' ? [
                                'Ajusta sill√≠n: Rodilla ligeramente flexionada cuando pedal abajo',
                                'Resistencia moderada: Puedes mantener conversaci√≥n',
                                'Primeros 5 min: Resistencia baja para calentar',
                                'Minutos 6-25: Aumenta resistencia, mant√©n ritmo constante',
                                '√öltimos 5 min: Baja resistencia, pedalea suave',
                                'Mant√©n espalda recta, hombros relajados',
                                'Manos sueltas en manillar, no te apoyes con peso',
                                'Alternativa: Bicicleta normal en ruta plana',
                                'Equipo: Bicicleta est√°tica o normal'
                            ] : [
                                'Adjust seat: Knee slightly bent when pedal down',
                                'Moderate resistance: Can maintain conversation',
                                'First 5 min: Low resistance to warm up',
                                'Minutes 6-25: Increase resistance, maintain constant rhythm',
                                'Last 5 min: Lower resistance, pedal gently',
                                'Keep back straight, shoulders relaxed',
                                'Hands loose on handlebar, don\'t lean with weight',
                                'Alternative: Regular bike on flat route',
                                'Equipment: Stationary or regular bike'
                            ]
                        },
                        { name: 'HIIT (Intervalos)', duration: '20 min', difficulty: language === 'es' ? 'Alta' : 'High', freq: '2x semana', day: language === 'es' ? 'Martes, Jueves' : 'Tue, Thu', why: language === 'es' ? 'M√°xima quema cal√≥rica en m√≠nimo tiempo. Efecto EPOC (metabolismo acelerado 24h).' : 'Maximum calorie burn in minimum time. EPOC effect (accelerated metabolism 24h).', science: language === 'es' ? 'HIIT aumenta EPOC 25-30%. Eficiente cuando tienes poco tiempo. Aumenta VO2 m√°x 15-25%.' : 'HIIT increases EPOC 25-30%. Efficient when time is limited. Increases max VO2 15-25%.' },
                        { name: language === 'es' ? 'Saltar la Cuerda' : 'Jump Rope', duration: '15 min', difficulty: 'Moderada', freq: '2x semana', day: language === 'es' ? 'Mi√©rcoles, S√°bado' : 'Wed, Sat', why: language === 'es' ? 'Quema 300+ calor√≠as/30 min. Tonifica piernas y core.' : 'Burns 300+ calories/30 min. Tones legs and core.', science: language === 'es' ? 'Saltar fortalece huesos (crucial ahora). Quema m√°s calor√≠as que correr en mismo tiempo.' : 'Jumping strengthens bones (crucial now). Burns more calories than running in same time.' },
                        { 
                            name: language === 'es' ? 'Nataci√≥n' : 'Swimming', 
                            duration: '45 min', 
                            difficulty: 'Moderada', 
                            freq: '2x semana', 
                            day: language === 'es' ? 'Lunes, Viernes' : 'Mon, Fri', 
                            why: language === 'es' ? 'Quema 300-400 calor√≠as. Bajo impacto. Trabaja todo el cuerpo.' : 'Burns 300-400 calories. Low impact. Works entire body.', 
                            science: language === 'es' ? 'Nataci√≥n trabaja 85% m√∫sculos. Mejora cardiovascular sin estr√©s articular. Reduce sofocos.' : 'Swimming works 85% of muscles. Improves cardiovascular health without joint stress. Reduces hot flashes.',
                            steps: language === 'es' ? [
                                'Estilo crol o espalda (m√°s f√°ciles que mariposa)',
                                'Primeros 10 min: Nada suave para calentar',
                                'Minutos 11-35: Ritmo moderado constante',
                                '√öltimos 10 min: Ritmo suave para enfriar',
                                'Respira cada 2-3 brazadas (no aguantes respiraci√≥n)',
                                'Si no sabes nadar: Camina en agua hasta cintura',
                                'Alternativa: Aquagym en piscina',
                                'Equipo: Traje de ba√±o, gorro, gafas'
                            ] : [
                                'Freestyle or backstroke (easier than butterfly)',
                                'First 10 min: Swim gently to warm up',
                                'Minutes 11-35: Constant moderate pace',
                                'Last 10 min: Gentle pace to cool down',
                                'Breathe every 2-3 strokes (don\'t hold breath)',
                                'If you can\'t swim: Walk in waist-deep water',
                                'Alternative: Water aerobics in pool',
                                'Equipment: Swimsuit, cap, goggles'
                            ]
                        },
                        { 
                            name: language === 'es' ? 'El√≠ptica' : 'Elliptical', 
                            duration: '25 min', 
                            difficulty: language === 'es' ? 'Moderada-Alta' : 'Moderate-High', 
                            freq: '3x semana', 
                            day: language === 'es' ? 'Martes, Jueves, Domingo' : 'Tue, Thu, Sun', 
                            why: language === 'es' ? 'Cardio intenso sin impacto. Quema 250-350 calor√≠as.' : 'Intense cardio without impact. Burns 250-350 calories.', 
                            science: language === 'es' ? 'Bajo impacto pero intenso. Ideal para perder peso sin lesionar articulaciones.' : 'Low impact but intense. Ideal for weight loss without joint injury.',
                            steps: language === 'es' ? [
                                'Agarra manillares m√≥viles (trabajas brazos y piernas)',
                                'Primeros 5 min: Resistencia baja, ritmo suave',
                                'Minutos 6-20: Aumenta resistencia, ritmo moderado-alto',
                                '√öltimos 5 min: Baja resistencia, ritmo suave',
                                'Mant√©n espalda recta, no te inclines adelante',
                                'Pies completos en pedales (no solo puntas)',
                                'Alternativa: Caminadora con inclinaci√≥n',
                                'Equipo: M√°quina el√≠ptica (gym o casa)'
                            ] : [
                                'Grab moving handles (work arms and legs)',
                                'First 5 min: Low resistance, gentle pace',
                                'Minutes 6-20: Increase resistance, moderate-high pace',
                                'Last 5 min: Lower resistance, gentle pace',
                                'Keep back straight, don\'t lean forward',
                                'Full feet on pedals (not just toes)',
                                'Alternative: Treadmill with incline',
                                'Equipment: Elliptical machine (gym or home)'
                            ]
                        }
                    ],
                    hormonal: [
                        { 
                            name: language === 'es' ? 'Yoga Suave' : 'Gentle Yoga', 
                            duration: '45 min', 
                            difficulty: language === 'es' ? 'F√°cil' : 'Easy', 
                            freq: '3x semana', 
                            day: language === 'es' ? 'Lunes, Mi√©rcoles, Viernes' : 'Mon, Wed, Fri', 
                            why: language === 'es' ? 'Reduce estr√©s que desencadena sofocos. Mejora sue√±o 40% en estudios.' : 'Reduces stress that triggers hot flashes. Improves sleep 40% in studies.', 
                            science: language === 'es' ? 'Cortisol elevado empeora s√≠ntomas. Yoga reduce cortisol 25%. Restaura balance nervioso.' : 'High cortisol worsens symptoms. Yoga reduces cortisol 25%. Restores nervous balance.',
                            steps: language === 'es' ? [
                                'Busca clase "Yoga suave" o "Hatha yoga" para principiantes',
                                'Posturas b√°sicas: Perro boca abajo, gato-vaca, ni√±o',
                                'Mant√©n cada postura 5 respiraciones profundas',
                                'NO fuerces, el yoga NO duele',
                                'Enf√≥cate en respiraci√≥n lenta y profunda',
                                'Termina con 10 min de relajaci√≥n tumbada',
                                'Online: Youtube "yoga suave" o apps como Down Dog',
                                'Equipo: Colchoneta de yoga'
                            ] : [
                                'Look for "Gentle yoga" or "Hatha yoga" for beginners',
                                'Basic poses: Downward dog, cat-cow, child',
                                'Hold each pose 5 deep breaths',
                                'DON\'T force, yoga doesn\'t hurt',
                                'Focus on slow, deep breathing',
                                'End with 10 min relaxation lying down',
                                'Online: Youtube "gentle yoga" or apps like Down Dog',
                                'Equipment: Yoga mat'
                            ]
                        },
                        { 
                            name: 'Tai Chi', 
                            duration: '40 min', 
                            difficulty: language === 'es' ? 'F√°cil' : 'Easy', 
                            freq: '3x semana', 
                            day: language === 'es' ? 'Martes, Jueves, S√°bado' : 'Tue, Thu, Sat', 
                            why: language === 'es' ? 'Meditaci√≥n en movimiento. Mejora balance. Calma ansiedad.' : 'Moving meditation. Improves balance. Calms anxiety.', 
                            science: language === 'es' ? 'Estudios chinos: Tai Chi reduce sofocos 50%. Mejora sue√±o m√°s que otros ejercicios en mujeres.' : 'Chinese studies: Tai Chi reduces hot flashes 50%. Improves sleep more than other exercises in women.',
                            steps: language === 'es' ? [
                                'Busca clase local de Tai Chi o videos "Tai Chi principiantes"',
                                'Movimientos lentos, fluidos, como en c√°mara lenta',
                                'Respira profundo y lento coordinando con movimientos',
                                'Enfoca mente en cada movimiento (meditaci√≥n activa)',
                                'Practica descalza o con zapatillas flexibles',
                                'Ideal al aire libre (parque, jard√≠n)',
                                'Online: Youtube "tai chi for beginners"',
                                'Equipo: NINGUNO (ropa c√≥moda)'
                            ] : [
                                'Find local Tai Chi class or videos "Tai Chi for beginners"',
                                'Slow, flowing movements, like slow motion',
                                'Breathe deep and slow coordinating with movements',
                                'Focus mind on each movement (active meditation)',
                                'Practice barefoot or flexible shoes',
                                'Ideal outdoors (park, garden)',
                                'Online: Youtube "tai chi for beginners"',
                                'Equipment: NONE (comfortable clothes)'
                            ]
                        },
                        { name: language === 'es' ? 'Pilates Core' : 'Pilates Core', duration: '30 min', difficulty: 'Moderada', freq: '2-3x semana', day: language === 'es' ? 'Lunes, Jueves' : 'Mon, Thu', why: language === 'es' ? 'Fortalece centro del cuerpo. Mejora postura. Estabilidad.' : 'Strengthens core body. Improves posture. Stability.', science: language === 'es' ? 'Fortalecimiento core reduce dolor de espalda 60%. Mejora postura que se cae con cambios hormonales.' : 'Core strengthening reduces back pain 60%. Improves posture that weakens with hormonal changes.' },
                        { name: language === 'es' ? 'Respiraci√≥n Consciente' : 'Conscious Breathing', duration: '15 min', difficulty: language === 'es' ? 'F√°cil' : 'Easy', freq: '4-5x semana', day: language === 'es' ? 'Diariamente' : 'Daily', why: language === 'es' ? 'Activa sistema nervioso parasimp√°tico (calma). Reduce sofocos instant√°neamente.' : 'Activates parasympathetic nervous system (calm). Reduces hot flashes instantly.', science: language === 'es' ? 'Respiraci√≥n 4-4-6 reduce cortisol 30%. En sofoco: respira y baja 50% intensidad.' : '4-4-6 breathing reduces cortisol 30%. In a hot flash: breathe and reduce intensity 50%.' },
                        { name: language === 'es' ? 'Caminata Meditativa' : 'Meditative Walk', duration: '30 min', difficulty: language === 'es' ? 'F√°cil' : 'Easy', freq: '5x semana', day: language === 'es' ? 'Diariamente' : 'Daily', why: language === 'es' ? 'Mezcla cardio suave con conexi√≥n emocional. Anti-ansiedad natural.' : 'Mixes light cardio with emotional connection. Natural anti-anxiety.', science: language === 'es' ? 'Naturaleza reduce cortisol en 20 min. Caminar mejora serotonina naturalmente.' : 'Nature reduces cortisol in 20 min. Walking improves serotonin naturally.' },
                        { name: language === 'es' ? 'Estiramientos Profundos' : 'Deep Stretching', duration: '20 min', difficulty: language === 'es' ? 'F√°cil' : 'Easy', freq: '3x semana', day: language === 'es' ? 'Mi√©rcoles, Viernes, Domingo' : 'Wed, Fri, Sun', why: language === 'es' ? 'Libera tensi√≥n f√≠sica. Mejora flexibilidad.' : 'Releases physical tension. Improves flexibility.', science: language === 'es' ? 'Estr√©s se almacena en m√∫sculos. Estiramientos liberan tensi√≥n y reduce cortisol.' : 'Stress is stored in muscles. Stretching releases tension and reduces cortisol.' }
                    ]
                };
                
                // PERSONALIZACI√ìN: Ya filtra por exerciseGoal (strength/weightLoss/hormonal)
                // TODO futuro: Ajustar intensidad seg√∫n edad y condiciones f√≠sicas
                return allExercises[exerciseGoal] || [];
            };

            // MITOS
            const getMythsAndTips = () => {
                return {
                    myths: language === 'es' ? [
                        { 
                            myth: 'Necesitas medicaci√≥n obligatoriamente', 
                            truth: 'Tienes opciones: cambios de estilo de vida, terapias naturales Y medicaci√≥n si la necesitas', 
                            science: 'Esta etapa es biol√≥gicamente natural. El estr√≥geno desciende 90% pero es un cambio fisiol√≥gico, no una enfermedad. Estudios muestran que ejercicio + nutrici√≥n reducen s√≠ntomas 40-60% sin medicaci√≥n. PERO si tus s√≠ntomas son severos, la terapia hormonal es segura y efectiva bajo supervisi√≥n m√©dica.',
                            action: 'Documenta s√≠ntomas 3 meses. Si afectan tu calidad de vida, consulta opciones m√©dicas sin miedo.',
                            source: 'https://pubmed.ncbi.nlm.nih.gov/26444994/'
                        },
                        { 
                            myth: 'Los sofocos duran para siempre', 
                            truth: 'La mayor√≠a dura 5-8 a√±os. La intensidad disminuye progresivamente', 
                            science: 'Estudio SWAN (Study of Women\'s Health Across the Nation): 65% de mujeres resuelve sofocos en 8 a√±os, 90% en 10 a√±os. Intensidad m√°xima en a√±os 1-3, luego disminuye naturalmente.',
                            action: 'Ejercicio moderado + sue√±o 7-9h + manejo estr√©s = reducci√≥n de sofocos 30-50%',
                            source: 'https://pubmed.ncbi.nlm.nih.gov/25786690/'
                        },
                        { 
                            myth: 'Es imposible no engordar', 
                            truth: 'El metabolismo baja ligeramente, pero T√ö controlas tu peso', 
                            science: 'Metabolismo basal desciende 100-200 calor√≠as/d√≠a (5-8%). Pero entrenamiento de fuerza 2-3x/semana recupera 3-5% del metabolismo. Prote√≠na 1.2-1.6g/kg preserva masa muscular que quema calor√≠as.',
                            action: 'Fuerza 2-3 d√≠as/semana + prote√≠na cada comida = peso estable o p√©rdida controlada',
                            source: 'https://pubmed.ncbi.nlm.nih.gov/35231009/'
                        },
                        { 
                            myth: 'Tu vida sexual termin√≥', 
                            truth: 'Muchas mujeres reportan MEJOR vida sexual sin miedo a embarazo', 
                            science: 'Sequedad vaginal es tratable con lubricantes y humectantes (efectividad 80-90%). Estudios: 40% de mujeres reporta MEJOR satisfacci√≥n sexual en esta etapa por libertad de anticoncepci√≥n y mejor comunicaci√≥n con pareja.',
                            action: 'Lubricante base agua + comunicaci√≥n abierta + tiempo = intimidad plena',
                            source: 'https://pubmed.ncbi.nlm.nih.gov/19212271/'
                        }
                    ] : [
                        { 
                            myth: 'You must take medication', 
                            truth: 'You have options: lifestyle changes, natural therapies AND medication if you need it', 
                            science: 'This stage is biologically natural. Estrogen drops 90% but it\'s physiological change, not disease. Studies show exercise + nutrition reduce symptoms 40-60% without medication. BUT if symptoms are severe, hormone therapy is safe and effective under medical supervision.',
                            action: 'Document symptoms for 3 months. If they affect your quality of life, consult medical options without fear.',
                            source: 'https://pubmed.ncbi.nlm.nih.gov/26444994/'
                        },
                        { 
                            myth: 'Hot flashes last forever', 
                            truth: 'Most last 5-8 years. Intensity decreases progressively', 
                            science: 'SWAN Study (Study of Women\'s Health Across the Nation): 65% of women resolve hot flashes in 8 years, 90% in 10. Maximum intensity years 1-3, then naturally decreases.',
                            action: 'Moderate exercise + 7-9h sleep + stress management = 30-50% reduction in hot flashes',
                            source: 'https://pubmed.ncbi.nlm.nih.gov/25786690/'
                        },
                        { 
                            myth: 'Weight gain is inevitable', 
                            truth: 'Metabolism drops slightly, but YOU control your weight', 
                            science: 'Basal metabolism decreases 100-200 calories/day (5-8%). But strength training 2-3x/week recovers 3-5% of metabolism. Protein 1.2-1.6g/kg preserves muscle mass that burns calories.',
                            action: 'Strength 2-3 days/week + protein every meal = stable weight or controlled loss',
                            source: 'https://pubmed.ncbi.nlm.nih.gov/35231009/'
                        },
                        { 
                            myth: 'Your sexual life is over', 
                            truth: 'Many women report BETTER sexual life without pregnancy fear', 
                            science: 'Vaginal dryness is treatable with lubricants and moisturizers (80-90% effectiveness). Studies: 40% of women report BETTER sexual satisfaction at this stage due to contraception freedom and better partner communication.',
                            action: 'Water-based lubricant + open communication + time = full intimacy',
                            source: 'https://pubmed.ncbi.nlm.nih.gov/19212271/'
                        }
                    ],
                    tips: language === 'es' ? [
                        { emoji: 'üåô', title: 'Sue√±o 7-9 Horas', why: 'El sue√±o es reparaci√≥n. Tu cuerpo NECESITA m√°s sue√±o. Dormir 7+ horas reduce sofocos 40%.', how: '‚Ä¢ Misma hora siempre\n‚Ä¢ Sin pantallas tras las 21:00\n‚Ä¢ Habitaci√≥n 16-18¬∞C' },
                        { emoji: 'üí™', title: 'Movimiento 30+ min Diario', why: 'Ejercicio es medicina. Reduce sofocos, mejora sue√±o, preserva hueso. Incrementa serotonina.', how: '‚Ä¢ Cardio suave (caminar) 5 d√≠as\n‚Ä¢ Fuerza 2-3 d√≠as\n‚Ä¢ Flexibilidad (yoga) 2-3 d√≠as' },
                        { emoji: 'ü•ó', title: 'Nutrici√≥n Real No Dietas', why: 'Dietas restrictivas empeoran s√≠ntomas. Necesitas nutrientes para neurotransmisores.', how: '‚Ä¢ Prote√≠na CADA comida (30-40g)\n‚Ä¢ Come arco√≠ris\n‚Ä¢ Grasas omega-3' },
                        { emoji: '‚ú®', title: 'Respiraci√≥n Profunda 5 min', why: 'Activa parasimp√°tico (sistema calma). En sofoco: respira y baja 50% intensidad.', how: '‚Ä¢ Inhalaci√≥n 4 segundos\n‚Ä¢ Retenci√≥n 4 segundos\n‚Ä¢ Exhalaci√≥n 6 segundos' },
                        { emoji: 'üíú', title: 'Conexi√≥n Humana', why: 'Aislamiento amplifica ansiedad. Conexi√≥n reduce estr√©s 35%.', how: '‚Ä¢ Busca c√≠rculo de mujeres\n‚Ä¢ Habla sin tab√∫es\n‚Ä¢ Comparte miedos' }
                    ] : [
                        { emoji: 'üåô', title: 'Sleep 7-9 Hours', why: 'Sleep is repair. Your body NEEDS more sleep. Sleeping 7+ hours reduces hot flashes 40%.', how: '‚Ä¢ Same time always\n‚Ä¢ No screens after 9 PM\n‚Ä¢ Room 16-18¬∞C' },
                        { emoji: 'üí™', title: 'Movement 30+ min Daily', why: 'Exercise is medicine. Reduces hot flashes, improves sleep, preserves bone. Increases serotonin.', how: '‚Ä¢ Light cardio (walking) 5 days\n‚Ä¢ Strength 2-3 days\n‚Ä¢ Flexibility (yoga) 2-3 days' },
                        { emoji: 'ü•ó', title: 'Real Nutrition Not Diets', why: 'Restrictive diets worsen symptoms. You need nutrients for neurotransmitters.', how: '‚Ä¢ Protein EVERY meal (30-40g)\n‚Ä¢ Eat the rainbow\n‚Ä¢ Omega-3 fats' },
                        { emoji: '‚ú®', title: 'Deep Breathing 5 min', why: 'Activates parasympathetic (calm system). In hot flash: breathe and reduce intensity 50%.', how: '‚Ä¢ Inhale 4 seconds\n‚Ä¢ Hold 4 seconds\n‚Ä¢ Exhale 6 seconds' },
                        { emoji: 'üíú', title: 'Human Connection', why: 'Isolation amplifies anxiety. Connection reduces stress 35%.', how: '‚Ä¢ Find a circle of women\n‚Ä¢ Talk without taboos\n‚Ä¢ Share fears' }
                    ]
                };
            };

            // CUESTIONARIO
            // FUNCIONES AUTH Y PREMIUM
            const handleLogin = async () => {
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: authData.email,
                        password: authData.password
                    });
                    
                    if (error) {
                        alert('Error: ' + error.message);
                        return;
                    }
                    
                    // Cargar perfil del usuario
                    const { data: profile, error: profileError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', data.user.id)
                        .single();
                    
                    if (profileError) {
                        console.error('Error cargando perfil:', profileError);
                    }
                    
                    setSession(data.session);
                    setCurrentUser(profile || { id: data.user.id, email: data.user.email });
                    setShowAuth(false);
                    
                    // Si no tiene perfil completo, mostrar quiz
                    if (!profile?.profile_name) {
                        setShowQuiz(true);
                    }
                    
                    console.log('‚úÖ Login exitoso con Supabase');
                } catch (err) {
                    console.error('Error login:', err);
                    alert(language === 'es' ? 'Error al iniciar sesi√≥n' : 'Login error');
                }
            };
            
            // RESETEO DE CONTRASE√ëA
            const handlePasswordReset = async () => {
                if (!resetEmail || !resetEmail.includes('@')) {
                    alert(language === 'es' 
                        ? 'Por favor ingresa un email v√°lido' 
                        : 'Please enter a valid email');
                    return;
                }
                
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(resetEmail, {
                        redirectTo: 'https://getlumera.app'
                    });
                    
                    if (error) {
                        alert('Error: ' + error.message);
                        return;
                    }
                    
                    alert(language === 'es'
                        ? '‚úÖ Te hemos enviado un email para resetear tu contrase√±a. Revisa tu bandeja de entrada.'
                        : '‚úÖ We sent you an email to reset your password. Check your inbox.');
                    
                    setShowPasswordReset(false);
                    setResetEmail('');
                } catch (err) {
                    console.error('Error reseteo:', err);
                    alert(language === 'es' 
                        ? 'Error al enviar email de reseteo' 
                        : 'Error sending reset email');
                }
            };
            
            // LOGIN CON GOOGLE
            const handleGoogleLogin = async () => {
                try {
                    const { data, error } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: 'https://getlumera.app'
                        }
                    });
                    
                    if (error) {
                        alert('Error: ' + error.message);
                    }
                } catch (err) {
                    console.error('Error Google login:', err);
                    alert(language === 'es' 
                        ? 'Error al conectar con Google' 
                        : 'Error connecting with Google');
                }
            };
            
            const handleRegister = async () => {
                try {
                    // IMPORTANTE: Primero registrar en Auth (el trigger crear√° el perfil autom√°ticamente)
                    const { data, error } = await supabase.auth.signUp({
                        email: authData.email,
                        password: authData.password
                    });
                    
                    if (error) {
                        // Error espec√≠fico de usuario duplicado
                        if (error.message.includes('already registered')) {
                            alert(language === 'es' 
                                ? 'Este email ya est√° registrado. Intenta iniciar sesi√≥n.' 
                                : 'This email is already registered. Try logging in.');
                            setAuthMode('login');
                            return;
                        }
                        alert('Error: ' + error.message);
                        return;
                    }
                    
                    console.log('‚úÖ Usuario creado en Auth:', data.user.id);
                    
                    // El trigger handle_new_user() ya cre√≥ el perfil en tabla users
                    // Ahora hacer login autom√°tico
                    setSession(data.session);
                    setCurrentUser({ id: data.user.id, email: data.user.email });
                    setShowAuth(false);
                    setShowQuiz(true); // Mostrar quiz para completar perfil
                    
                    console.log('‚úÖ Registro exitoso con Supabase');
                } catch (err) {
                    console.error('Error registro:', err);
                    alert(language === 'es' ? 'Error al registrarse' : 'Registration error');
                }
            };
            
            const handleLogout = async () => {
                await supabase.auth.signOut();
                setSession(null);
                setCurrentUser(null);
                setShowAuth(true);
                setShowQuiz(false);
                console.log('‚úÖ Logout exitoso');
            };
            
            // C√ÅLCULOS NUTRICIONALES
            const calculateBMI = (weight, height) => {
                // weight en kg, height en cm
                if (!weight || !height || weight <= 0 || height <= 0) return null;
                const heightInMeters = height / 100;
                return (weight / (heightInMeters * heightInMeters)).toFixed(2);
            };
            
            const calculateTDEE = (weight, height, age, activityLevel) => {
                // F√≥rmula Mifflin-St Jeor para mujeres
                if (!weight || !height || !age) return null;
                
                // BMR (Basal Metabolic Rate)
                const bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
                
                // Activity multipliers
                const activityMultipliers = {
                    'sedentary': 1.2,      // Poco o ning√∫n ejercicio
                    'light': 1.375,        // Ejercicio ligero 1-3 d√≠as/semana
                    'moderate': 1.55,      // Ejercicio moderado 3-5 d√≠as/semana
                    'active': 1.725,       // Ejercicio intenso 6-7 d√≠as/semana
                    'very_active': 1.9     // Ejercicio muy intenso, trabajo f√≠sico
                };
                
                const multiplier = activityMultipliers[activityLevel] || 1.55;
                return Math.round(bmr * multiplier);
            };
            
            const getBMICategory = (bmi, lang = 'es') => {
                if (!bmi) return null;
                const categories = {
                    es: {
                        underweight: 'Bajo peso',
                        normal: 'Peso normal',
                        overweight: 'Sobrepeso',
                        obese: 'Obesidad'
                    },
                    en: {
                        underweight: 'Underweight',
                        normal: 'Normal weight',
                        overweight: 'Overweight',
                        obese: 'Obese'
                    }
                };
                
                const lang_categories = categories[lang] || categories['es'];
                
                if (bmi < 18.5) return lang_categories.underweight;
                if (bmi < 25) return lang_categories.normal;
                if (bmi < 30) return lang_categories.overweight;
                return lang_categories.obese;
            };
            
            const updateUserMetrics = async (userId, weight, height, age, activityLevel) => {
                const bmi = calculateBMI(weight, height);
                const tdee = calculateTDEE(weight, height, age, activityLevel);
                
                console.log('üìä Calculando m√©tricas:', { weight, height, age, activityLevel, bmi, tdee });
                
                const { error } = await supabase
                    .from('users')
                    .update({
                        weight: parseFloat(weight),
                        height: parseInt(height),
                        activity_level: activityLevel,
                        bmi: parseFloat(bmi),
                        tdee: parseInt(tdee)
                    })
                    .eq('id', userId);
                
                if (error) {
                    console.error('‚ùå Error actualizando m√©tricas:', error);
                    return false;
                }
                
                console.log('‚úÖ M√©tricas actualizadas:', { bmi, tdee });
                return { bmi, tdee };
            };

            const getMetrics = () => {
                if (!currentUser) return null;
                const { weight, height, age, activity_level, goal, bmi, bmr, tdee, target_calories } = currentUser;
                if (!weight || !height || !age) return null;

                // Usar valores calculados por BD si existen, sino calcular en frontend
                const bmiVal = bmi || calculateBMI(weight, height);
                const bmrVal = bmr || Math.round((10 * weight) + (6.25 * height) - (5 * age) - 161);
                const tdeeVal = tdee || calculateTDEE(weight, height, age, activity_level || 'moderate');
                const adjustments = { lose: -500, maintain: 0, gain: 300 };
                const targetVal = target_calories || (tdeeVal + (adjustments[goal || 'maintain'] || 0));

                return { 
                    bmi: bmiVal, 
                    bmr: bmrVal, 
                    tdee: tdeeVal, 
                    target: targetVal 
                };
            };

            const saveMetabolicProfile = async () => {
                if (!session?.user?.id) {
                    alert(language === 'es' ? 'Error: no hay sesi√≥n activa' : 'Error: no active session');
                    return;
                }

                const weight = parseFloat(editWeight);
                const height = parseFloat(editHeight);
                const age = parseInt(editAge);

                if (!weight || !height || !age || weight <= 0 || height <= 0 || age <= 0) {
                    alert(language === 'es' ? 'Por favor completa todos los campos correctamente' : 'Please complete all fields correctly');
                    return;
                }

                try {
                    // El trigger de BD calcula BMI/BMR/TDEE autom√°ticamente
                    const { data, error } = await supabase
                        .from('users')
                        .update({
                            weight,
                            height,
                            age,
                            activity_level: editActivityLevel,
                            goal: editGoal,
                            weight_goal: editGoal
                        })
                        .eq('id', session.user.id)
                        .select()
                        .single();

                    if (error) throw error;

                    // Actualizar estado local con los valores que devuelve la BD (incluyendo BMI/TDEE calculados)
                    setCurrentUser(data);
                    setShowProfileModal(false);
                    alert(language === 'es' ? '‚úÖ Perfil actualizado' : '‚úÖ Profile updated');
                } catch (error) {
                    console.error('Error saving profile:', error.message);
                    alert((language === 'es' ? 'Error: ' : 'Error: ') + error.message);
                }
            };

            // GENERAR DATOS PARA GR√ÅFICOS
            const generateChartData = () => {
                if (!symptoms || symptoms.length === 0) return null;
                
                const last7Days = symptoms
                    .sort((a, b) => new Date(b.symptom_date) - new Date(a.symptom_date))
                    .slice(0, 7)
                    .reverse();
                
                if (last7Days.length === 0) return null;
                
                return {
                    labels: last7Days.map(s => {
                        const date = new Date(s.symptom_date);
                        return date.toLocaleDateString(language === 'es' ? 'es-ES' : 'en-US', { 
                            weekday: 'short', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    }),
                    energy: last7Days.map(s => s.energy || 5),
                    sleep: last7Days.map(s => s.sleep || 5),
                    mood: last7Days.map(s => s.mood || 5),
                    anxiety: last7Days.map(s => s.anxiety || 0),
                    hotFlashes: last7Days.map(s => s.hot_flashes || 0)
                };
            };

            // EJERCICIOS PERSONALIZADOS - Llama a Edge Function (solo Premium)
            const fetchPersonalizedExercises = async () => {
                // Trial y premium tienen acceso a ejercicios din√°micos; solo 'free' queda bloqueado
                if (getUserTier() === 'free') return;
                if (loadingExercises) return;
                
                setLoadingExercises(true);
                
                try {
                    const recentSymptoms = symptoms.slice(0, 7);
                    
                    const response = await fetch('https://pyekwpmbdnmglrjieexc.supabase.co/functions/v1/generate-exercises', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
                        },
                        body: JSON.stringify({
                            user_id: currentUser?.id,
                            symptoms: recentSymptoms,
                            health_conditions: currentUser?.health_conditions || [],
                            activity_level: currentUser?.activity_level || 'moderate',
                            goal: exerciseGoal,
                            language: language
                        })
                    });
                    
                    if (!response.ok) throw new Error('Error ' + response.status);
                    
                    const data = await response.json();
                    
                    if (data.exercises && data.exercises.length > 0) {
                        setAiExercises(data.exercises);
                    } else {
                        throw new Error('Sin datos');
                    }
                } catch (error) {
                    console.error('Error fetching exercises:', error);
                    // Mostrar ejercicios personalizados locales si falla la Edge Function
                    const fallback = getExercises().slice(0, 3).map(ex => ({
                        ...ex,
                        why: (ex.why || '') + (language === 'es' ? ' Adaptado a tu perfil.' : ' Adapted to your profile.')
                    }));
                    setAiExercises(fallback.length > 0 ? fallback : null);
                    if (fallback.length === 0) {
                        alert(language === 'es' ? 'No se pudo generar la rutina. Intenta m√°s tarde.' : 'Could not generate routine. Try again later.');
                    }
                } finally {
                    setLoadingExercises(false);
                }
            };

            // COOKING TIPS IA - Llama a Edge Function
            const fetchCookingTips = async (recipe) => {
                const tier = getUserTier();
                if (tier === 'free') return; // Solo trial y premium
                
                const recipeKey = recipe.name;
                if (aiCookingTips[recipeKey] || loadingTips[recipeKey]) return; // Ya tiene tips o est√° cargando
                
                setLoadingTips(prev => ({ ...prev, [recipeKey]: true }));
                
                try {
                    const ingredients = (recipe.ingredients || []).map(ing => ing.name || ing).filter(Boolean);
                    
                    const response = await fetch(`https://pyekwpmbdnmglrjieexc.supabase.co/functions/v1/cooking-tips`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({
                            recipe_name: recipe.name,
                            ingredients: ingredients,
                            language: language
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.tips && data.tips.length > 0) {
                        setAiCookingTips(prev => ({ ...prev, [recipeKey]: data.tips }));
                    }
                } catch (error) {
                    console.error('Error fetching cooking tips:', error);
                } finally {
                    setLoadingTips(prev => ({ ...prev, [recipeKey]: false }));
                }
            };

            
            // SISTEMA DE TRIAL 7 D√çAS
            const isPremium = () => {
                if (!currentUser) return false;
                
                // Usuario con suscripci√≥n activa
                if (currentUser.subscription_status === 'active') return true;
                
                // Usuario en trial (7 d√≠as desde registro)
                if (currentUser.created_at) {
                    const createdDate = new Date(currentUser.created_at);
                    const now = new Date();
                    const daysSinceCreation = (now - createdDate) / (1000 * 60 * 60 * 24);
                    
                    // Si tiene menos de 3 d√≠as (trial) y no ha cancelado
                    if (daysSinceCreation <= 3 && currentUser.trial_active !== false) {
                        return true;
                    }
                }
                
                return false;
            };
            
            // Calcular d√≠as restantes de trial
            const getTrialDaysLeft = () => {
                if (!currentUser?.created_at) return 0;
                const createdDate = new Date(currentUser.created_at);
                const now = new Date();
                const daysPassed = (now - createdDate) / (1000 * 60 * 60 * 24);
                const daysLeft = Math.max(0, Math.ceil(3 - daysPassed));
                return daysLeft;
            };

            // NIVELES DE USUARIO: 'trial' | 'free' | 'premium'
            // trial = dentro de los 3 d√≠as desde el registro
            // free = m√°s de 3 d√≠as sin suscripci√≥n activa
            // premium = suscripci√≥n activa
            const getUserTier = () => {
                console.log('üîç getUserTier - currentUser:', currentUser);
                console.log('üîç subscription_status:', currentUser?.subscription_status);
                
                if (!currentUser) return 'free';
                if (currentUser.subscription_status === 'active') return 'premium';
                if (getTrialDaysLeft() > 0) return 'trial';
                return 'free';
            };

            // useEffect para generar datos cuando cambien s√≠ntomas
            React.useEffect(() => {
                if (getUserTier() === 'premium' && symptoms.length > 0) {
                    setChartData(generateChartData());
                }
            }, [symptoms, language]);

            // Mostrar bienvenida Premium solo primera vez
            React.useEffect(() => {
                if (getUserTier() === 'premium' && currentUser) {
                    const hasSeenWelcome = localStorage.getItem(`premium_welcome_${currentUser.id}`);
                    if (!hasSeenWelcome) {
                        setShowWelcomePremium(true);
                        localStorage.setItem(`premium_welcome_${currentUser.id}`, 'true');
                    }
                }
            }, [currentUser]);

            // Auto-disparar patr√≥n en d√≠a 3 del trial (movido aqu√≠ desde renderPremiumDashboard)
            React.useEffect(() => {
                const trialDaysLeft = getTrialDaysLeft();
                const isInTrial = !currentUser?.subscription_status || currentUser?.subscription_status !== 'active';
                const isTrialDay3 = isInTrial && trialDaysLeft <= 1;
                if (isTrialDay3 && symptoms.length >= 3 && !patternShown) {
                    const result = analyzePatterns(symptoms);
                    if (result && result.length > 0) {
                        setPatternResult(result);
                        setTimeout(() => {
                            setShowPatternModal(true);
                            setPatternShown(true);
                        }, 1500);
                    }
                }
            // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [currentUser, symptoms]);

            // C√ÅLCULOS METAB√ìLICOS


            // Obtiene el d√≠a de la semana est√°tico basado en la semana del a√±o
            // As√≠ en free el men√∫ cambia una vez por semana, no cada d√≠a
            const getStaticWeeklyDay = () => {
                const today = new Date();
                const startOfYear = new Date(today.getFullYear(), 0, 1);
                const weekNumber = Math.floor(((today - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
                const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
                return days[weekNumber % 7];
            };
            
            const getRegion = () => {
                // Primero intentar usar la regi√≥n del usuario si est√° logueado
                if (currentUser && currentUser.region) {
                    console.log('‚úÖ Regi√≥n del usuario:', currentUser.region);
                    return currentUser.region.toLowerCase(); // FORZAR MIN√öSCULAS
                }
                
                // Si no hay usuario logueado, detectar por timezone
                const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                console.log('üåç Timezone detectado:', tz);
                
                // LATAM: Am√©rica Latina (excepto USA/Canad√°)
                if (tz.includes('America/') && 
                    !tz.includes('America/New_York') && 
                    !tz.includes('America/Chicago') && 
                    !tz.includes('America/Los_Angeles') &&
                    !tz.includes('America/Toronto') &&
                    !tz.includes('America/Vancouver')) {
                    console.log('‚úÖ Regi√≥n: LATAM');
                    return 'latam';
                }
                
                // USA/Canad√°
                if (tz.includes('America/New_York') || 
                    tz.includes('America/Chicago') || 
                    tz.includes('America/Los_Angeles') ||
                    tz.includes('America/Toronto') ||
                    tz.includes('America/Vancouver') ||
                    tz.includes('US/')) {
                    console.log('‚úÖ Regi√≥n: USA');
                    return 'usa';
                }
                
                // Europa, Medio Oriente, √Åfrica
                if (tz.includes('Europe') || tz.includes('Africa') || tz.includes('Asia')) {
                    console.log('‚úÖ Regi√≥n: EMEA');
                    return 'emea';
                }
                
                // Default LATAM si no detecta
                console.log('‚ö†Ô∏è No detectado, default: LATAM');
                return 'latam';
            };
            
            // STRIPE REAL - PRODUCCI√ìN
            // CANCELAR SUSCRIPCI√ìN - Abre portal de cliente Lemon Squeezy
            const handleCancelSubscription = async () => {
                const confirmed = window.confirm(
                    language === 'es'
                        ? '¬øSegura que quieres cancelar? Mantendr√°s acceso premium hasta el final de tu per√≠odo de facturaci√≥n.'
                        : 'Are you sure you want to cancel? You will keep premium access until the end of your billing period.'
                );
                if (!confirmed) return;

                // Si tenemos subscription_id del usuario, podemos intentar abrir el portal directo
                // Si no, redirigimos al soporte con email prellenado
                const email = currentUser?.email || '';
                const subscriptionId = currentUser?.subscription_id || '';

                if (subscriptionId) {
                    // Lemon Squeezy customer portal (si tienes customer_portal_url guardada en el usuario)
                    const portalUrl = currentUser?.customer_portal_url;
                    if (portalUrl) {
                        window.open(portalUrl, '_blank');
                    } else {
                        // Fallback: email de soporte con info prellenada
                        window.open(`mailto:support@lumera.app?subject=${encodeURIComponent('Cancelar suscripci√≥n')}&body=${encodeURIComponent(`Hola, quiero cancelar mi suscripci√≥n.\n\nEmail: ${email}\nID suscripci√≥n: ${subscriptionId}`)}`, '_blank');
                    }
                } else {
                    // Sin subscription_id, abrir email de soporte
                    window.open(`mailto:support@lumera.app?subject=${encodeURIComponent(language === 'es' ? 'Cancelar suscripci√≥n' : 'Cancel subscription')}&body=${encodeURIComponent(language === 'es' ? `Hola, quiero cancelar mi suscripci√≥n.\n\nEmail: ${email}` : `Hi, I want to cancel my subscription.\n\nEmail: ${email}`)}`, '_blank');
                }
            };

            const handleSubscribe = async (planType = 'monthly') => {
                if (!currentUser) { 
                    alert(language === 'es' ? 'Inicia sesi√≥n primero' : 'Please log in first'); 
                    return; 
                }
                
                console.log('üí≥ Plan seleccionado:', planType);
                console.log('üåç Regi√≥n detectada:', userRegion);
                
                // Obtener el UUID correcto seg√∫n el plan y regi√≥n
                const variantId = planType === 'annual' ? PRICES[userRegion].annualVariantId : PRICES[userRegion].monthlyVariantId;
                
                console.log('üéØ Variant UUID:', variantId);
                
                // Construir checkout URL de Lemon Squeezy
                const checkoutUrl = `https://getlumera.lemonsqueezy.com/checkout/buy/${variantId}`;
                
                // A√±adir par√°metros: email del usuario y user_id para el webhook
                const urlWithParams = `${checkoutUrl}?checkout[email]=${encodeURIComponent(currentUser.email)}&checkout[custom][user_id]=${currentUser.id}&checkout[custom][plan_type]=${planType}`;
                
                console.log('üöÄ Redirigiendo a Lemon Squeezy checkout...');
                
                // Redirigir a Lemon Squeezy checkout
                window.location.href = urlWithParams;
            };

            const renderQuiz = () => {
                if (quizStep === 1) {
                    return (
                        <div className="min-h-screen bg-gradient-to-br from-amber-50 via-rose-50 to-amber-50 flex items-center justify-center p-4" style={{backgroundImage: "url('data:image/svg+xml,%3Csvg width=\"120\" height=\"120\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 120 120\"%3E%3Cg opacity=\"0.12\"%3E%3Cpath d=\"M60 85 Q50 75, 45 60 Q50 50, 60 55 Q65 60, 60 85\" fill=\"%23fb7185\" /%3E%3Cpath d=\"M60 55 Q55 45, 52 35 Q58 28, 65 35 Q68 45, 60 55\" fill=\"%23fcd34d\" /%3E%3Cpath d=\"M65 35 Q70 25, 75 18 Q82 20, 80 30 Q75 40, 65 35\" fill=\"%23fb7185\" /%3E%3Cpath d=\"M80 30 Q88 22, 95 18 Q100 25, 95 35 Q88 40, 80 30\" fill=\"%23fed7aa\" /%3E%3Ccircle cx=\"68\" cy=\"45\" r=\"4\" fill=\"%23fcd34d\" opacity=\"0.6\"/%3E%3C/g%3E%3C/svg%3E')", backgroundSize: '150px 150px'}}>
                            <div className="bg-white/80 rounded-3xl shadow-xl p-10 max-w-3xl w-full">
                                <div className="flex justify-end mb-6">
                                    <select value={language} onChange={(e) => setLanguage(e.target.value)} className="px-4 py-2 rounded-lg border border-gray-300 font-semibold text-sm bg-white focus:outline-none focus:ring-2 focus:ring-amber-300">
                                        <option value="es">üá™üá∏ Espa√±ol</option>
                                        <option value="en">üá¨üáß English</option>
                                    </select>
                                </div>

                                <div className="text-center mb-8">
                                    <h1 className="text-5xl font-light gradient-text mb-4">‚ú® Lumera</h1>
                                    <p className="text-2xl font-light text-gray-700 mb-4">{language === 'es' ? 'Tu Compa√±era Personalizada' : 'Your Personalized Companion'}</p>
                                    <p className="text-base text-gray-600 leading-relaxed max-w-2xl mx-auto">
                                        {language === 'es' 
                                            ? 'Entre los 40 y 55 a√±os, tu cuerpo vive una transformaci√≥n profunda. Cada cambio es natural, cada s√≠ntoma v√°lido. Tu transformaci√≥n es un acto de gracia y fortaleza que merece ser acompa√±ado.'
                                            : 'Between 40 and 55, your body undergoes a profound transformation. Every change is natural, every symptom is valid. Your transformation is an act of grace and strength that deserves to be supported.'}
                                    </p>
                                </div>

                                <div className="bg-amber-50/70 rounded-2xl p-8 space-y-4 border border-purple-100 mb-8">
                                    <h3 className="font-bold text-lg text-rose-900 mb-4">{language === 'es' ? 'üíú Conoce a LUMI - Tu Coach Personal' : 'üíú Meet LUMI - Your Personal Coach'}</h3>
                                    <p className="text-sm text-gray-700 mb-4">
                                        {language === 'es' 
                                            ? 'No es un chatbot. LUMI te conoce, recuerda c√≥mo dormiste, y ajusta tus planes cada d√≠a seg√∫n c√≥mo te sientes.'
                                            : 'Not a chatbot. LUMI knows you, remembers how you slept, and adjusts your plans every day based on how you feel.'}
                                    </p>
                                    <div className="grid md:grid-cols-2 gap-3 text-sm text-gray-700">
                                        <p className="flex items-start gap-2">
                                            <span className="text-purple-600 mt-0.5">üß†</span>
                                            <span><strong>{language === 'es' ? 'Recuerda tu contexto' : 'Remembers your context'}:</strong> {language === 'es' ? 'S√≠ntomas, objetivos, qu√© te funciona' : 'Symptoms, goals, what works for you'}</span>
                                        </p>
                                        <p className="flex items-start gap-2">
                                            <span className="text-purple-600 mt-0.5">üîÑ</span>
                                            <span><strong>{language === 'es' ? 'Planes adaptativos' : 'Adaptive plans'}:</strong> {language === 'es' ? 'Sofocos anoche ‚Üí Recetas antiinflamatorias hoy' : 'Hot flashes last night ‚Üí Anti-inflammatory recipes today'}</span>
                                        </p>
                                        <p className="flex items-start gap-2">
                                            <span className="text-purple-600 mt-0.5">üçΩÔ∏è</span>
                                            <span><strong>{language === 'es' ? 'Men√∫s personalizados' : 'Personalized menus'}:</strong> {language === 'es' ? 'Recetas adaptadas a tus necesidades' : 'Recipes adapted to your needs'}</span>
                                        </p>
                                        <p className="flex items-start gap-2">
                                            <span className="text-purple-600 mt-0.5">üí™</span>
                                            <span><strong>{language === 'es' ? 'Ejercicios por energ√≠a' : 'Exercise by energy'}:</strong> {language === 'es' ? 'Seg√∫n c√≥mo amaneciste' : 'Based on how you woke up'}</span>
                                        </p>
                                        <p className="flex items-start gap-2">
                                            <span className="text-purple-600 mt-0.5">üìä</span>
                                            <span><strong>{language === 'es' ? 'Insights reales' : 'Real insights'}:</strong> {language === 'es' ? 'Descubre qu√© afecta tus s√≠ntomas' : 'Discover what affects your symptoms'}</span>
                                        </p>
                                        <p className="flex items-start gap-2">
                                            <span className="text-purple-600 mt-0.5">üî¨</span>
                                            <span><strong>{language === 'es' ? 'Con evidencia' : 'Evidence-based'}:</strong> {language === 'es' ? 'Cada recomendaci√≥n respaldada' : 'Every recommendation backed'}</span>
                                        </p>
                                    </div>
                                </div>

                                <button onClick={() => setQuizStep(2)} className="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-white py-4 rounded-xl font-semibold hover:shadow-lg text-lg transition">
                                    {language === 'es' ? 'Comencemos' : "Let's begin"} ‚Üí
                                </button>
                            </div>
                        </div>
                    );
                }

                if (quizStep === 2) {
                    return (
                        <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-purple-100 to-pink-100'} flex items-center justify-center p-4`}>
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-6 md:p-12 max-w-2xl w-full`}>
                                <h2 className="text-2xl md:text-3xl font-light gradient-text mb-6 text-center">{language === 'es' ? 'Tu Perfil' : 'Your Profile'}</h2>
                                
                                <div className="space-y-4 mb-6">
                                    <input type="text" placeholder={language === 'es' ? 'Tu nombre' : 'Your name'} 
                                        value={formData.profileName}
                                        onChange={(e) => setFormData({...formData, profileName: e.target.value})}
                                        className={`w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-400 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : ''}`}/>
                                    
                                    <div className="grid grid-cols-3 gap-3">
                                        <input type="number" placeholder={language === 'es' ? 'Edad' : 'Age'} 
                                            value={formData.age}
                                            onChange={(e) => setFormData({...formData, age: e.target.value})}
                                            className={`px-4 py-3 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}/>
                                        <input type="number" placeholder={language === 'es' ? 'Altura (cm)' : 'Height (cm)'} 
                                            value={formData.height}
                                            onChange={(e) => setFormData({...formData, height: e.target.value})}
                                            className={`px-4 py-3 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}/>
                                        <input type="number" placeholder={language === 'es' ? 'Peso (kg)' : 'Weight (kg)'} 
                                            value={formData.weight}
                                            onChange={(e) => setFormData({...formData, weight: e.target.value})}
                                            className={`px-4 py-3 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}/>
                                    </div>
                                    
                                    {/* NIVEL DE ACTIVIDAD F√çSICA */}
                                    <div className="mt-6">
                                        <label className={`block text-sm font-semibold mb-3 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
                                            {language === 'es' ? 'üí™ Nivel de Actividad F√≠sica' : 'üí™ Physical Activity Level'}
                                        </label>
                                        <select 
                                            value={formData.activity_level}
                                            onChange={(e) => setFormData({...formData, activity_level: e.target.value})}
                                            className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-rose-400 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                        >
                                            <option value="sedentary">{language === 'es' ? 'Sedentario (poco o ning√∫n ejercicio)' : 'Sedentary (little to no exercise)'}</option>
                                            <option value="light">{language === 'es' ? 'Ligero (ejercicio 1-3 d√≠as/semana)' : 'Light (exercise 1-3 days/week)'}</option>
                                            <option value="moderate">{language === 'es' ? 'Moderado (ejercicio 3-5 d√≠as/semana)' : 'Moderate (exercise 3-5 days/week)'}</option>
                                            <option value="active">{language === 'es' ? 'Activo (ejercicio 6-7 d√≠as/semana)' : 'Active (exercise 6-7 days/week)'}</option>
                                            <option value="very_active">{language === 'es' ? 'Muy activo (ejercicio intenso diario + trabajo f√≠sico)' : 'Very active (intense daily exercise + physical job)'}</option>
                                        </select>
                                        <p className={`text-xs mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                            {language === 'es' 
                                                ? 'Esto nos ayuda a calcular tus necesidades cal√≥ricas diarias' 
                                                : 'This helps us calculate your daily caloric needs'}
                                        </p>
                                    </div>
                                </div>

                                <button onClick={() => setQuizStep(3)} className="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition">
                                    {language === 'es' ? 'Siguiente' : 'Next'} ‚Üí
                                </button>
                            </div>
                        </div>
                    );
                }

                if (quizStep === 3) {
                    const conditions = language === 'es' 
                        ? ['Diabetes', 'Hipertensi√≥n', 'Sin gluten', 'Sin lactosa', 'Vegetariana', 'Vegana', 'Artritis', 'Ansiedad']
                        : ['Diabetes', 'Hypertension', 'Gluten-free', 'Lactose-free', 'Vegetarian', 'Vegan', 'Arthritis', 'Anxiety'];
                    
                    return (
                        <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-purple-100 to-pink-100'} flex items-center justify-center p-4`}>
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-6 md:p-12 max-w-2xl w-full`}>
                                <h2 className="text-2xl md:text-3xl font-light gradient-text mb-6 text-center">{language === 'es' ? 'Restricciones' : 'Restrictions'}</h2>
                                
                                <div className="grid grid-cols-2 gap-3 mb-8">
                                    {conditions.map((cond, idx) => (
                                        <label key={idx} className={`flex items-center justify-center p-3 md:p-4 border rounded-lg cursor-pointer transition min-h-[60px] ${
                                            formData.conditions.includes(cond)
                                                ? darkMode ? 'bg-rose-900 border-rose-400' : 'bg-orange-50 border-rose-400'
                                                : darkMode ? 'border-gray-600' : 'border-gray-300'
                                        }`}>
                                            <input type="checkbox" 
                                                checked={formData.conditions.includes(cond)}
                                                onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setFormData({...formData, conditions: [...formData.conditions, cond]});
                                                    } else {
                                                        setFormData({...formData, conditions: formData.conditions.filter(c => c !== cond)});
                                                    }
                                                }}
                                                className="mr-2 md:mr-3 w-5 h-5 flex-shrink-0"/>
                                            <span className="text-sm md:text-base text-center leading-tight">{cond}</span>
                                        </label>
                                    ))}
                                </div>

                                <button onClick={() => setQuizStep(4)} className="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition">
                                    {language === 'es' ? 'Siguiente' : 'Next'} ‚Üí
                                </button>
                            </div>
                        </div>
                    );
                }

                if (quizStep === 4) {
                    const goals = [
                        { value: 'strength', label: language === 'es' ? 'Ganar Fuerza' : 'Build Strength' },
                        { value: 'weightLoss', label: language === 'es' ? 'Perder Peso' : 'Lose Weight' },
                        { value: 'hormonal', label: language === 'es' ? 'Equilibrio Hormonal' : 'Hormonal Balance' }
                    ];

                    return (
                        <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-purple-100 to-pink-100'} flex items-center justify-center p-4`}>
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-12 max-w-2xl w-full`}>
                                <h2 className="text-3xl font-light gradient-text mb-8">{language === 'es' ? '¬øCu√°l es tu objetivo?' : 'What\'s Your Goal?'}</h2>
                                
                                <div className="space-y-4 mb-8">
                                    {goals.map((goal) => (
                                        <label key={goal.value} className={`flex items-center p-6 border-2 rounded-xl cursor-pointer transition ${
                                            exerciseGoal === goal.value
                                                ? darkMode ? 'bg-rose-900 border-rose-400' : 'bg-orange-50 border-rose-400'
                                                : darkMode ? 'border-gray-600' : 'border-gray-300'
                                        }`}>
                                            <input type="radio" name="goal" value={goal.value}
                                                checked={exerciseGoal === goal.value}
                                                onChange={(e) => setExerciseGoal(e.target.value)}
                                                className="mr-4 w-5 h-5"/>
                                            <span className="font-semibold text-lg">{goal.label}</span>
                                        </label>
                                    ))}
                                </div>

                                <button onClick={() => setQuizStep(5)} className="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-white py-3 rounded-lg font-semibold hover:shadow-lg">
                                    {language === 'es' ? 'Siguiente' : 'Next'} ‚Üí
                                </button>
                            </div>
                        </div>
                    );
                }

                if (quizStep === 5) {
                    const regions = [
                        { value: 'latam', label: language === 'es' ? 'üåé Latinoam√©rica' : 'üåé Latin America' },
                        { value: 'emea', label: language === 'es' ? 'üåç Europa / √Åfrica' : 'üåç Europe / Africa' },
                        { value: 'usa', label: language === 'es' ? 'üåé USA / Canad√°' : 'üåé USA / Canada' }
                    ];

                    return (
                        <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-purple-100 to-pink-100'} flex items-center justify-center p-4`}>
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-12 max-w-2xl w-full`}>
                                <h2 className="text-3xl font-light gradient-text mb-4">{language === 'es' ? '¬øD√≥nde est√°s?' : 'Where are you?'}</h2>
                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-8`}>
                                    {language === 'es' 
                                        ? 'Esto nos ayuda a personalizar ingredientes locales seg√∫n tu regi√≥n'
                                        : 'This helps us personalize local ingredients for your region'}
                                </p>
                                
                                <div className="space-y-4 mb-8">
                                    {regions.map((region) => (
                                        <label key={region.value} className={`flex items-center p-6 border-2 rounded-xl cursor-pointer transition ${
                                            userRegion === region.value
                                                ? darkMode ? 'bg-rose-900 border-rose-400' : 'bg-orange-50 border-rose-400'
                                                : darkMode ? 'border-gray-600' : 'border-gray-300'
                                        }`}>
                                            <input type="radio" name="region" value={region.value}
                                                checked={userRegion === region.value}
                                                onChange={(e) => setUserRegion(e.target.value)}
                                                className="mr-4 w-5 h-5"/>
                                            <span className="font-semibold text-lg">{region.label}</span>
                                        </label>
                                    ))}
                                </div>

                                <button onClick={async () => {
                                    if (!formData.profileName || !formData.age || !formData.height || !formData.weight) {
                                        alert(language === 'es' ? 'Completa todos los campos' : 'Complete all fields');
                                        return;
                                    }
                                    
                                    if (!session) {
                                        alert(language === 'es' ? 'Error: No hay sesi√≥n activa. Por favor recarga la p√°gina.' : 'Error: No active session. Please reload the page.');
                                        return;
                                    }
                                    
                                    // Calcular IMC y TDEE usando las funciones
                                    const bmi = calculateBMI(formData.weight, formData.height);
                                    const tdee = calculateTDEE(formData.weight, formData.height, formData.age, formData.activity_level);
                                    
                                    console.log('üìä M√©tricas calculadas:', { bmi, tdee, activity: formData.activity_level });
                                    
                                    // GUARDAR EN SUPABASE
                                    const profileData = {
                                        profile_name: formData.profileName,
                                        age: parseInt(formData.age),
                                        height: parseFloat(formData.height),
                                        weight: parseFloat(formData.weight),
                                        activity_level: formData.activity_level,
                                        bmi: parseFloat(bmi),
                                        tdee: parseInt(tdee),
                                        health_conditions: formData.conditions,
                                        goal: exerciseGoal,
                                        region: userRegion,
                                        updated_at: new Date().toISOString()
                                    };
                                    
                                    const { data: updatedProfile, error } = await supabase
                                        .from('users')
                                        .update(profileData)
                                        .eq('id', session.user.id)
                                        .select()
                                        .single();
                                    
                                    if (error) {
                                        console.error('Error guardando perfil:', error);
                                        alert(language === 'es' ? 'Error al guardar perfil' : 'Error saving profile');
                                        return;
                                    }
                                    
                                    console.log('‚úÖ Perfil guardado en Supabase:', updatedProfile);
                                    setCurrentUser({
                                        ...updatedProfile,
                                        bmi: parseFloat(bmi),
                                        tdee: parseInt(tdee)
                                    });
                                    setShowQuiz(false);
                                    setCurrentPage('home');
                                }} className="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-white py-3 rounded-lg font-semibold hover:shadow-lg">
                                    {language === 'es' ? '¬°Comenzar!' : 'Let\'s Go!'} ‚ú®
                                </button>
                            </div>
                        </div>
                    );
                }
            };

            // LUMI - MENSAJES PERSONALIZADOS
            const getLumiMessage = (page = 'home') => {
                if (!currentUser) return null;
                
                const userName = currentUser.profile_name;
                const todaySymptoms = symptoms.length > 0 ? symptoms[symptoms.length - 1] : null;
                const yesterdaySymptoms = symptoms.length > 1 ? symptoms[symptoms.length - 2] : null;
                
                // Analizar s√≠ntomas de hoy
                const hasLowSleep = todaySymptoms && todaySymptoms.sleep <= 3;
                const hasLowEnergy = todaySymptoms && todaySymptoms.energy <= 3;
                const hasHighHotFlashes = todaySymptoms && todaySymptoms.hotFlashes >= 4;
                const hasLowMood = todaySymptoms && todaySymptoms.mood <= 3;
                
                // Mensajes seg√∫n contexto
                const messages = {
                    es: {
                        home: {
                            lowSleep: `Hola ${userName}, veo que dormiste poco. Este men√∫ te dar√° energ√≠a estable sin sobrecargar tu cuerpo.`,
                            lowEnergy: `${userName}, tu energ√≠a est√° baja hoy. Los men√∫s de hoy te ayudar√°n a recuperarla sin forzarte.`,
                            highHotFlashes: `${userName}, tus sofocos est√°n intensos. El men√∫ de hoy tiene alimentos que pueden ayudar a calmarlos.`,
                            lowMood: `${userName}, s√© que hoy es dif√≠cil. Este men√∫ est√° pensado para ayudar a tu √°nimo desde dentro.`,
                            default: `Hoy es un buen d√≠a para escuchar a tu cuerpo, ${userName}. No tienes que hacerlo perfecto. Solo empezar.`
                        },
                        nutrition: {
                            lowSleep: `Veo que dormiste poco, ${userName}. Este men√∫ tiene magnesio y tript√≥fano que pueden ayudarte a descansar mejor esta noche.`,
                            highHotFlashes: `${userName}, estos men√∫s tienen ingredientes que muchas mujeres reportan que les ayudan con los sofocos.`,
                            default: `${userName}, cada comida es una oportunidad de darle a tu cuerpo lo que necesita en este momento.`
                        },
                        exercise: {
                            lowEnergy: `${userName}, hoy empieza suave. El movimiento ligero puede darte m√°s energ√≠a de la que imaginas.`,
                            lowMood: `${userName}, el ejercicio puede ayudar con el √°nimo. Empieza con 10 minutos y ve c√≥mo te sientes.`,
                            default: `${userName}, tu cuerpo quiere moverse. Solo necesita que lo escuches y empieces despacio.`
                        }
                    },
                    en: {
                        home: {
                            lowSleep: `Hi ${userName}, I see you didn't sleep well. Today's menu will give you stable energy without overwhelming your body.`,
                            lowEnergy: `${userName}, your energy is low today. Today's menus will help you recover it without forcing yourself.`,
                            highHotFlashes: `${userName}, your hot flashes are intense. Today's menu has foods that may help calm them.`,
                            lowMood: `${userName}, I know today is tough. This menu is designed to help your mood from within.`,
                            default: `Today is a good day to listen to your body, ${userName}. You do not have to do it perfectly. Just start.`
                        },
                        nutrition: {
                            lowSleep: `I see you didn't sleep well, ${userName}. This menu has magnesium and tryptophan that may help you rest better tonight.`,
                            highHotFlashes: `${userName}, these menus have ingredients that many women report help with hot flashes.`,
                            default: `${userName}, every meal is an opportunity to give your body what it needs right now.`
                        },
                        exercise: {
                            lowEnergy: `${userName}, start gentle today. Light movement can give you more energy than you imagine.`,
                            lowMood: `${userName}, exercise can help with mood. Start with 10 minutes and see how you feel.`,
                            default: `${userName}, your body wants to move. It just needs you to listen and start slowly.`
                        }
                    }
                };
                
                const lang = language === 'es' ? 'es' : 'en';
                const pageMessages = messages[lang][page] || messages[lang].home;
                
                // En free: solo mensaje gen√©rico, sin revelar an√°lisis de s√≠ntomas
                if (getUserTier() === 'free') return pageMessages.default;

                // TRIAL y PREMIUM: priorizar mensajes seg√∫n s√≠ntomas
                if (hasLowSleep && pageMessages.lowSleep) return pageMessages.lowSleep;
                if (hasHighHotFlashes && pageMessages.highHotFlashes) return pageMessages.highHotFlashes;
                if (hasLowEnergy && pageMessages.lowEnergy) return pageMessages.lowEnergy;
                if (hasLowMood && pageMessages.lowMood) return pageMessages.lowMood;
                
                return pageMessages.default;
            };

            // AN√ÅLISIS DE PATRONES REAL (se ejecuta cuando hay 3+ s√≠ntomas registrados)
            const analyzePatterns = (data = null) => {
                const syms = data || symptoms;
                if (syms.length < 3) return null;
                
                const keys = ['sleep', 'energy', 'mood', 'hotFlashes', 'anxiety', 'brainFog', 'memory'];
                const labels = {
                    es: { sleep: 'sue√±o', energy: 'energ√≠a', mood: '√°nimo', hotFlashes: 'sofocos', anxiety: 'ansiedad', brainFog: 'niebla mental', memory: 'memoria' },
                    en: { sleep: 'sleep', energy: 'energy', mood: 'mood', hotFlashes: 'hot flashes', anxiety: 'anxiety', brainFog: 'brain fog', memory: 'memory' }
                };
                const lang = language === 'es' ? 'es' : 'en';
                const patterns = [];

                keys.forEach(key => {
                    const values = syms.map(s => s[key] || 0);
                    const avg = values.reduce((a, b) => a + b, 0) / values.length;
                    const last3 = values.slice(-3);
                    const last3Avg = last3.reduce((a, b) => a + b, 0) / last3.length;

                    // Patr√≥n 1: s√≠ntoma consistentemente alto (>=6 en los √∫ltimos 3 d√≠as)
                    if (last3.every(v => v >= 6) && (key === 'hotFlashes' || key === 'anxiety' || key === 'brainFog')) {
                        patterns.push({
                            type: 'persistent_high',
                            symptom: labels[lang][key],
                            avg: last3Avg.toFixed(1),
                            message: language === 'es'
                                ? `Los √∫ltimos 3 d√≠as tu ${labels[lang][key]} ha estado alto (promedio ${last3Avg.toFixed(1)}/10). Esto no es casual ‚Äî tu cuerpo te est√° diciendo algo.`
                                : `Your ${labels[lang][key]} has been high for the last 3 days (average ${last3Avg.toFixed(1)}/10). This isn't random ‚Äî your body is telling you something.`
                        });
                    }

                    // Patr√≥n 2: s√≠ntoma consistentemente bajo (sue√±o, energ√≠a, √°nimo <=4)
                    if (last3.every(v => v <= 4) && (key === 'sleep' || key === 'energy' || key === 'mood')) {
                        patterns.push({
                            type: 'persistent_low',
                            symptom: labels[lang][key],
                            avg: last3Avg.toFixed(1),
                            message: language === 'es'
                                ? `Tu ${labels[lang][key]} ha estado bajo estos √∫ltimos d√≠as (promedio ${last3Avg.toFixed(1)}/10). Vale la pena que le prestemos atenci√≥n.`
                                : `Your ${labels[lang][key]} has been low these past days (average ${last3Avg.toFixed(1)}/10). It's worth paying attention to.`
                        });
                    }

                    // Patr√≥n 3: tendencia de empeoramiento (cada d√≠a peor que el anterior)
                    if (last3.length === 3 && last3[2] < last3[1] && last3[1] < last3[0] && (key === 'sleep' || key === 'energy' || key === 'mood')) {
                        patterns.push({
                            type: 'worsening',
                            symptom: labels[lang][key],
                            message: language === 'es'
                                ? `Tu ${labels[lang][key]} ha ido bajando los √∫ltimos 3 d√≠as (${last3[0]} ‚Üí ${last3[1]} ‚Üí ${last3[2]}). Es una se√±al que vale la pena escuchar.`
                                : `Your ${labels[lang][key]} has been dropping over the last 3 days (${last3[0]} ‚Üí ${last3[1]} ‚Üí ${last3[2]}). It's a sign worth listening to.`
                        });
                    }

                    // Patr√≥n 4: correlaci√≥n sue√±o-energ√≠a (sue√±o bajo = energ√≠a baja al d√≠a siguiente)
                    if (key === 'sleep' && syms.length >= 2) {
                        let correlation = 0;
                        for (let i = 0; i < syms.length - 1; i++) {
                            if ((syms[i].sleep || 0) <= 3 && (syms[i + 1].energy || 0) <= 4) correlation++;
                        }
                        if (correlation >= 2 && syms.length >= 3) {
                            patterns.push({
                                type: 'correlation',
                                symptom: 'sue√±o-energ√≠a',
                                message: language === 'es'
                                    ? `Hay un patr√≥n claro: los d√≠as que duermes poco, al d√≠a siguiente tu energ√≠a baja. Esto es muy com√∫n en esta etapa y hay cosas que podemos hacer al final del d√≠a para mejorar el sue√±o.`
                                    : `There's a clear pattern: on days you sleep less, your energy drops the next day. This is very common at this stage and there are things we can do in the evening to improve sleep.`
                            });
                        }
                    }
                });

                // Si no encontr√≥ patrones autom√°ticos, dar insight gen√©rico basado en datos reales
                if (patterns.length === 0) {
                    const avgSleep = (syms.slice(-3).reduce((a, s) => a + (s.sleep || 0), 0) / 3).toFixed(1);
                    const avgEnergy = (syms.slice(-3).reduce((a, s) => a + (s.energy || 0), 0) / 3).toFixed(1);
                    const avgMood = (syms.slice(-3).reduce((a, s) => a + (s.mood || 0), 0) / 3).toFixed(1);
                    patterns.push({
                        type: 'summary',
                        symptom: 'general',
                        message: language === 'es'
                            ? `Estos 3 d√≠as tu estado ha sido: sue√±o ${avgSleep}/10, energ√≠a ${avgEnergy}/10, √°nimo ${avgMood}/10. Tu PDF de s√≠ntomas ya tiene datos suficientes para ver tendencias. ¬°Desc√°rgalo desde la secci√≥n de S√≠ntomas!`
                            : `These 3 days your status has been: sleep ${avgSleep}/10, energy ${avgEnergy}/10, mood ${avgMood}/10. Your symptoms PDF now has enough data to see trends. Download it from the Symptoms section!`
                    });
                }

                return patterns;
            };

            // VERIFICAR SI DEBE MOSTRAR MODAL DE PATR√ìN
            const checkAndShowPattern = (newSymptoms) => {
                if (newSymptoms.length >= 3 && !patternShown) {
                    const result = analyzePatterns(newSymptoms);
                    if (result && result.length > 0) {
                        setPatternResult(result);
                        setShowPatternModal(true);
                        setPatternShown(true);
                    }
                }
            };

            // VERIFICAR SI EST√Å EN D√çAS DE PERIODO (registr√≥ periodo en los √∫ltimos 7 d√≠as)
            const isInPeriodDays = () => {
                if (periodLog.length === 0) return false;
                const lastPeriod = periodLog[periodLog.length - 1];
                const periodDate = new Date(lastPeriod.date);
                const today = new Date();
                const diffDays = (today - periodDate) / (1000 * 60 * 60 * 24);
                return diffDays <= (lastPeriod.duration || 5);
            };

            // CALCULAR MESES SIN PERIODO
            const getMonthsWithoutPeriod = () => {
                if (periodLog.length === 0) return null;
                const lastPeriod = periodLog[periodLog.length - 1];
                const lastDate = new Date(lastPeriod.date);
                const today = new Date();
                const months = (today.getFullYear() - lastDate.getFullYear()) * 12 + (today.getMonth() - lastDate.getMonth());
                return months;
            };

            // CHAT CON LUMI
            const checkDailyLimit = () => {
                const today = new Date().toDateString();
                if (lastQuestionDate !== today) {
                    setDailyQuestions(0);
                    setLastQuestionDate(today);
                    return true;
                }
                
                const premium = isPremium();
                if (premium) return true;
                if (dailyQuestions >= 5) return false;
                return true;
            };

            // MARCAR MENSAJES PROACTIVOS COMO LE√çDOS - NUEVO ‚ú®
            const markMessagesAsRead = async () => {
                if (proactiveMessages.length === 0) return;
                
                const messageIds = proactiveMessages.map(m => m.id);
                
                await supabase
                    .from('lumi_proactive_messages')
                    .update({ read_at: new Date().toISOString() })
                    .in('id', messageIds);
                
                setUnreadLumiMessages(0);
                setProactiveMessages([]);
            };

            const sendToLumi = async () => {
                if (!lumiInput.trim() || lumiLoading) return;
                
                // Verificar l√≠mite
                if (!checkDailyLimit()) {
                    const limitMsg = language === 'es' 
                        ? 'Has usado tus 5 preguntas diarias. Hazte premium para preguntas ilimitadas üíú'
                        : 'You\'ve used your 5 daily questions. Go premium for unlimited questions üíú';
                    setLumiMessages([...lumiMessages, { role: 'assistant', content: limitMsg }]);
                    return;
                }

                const userMessage = lumiInput.trim();
                setLumiInput('');
                setLumiMessages([...lumiMessages, { role: 'user', content: userMessage }]);
                setLumiLoading(true);

                try {
                    // Contexto de la usuaria
                    const todaySymptoms = symptoms.length > 0 ? symptoms[symptoms.length - 1] : null;
                    const userName = currentUser?.profile_name || 'amiga';
                    
                    const todayStr = todaySymptoms
                        ? (language === 'es'
                            ? '- Hoy: sue√±o ' + todaySymptoms.sleep + '/10, energ√≠a ' + todaySymptoms.energy + '/10, √°nimo ' + todaySymptoms.mood + '/10, sofocos ' + (todaySymptoms.hot_flashes||todaySymptoms.hotFlashes||0) + '/10'
                            : '- Today: sleep ' + todaySymptoms.sleep + '/10, energy ' + todaySymptoms.energy + '/10, mood ' + todaySymptoms.mood + '/10, hot flashes ' + (todaySymptoms.hot_flashes||todaySymptoms.hotFlashes||0) + '/10')
                        : (language === 'es' ? '- No ha registrado s√≠ntomas hoy' : '- No symptoms logged today');

                    const recentStr = symptoms.length >= 2
                        ? (language === 'es' ? '- √öltimos d√≠as:\n' : '- Recent days:\n') +
                          symptoms.slice(0, 3).map((s, i) => 
                            (language === 'es' ? '  D√≠a ' : '  Day ') + (i+1) + ': ' +
                            (language === 'es' ? 'sue√±o ' : 'sleep ') + (s.sleep||'?') + ', ' +
                            (language === 'es' ? 'energ√≠a ' : 'energy ') + (s.energy||'?') + ', ' +
                            (language === 'es' ? '√°nimo ' : 'mood ') + (s.mood||'?') + ', ' +
                            (language === 'es' ? 'sofocos ' : 'hot flashes ') + (s.hot_flashes||s.hotFlashes||'?')
                          ).join('\n')
                        : '';

                    const patternStr = symptoms.length >= 3
                        ? (language === 'es'
                            ? '- AN√ÅLISIS: Si ves que un s√≠ntoma se repite o empeora, menci√≥nalo t√∫ primero de forma natural.'
                            : '- PATTERN CHECK: If you see a symptom repeating or worsening, mention it yourself naturally.')
                        : (language === 'es'
                            ? '- Solo tiene ' + symptoms.length + ' d√≠a(s) registrados. An√≠mala a seguir registrando.'
                            : '- Only ' + symptoms.length + ' day(s) logged. Encourage her to keep logging.');

                    const periodStr = isInPeriodDays()
                        ? (language === 'es'
                            ? '- EST√Å EN PERIODO. Adapta: energ√≠a baja es normal, pide mimo no esfuerzo.'
                            : '- SHE IS IN HER PERIOD. Adjust: low energy is normal, care not effort.')
                        : '';

                    const periodLogStr = periodLog.length > 0
                        ? (language === 'es' ? '- Ha registrado ' + periodLog.length + ' per√≠odo(s).' : '- Has logged ' + periodLog.length + ' period(s).')
                        : (language === 'es' ? '- No ha registrado per√≠odos a√∫n.' : '- No periods logged yet.');

                    const systemPrompt = language === 'es'
                        ? 'Eres Lumi, la coach de wellness de Lumera. Hablas con ' + userName + ', una mujer en esta etapa de cambios hormonales.\n\n' +
                          'Tu personalidad:\n' +
                          '- C√°lida, emp√°tica, cercana (como una amiga sabia)\n' +
                          '- Empoderador (NO victimista)\n' +
                          '- Pr√°ctica (das consejos accionables)\n' +
                          '- Evitas lenguaje m√©dico t√©cnico\n' +
                          '- NUNCA uses "perimenopausia" o "menopausia"\n' +
                          '- Dices "esta etapa", "este momento", "tu cuerpo ahora"\n' +
                          '- Eres una GU√çA proactiva\n\n' +
                          'Datos de ' + userName + ':\n' +
                          todayStr + '\n' + recentStr + '\n' + patternStr + '\n' + periodStr + '\n' + periodLogStr + '\n\n' +
                          'Responde en espa√±ol, m√°ximo 3-4 l√≠neas, tono conversacional.'
                        : 'You are Lumi, Lumera\'s wellness coach. Talking to ' + userName + ', a woman going through hormonal changes.\n\n' +
                          'Your personality:\n' +
                          '- Warm, empathetic, close (like a wise friend)\n' +
                          '- Empowering (NOT victim-focused)\n' +
                          '- Practical (actionable advice)\n' +
                          '- No technical medical language\n' +
                          '- NEVER say "perimenopause" or "menopause"\n' +
                          '- Say "this stage", "this moment", "your body now"\n' +
                          '- PROACTIVE guide\n\n' +
                          userName + '\'s data:\n' +
                          todayStr + '\n' + recentStr + '\n' + patternStr + '\n' + periodStr + '\n' + periodLogStr + '\n\n' +
                          'Respond in English, max 3-4 lines, conversational tone.';

                    const response = await fetch('https://lumera1.bibianabertuarios.workers.dev', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1000,
                            system: systemPrompt,
                            messages: [
                                ...lumiMessages.filter(m => m.role !== 'assistant' || !m.content.includes('Has usado tus')),
                                { role: 'user', content: userMessage }
                            ]
                        })
                    });

                    const data = await response.json();
                    const assistantMessage = data.content[0].text;
                    
                    setLumiMessages([...lumiMessages, 
                        { role: 'user', content: userMessage },
                        { role: 'assistant', content: assistantMessage }
                    ]);
                    
                    // Incrementar contador
                    setDailyQuestions(dailyQuestions + 1);
                    
                } catch (error) {
                    console.error('Error Lumi:', error);
                    const errorMsg = language === 'es'
                        ? 'Perdona, tuve un problemita. Intenta de nuevo en un momento üíú'
                        : 'Sorry, I had a little issue. Try again in a moment üíú';
                    setLumiMessages([...lumiMessages, 
                        { role: 'user', content: userMessage },
                        { role: 'assistant', content: errorMsg }
                    ]);
                }
                
                setLumiLoading(false);
            };

            // HOME
            // LANDING PAGE (sin usuario registrado) - OPTIMIZADO CONVERSI√ìN
            const renderLanding = () => {
                return (
                    <div className="min-h-screen flex flex-col">
                        {/* HERO - GANCHO EMOCIONAL + BENEFICIO CONCRETO */}
                        <div className="flex-1 flex items-center justify-center p-6">
                            <div className="max-w-2xl w-full space-y-8 text-center">
                                {/* Frase principal */}
                                <div className="space-y-4">
                                    <h1 className="text-4xl md:text-5xl font-light leading-tight gradient-text">
                                        {language === 'es' 
                                            ? 'Cuando tu cuerpo cambia, no deber√≠as enfrentarlo sola'
                                            : 'When your body changes, you shouldn\'t face it alone'}
                                    </h1>
                                    <p className="text-xl font-semibold gradient-text">
                                        {language === 'es'
                                            ? 'Para dormir mejor, tener m√°s energ√≠a y entender tus s√≠ntomas sin drama'
                                            : 'To sleep better, have more energy and understand your symptoms without drama'}
                                    </p>
                                    <p className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                        {language === 'es'
                                            ? 'En 7 d√≠as ver√°s qu√© h√°bitos empeoran o mejoran tus s√≠ntomas. Lumera te acompa√±a con planes personalizados, sin presi√≥n y a tu ritmo.'
                                            : 'In 7 days you\'ll see which habits worsen or improve your symptoms. Lumera supports you with personalized plans, no pressure, at your pace.'}
                                    </p>
                                    <p className={`text-base ${darkMode ? 'text-purple-300' : 'text-purple-700'} font-semibold`}>
                                        {language === 'es'
                                            ? '‚ú® Pensada para mujeres de LATAM, con ingredientes que realmente encuentras en tu s√∫per'
                                            : '‚ú® Designed for LATAM women, with ingredients you actually find in your supermarket'}
                                    </p>
                                </div>

                                {/* CTA PRINCIPAL */}
                                <div className="space-y-3">
                                    <button 
                                        onClick={() => setShowAuthModal(true)}
                                        className="w-full md:w-auto bg-gradient-to-r from-rose-400 to-amber-300 text-white px-12 py-5 rounded-xl font-bold text-xl hover:shadow-2xl transition transform hover:scale-105"
                                    >
                                        {language === 'es' ? 'Empieza gratis ahora' : 'Start free now'}
                                    </button>
                                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} font-medium`}>
                                        {language === 'es' 
                                            ? '3 d√≠as con acceso completo, sin tarjeta. Si no te ayuda a entender al menos un s√≠ntoma, simplemente lo dejas.'
                                            : '3 full days, no card required. If it doesn\'t help you understand at least one symptom, just leave.'}
                                    </p>
                                </div>

                                {/* MICRO-PROOF */}
                                <div className={`${darkMode ? 'bg-indigo-900' : 'bg-indigo-50'} rounded-xl p-4 inline-block`}>
                                    <p className={`text-sm ${darkMode ? 'text-indigo-200' : 'text-indigo-900'} font-medium`}>
                                        {language === 'es'
                                            ? 'üî¨ Dise√±ado con apoyo de nutrici√≥n y ejercicio basados en evidencia para mujeres 40‚Äì55'
                                            : 'üî¨ Designed with evidence-based nutrition and exercise support for women 40‚Äì55'}
                                    </p>
                                </div>

                                {/* VALIDACI√ìN MICRO */}
                                <div className="flex flex-wrap justify-center gap-6 text-sm pt-4">
                                    <div className="flex items-center gap-2">
                                        <span className="text-2xl">üë©</span>
                                        <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                                            {language === 'es' ? 'Mujeres 40+' : 'Women 40+'}
                                        </span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-2xl">üåé</span>
                                        <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                                            {language === 'es' ? 'LATAM, Europa, USA' : 'LATAM, Europe, USA'}
                                        </span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-2xl">üíú</span>
                                        <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                                            {language === 'es' ? 'Acompa√±amiento diario' : 'Daily support'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* NO ES TU CULPA - MUY VISIBLE */}
                        <div className={`${darkMode ? 'bg-purple-900' : 'bg-purple-50'} py-12 px-6`}>
                            <div className="max-w-2xl mx-auto text-center">
                                <p className="text-2xl font-bold gradient-text mb-3">
                                    {language === 'es' 
                                        ? 'No es que est√©s fallando. Tu cuerpo est√° cambiando.'
                                        : 'You\'re not failing. Your body is changing.'}
                                </p>
                                <p className={`text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    {language === 'es'
                                        ? 'Y mereces entender qu√© te pasa, sin juicios ni soluciones extremas.'
                                        : 'And you deserve to understand what\'s happening, without judgment or extreme solutions.'}
                                </p>
                            </div>
                        </div>

                        {/* SECCI√ìN: ¬øTE PASA ESTO? */}
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} py-16 px-6`}>
                            <div className="max-w-3xl mx-auto">
                                <h2 className="text-3xl font-bold text-center gradient-text mb-8">
                                    {language === 'es' ? '¬øTe pasa esto?' : 'Does this sound familiar?'}
                                </h2>
                                <div className="grid md:grid-cols-2 gap-4 text-base">
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-lg border-l-4 border-rose-400`}>
                                        <span className="text-rose-500 font-bold">‚Ä¢</span> {language === 'es' ? 'Te despiertas cansada aunque duermas' : 'You wake up tired even when you sleep'}
                                    </div>
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-lg border-l-4 border-rose-400`}>
                                        <span className="text-rose-500 font-bold">‚Ä¢</span> {language === 'es' ? 'Tu cuerpo reacciona distinto a la comida' : 'Your body reacts differently to food'}
                                    </div>
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-lg border-l-4 border-rose-400`}>
                                        <span className="text-rose-500 font-bold">‚Ä¢</span> {language === 'es' ? 'Hay d√≠as en que no sabes qu√© necesitas' : 'Some days you don\'t know what you need'}
                                    </div>
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-lg border-l-4 border-rose-400`}>
                                        <span className="text-rose-500 font-bold">‚Ä¢</span> {language === 'es' ? 'Nadie te explica claramente qu√© te pasa' : 'No one clearly explains what\'s happening'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* TESTIMONIOS ASPIRACIONALES */}
                        <div className={`${darkMode ? 'bg-purple-900' : 'bg-purple-50'} py-12 px-6`}>
                            <div className="max-w-4xl mx-auto">
                                <div className="grid md:grid-cols-2 gap-6">
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-xl border-l-4 border-rose-400`}>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} italic mb-3`}>
                                            {language === 'es'
                                                ? '"Despu√©s de una semana, entend√≠ por qu√© dorm√≠a mal los domingos y qu√© cambiar."'
                                                : '"After a week, I understood why I slept badly on Sundays and what to change."'}
                                        </p>
                                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                            ‚Äî {language === 'es' ? 'Usuaria Lumera, 46 a√±os' : 'Lumera user, 46 years old'}
                                        </p>
                                    </div>
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-xl border-l-4 border-amber-500`}>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} italic mb-3`}>
                                            {language === 'es'
                                                ? '"Al tercer d√≠a ya vi un patr√≥n claro. No sab√≠a que mi caf√© de la tarde me quitaba el sue√±o."'
                                                : '"By day three I saw a clear pattern. I didn\'t know my afternoon coffee was keeping me awake."'}
                                        </p>
                                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                            ‚Äî {language === 'es' ? 'Usuaria Lumera, 52 a√±os' : 'Lumera user, 52 years old'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* POR QU√â LUMERA ES DISTINTA */}
                        <div className={`${darkMode ? 'bg-indigo-900' : 'bg-indigo-50'} py-16 px-6`}>
                            <div className="max-w-4xl mx-auto">
                                <h2 className="text-3xl font-bold text-center gradient-text mb-12">
                                    {language === 'es' ? 'Por qu√© Lumera es distinta' : 'Why Lumera is different'}
                                </h2>
                                <div className="space-y-6">
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-xl border-l-4 border-purple-500`}>
                                        <h4 className="font-bold text-lg mb-2 gradient-text">
                                            {language === 'es' ? 'No solo cuenta s√≠ntomas' : 'Doesn\'t just count symptoms'}
                                        </h4>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            {language === 'es'
                                                ? 'Conecta sue√±o, energ√≠a y estado de √°nimo para detectar patrones sencillos que t√∫ sola tardar√≠as meses en ver.'
                                                : 'Connects sleep, energy and mood to detect simple patterns that would take you months to see alone.'}
                                        </p>
                                    </div>
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-xl border-l-4 border-rose-400`}>
                                        <h4 className="font-bold text-lg mb-2 gradient-text">
                                            {language === 'es' ? 'LUMI habla como una amiga sabia' : 'LUMI speaks like a wise friend'}
                                        </h4>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            {language === 'es'
                                                ? 'No como un informe m√©dico. Te acompa√±a, te explica y te ayuda a decidir sin presi√≥n.'
                                                : 'Not like a medical report. Supports you, explains and helps you decide without pressure.'}
                                        </p>
                                    </div>
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-xl border-l-4 border-amber-500`}>
                                        <h4 className="font-bold text-lg mb-2 gradient-text">
                                            {language === 'es' ? 'Men√∫s con ingredientes de tu regi√≥n' : 'Menus with local ingredients'}
                                        </h4>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            {language === 'es'
                                                ? 'Se adaptan a tus restricciones (sin lactosa, sin gluten) y a tu regi√≥n (LATAM, Europa, USA) para usar ingredientes que realmente tienes a mano.'
                                                : 'Adapt to your restrictions (lactose-free, gluten-free) and region (LATAM, Europe, USA) using ingredients you actually have available.'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* C√ìMO FUNCIONA - CON RESULTADOS CONCRETOS */}
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} py-16 px-6`}>
                            <div className="max-w-3xl mx-auto">
                                <h2 className="text-3xl font-bold text-center gradient-text mb-12">
                                    {language === 'es' ? '¬øC√≥mo funciona?' : 'How does it work?'}
                                </h2>
                                <div className="space-y-6">
                                    <div className="flex gap-4 items-start">
                                        <div className="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-rose-400 to-amber-300 text-white rounded-full flex items-center justify-center font-bold text-xl">1</div>
                                        <div>
                                            <h4 className="font-bold text-lg mb-1">{language === 'es' ? 'Registra c√≥mo te sientes' : 'Log how you feel'}</h4>
                                            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                                                {language === 'es' ? 'Energ√≠a, s√≠ntomas y estado de √°nimo.' : 'Energy, symptoms and mood.'}
                                            </p>
                                            <p className={`text-xs font-semibold ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>
                                                ‚è± {language === 'es' ? 'En menos de 2 minutos al d√≠a' : 'In less than 2 minutes a day'}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex gap-4 items-start">
                                        <div className="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-rose-400 to-amber-300 text-white rounded-full flex items-center justify-center font-bold text-xl">2</div>
                                        <div>
                                            <h4 className="font-bold text-lg mb-1">{language === 'es' ? 'Lumera detecta patrones' : 'Lumera detects patterns'}</h4>
                                            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                                                {language === 'es' ? 'Conectamos datos para encontrar qu√© te ayuda.' : 'We connect data to find what helps you.'}
                                            </p>
                                            <p className={`text-xs font-semibold ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>
                                                üîç {language === 'es' ? 'LUMI detecta patrones que t√∫ sola tardar√≠as meses en ver' : 'LUMI detects patterns that would take you months to see alone'}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex gap-4 items-start">
                                        <div className="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-rose-400 to-amber-300 text-white rounded-full flex items-center justify-center font-bold text-xl">3</div>
                                        <div>
                                            <h4 className="font-bold text-lg mb-1">{language === 'es' ? 'Recibes tu plan adaptado' : 'Get your adapted plan'}</h4>
                                            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                                                {language === 'es' ? 'Men√∫s, ejercicios y consejos que cambian seg√∫n c√≥mo te sientes.' : 'Menus, exercises and advice that change based on how you feel.'}
                                            </p>
                                            <p className={`text-xs font-semibold ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>
                                                ‚ú® {language === 'es' ? 'Aplicas cambios peque√±os que puedes mantener' : 'Apply small changes you can maintain'}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* TABLA COMPARATIVA GRATIS VS PREMIUM */}
                        <div className={`${darkMode ? 'bg-indigo-900' : 'bg-indigo-50'} py-16 px-6`}>
                            <div className="max-w-4xl mx-auto">
                                <h2 className="text-3xl font-bold text-center gradient-text mb-4">
                                    {language === 'es' ? 'Qu√© incluye cada opci√≥n' : 'What each option includes'}
                                </h2>
                                <p className={`text-center ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-8`}>
                                    {language === 'es'
                                        ? 'Empieza gratis, pasa a premium solo si ves claro que te ayuda'
                                        : 'Start free, upgrade to premium only if you clearly see it helps'}
                                </p>
                                
                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-xl overflow-hidden`}>
                                    <table className="w-full text-sm">
                                        <thead className="bg-gradient-to-r from-rose-400 to-amber-300 text-white">
                                            <tr>
                                                <th className="text-left p-4 font-bold">{language === 'es' ? 'Funci√≥n' : 'Feature'}</th>
                                                <th className="text-center p-4 font-bold">{language === 'es' ? 'Gratis' : 'Free'}</th>
                                                <th className="text-center p-4 font-bold">Premium</th>
                                            </tr>
                                        </thead>
                                        <tbody className={darkMode ? 'text-gray-300' : 'text-gray-800'}>
                                            <tr className={darkMode ? 'border-b border-gray-700' : 'border-b border-gray-200'}>
                                                <td className="p-4 font-medium">{language === 'es' ? 'Chat con LUMI' : 'LUMI Chat'}</td>
                                                <td className="p-4 text-center text-amber-600 font-bold">5 {language === 'es' ? 'mensajes/d√≠a' : 'messages/day'}</td>
                                                <td className="p-4 text-center text-green-600 font-bold">‚úÖ {language === 'es' ? 'Ilimitado' : 'Unlimited'}</td>
                                            </tr>
                                            <tr className={darkMode ? 'border-b border-gray-700' : 'border-b border-gray-200'}>
                                                <td className="p-4 font-medium">{language === 'es' ? 'Men√∫s personalizados' : 'Personalized menus'}</td>
                                                <td className="p-4 text-center text-gray-500">1 {language === 'es' ? 'b√°sico semanal' : 'basic weekly'}</td>
                                                <td className="p-4 text-center text-green-600 font-bold">‚úÖ {language === 'es' ? '7 d√≠as adaptados' : '7 adapted days'}</td>
                                            </tr>
                                            <tr className={darkMode ? 'border-b border-gray-700' : 'border-b border-gray-200'}>
                                                <td className="p-4 font-medium">{language === 'es' ? 'Insights de patrones' : 'Pattern insights'}</td>
                                                <td className="p-4 text-center text-gray-500">{language === 'es' ? 'Vista simple' : 'Simple view'}</td>
                                                <td className="p-4 text-center text-green-600 font-bold">‚úÖ {language === 'es' ? 'Insights detallados' : 'Detailed insights'}</td>
                                            </tr>
                                            <tr className={darkMode ? 'border-b border-gray-700' : 'border-b border-gray-200'}>
                                                <td className="p-4 font-medium">{language === 'es' ? 'Tracker de s√≠ntomas' : 'Symptom tracker'}</td>
                                                <td className="p-4 text-center text-green-600 font-bold">‚úÖ {language === 'es' ? 'Ilimitado' : 'Unlimited'}</td>
                                                <td className="p-4 text-center text-green-600 font-bold">‚úÖ {language === 'es' ? 'Ilimitado' : 'Unlimited'}</td>
                                            </tr>
                                            <tr>
                                                <td className="p-4 font-medium">{language === 'es' ? 'Informes para tu m√©dica' : 'Reports for your doctor'}</td>
                                                <td className="p-4 text-center text-red-600 font-bold">‚ùå</td>
                                                <td className="p-4 text-center text-green-600 font-bold">‚úÖ PDF {language === 'es' ? 'sencillo' : 'simple'}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        {/* CTA FINAL */}
                        <div className="py-16 px-6 text-center">
                            <div className="max-w-2xl mx-auto space-y-6">
                                <h2 className="text-3xl font-bold gradient-text">
                                    {language === 'es' 
                                        ? 'Empieza gratis. Qu√©date solo si te ayuda.'
                                        : 'Start free. Stay only if it helps.'}
                                </h2>
                                <p className={`text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    {language === 'es'
                                        ? 'Durante 3 d√≠as, LUMI te mostrar√° al menos un patr√≥n de tus s√≠ntomas para que decidas con datos, no con intuici√≥n.'
                                        : 'For 3 days, LUMI will show you at least one pattern in your symptoms so you decide with data, not intuition.'}
                                </p>
                                <button 
                                    onClick={() => setShowAuthModal(true)}
                                    className="bg-gradient-to-r from-rose-400 to-amber-300 text-white px-12 py-5 rounded-xl font-bold text-xl hover:shadow-2xl transition transform hover:scale-105"
                                >
                                    {language === 'es' ? 'Empieza ahora gratis' : 'Start now free'}
                                </button>
                                <p className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>
                                    {language === 'es' 
                                        ? 'Sin compromiso ¬∑ Sin tarjeta ¬∑ Cancela cuando quieras'
                                        : 'No commitment ¬∑ No card ¬∑ Cancel anytime'}
                                </p>
                            </div>
                        </div>

                        {/* DISCLAIMER */}
                        <div className={`text-xs text-center ${darkMode ? 'text-gray-500' : 'text-gray-500'} italic p-6 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            {language === 'es'
                                ? 'Lumera no sustituye atenci√≥n m√©dica ni realiza diagn√≥sticos. Es un espacio de acompa√±amiento y educaci√≥n para mujeres 40+.'
                                : 'Lumera does not replace medical care or make diagnoses. It is a space for support and education for women 40+.'}
                        </div>
                    </div>
                );
            };

            // ‚ú® DASHBOARD PREMIUM
            const renderPremiumDashboard = () => {
                const userName = currentUser.profile_name || (language === 'es' ? 'amiga' : 'friend');
                const trialDaysLeft = getTrialDaysLeft();
                const isInTrial = !currentUser.subscription_status || currentUser.subscription_status !== 'active';
                // D√≠a 3 de trial = √∫ltimo d√≠a, acceso premium completo para mostrar el valor m√°ximo
                const isTrialDay3 = isInTrial && trialDaysLeft <= 1;

                // (useEffect movido al nivel de LumeraApp para cumplir reglas de hooks)

                return (
                    <div className="pb-32 space-y-6" key={language}>

                        {/* HERO PREMIUM */}
                        <div style={{
                            background: 'linear-gradient(135deg, #f5f0ff 0%, #fdf2f8 50%, #fff7ed 100%)',
                            borderRadius: '1.5rem',
                            padding: '2.5rem',
                            border: '1px solid rgba(167,139,250,0.2)',
                            boxShadow: '0 4px 32px rgba(167,139,250,0.12)'
                        }}>
                            <div className="flex items-start justify-between mb-4">
                                <div>
                                    <div style={{
                                        display: 'inline-flex',
                                        alignItems: 'center',
                                        gap: '0.4rem',
                                        background: 'linear-gradient(135deg, #d4af37, #f4e4c1)',
                                        borderRadius: '9999px',
                                        padding: '0.3rem 0.9rem',
                                        marginBottom: '1rem'
                                    }}>
                                        <span style={{fontSize: '0.75rem', fontWeight: 600, color: '#78716c', letterSpacing: '0.05em'}}>
                                            {language === 'es' ? '‚ú¶ PREMIUM' : '‚ú¶ PREMIUM'}
                                        </span>
                                    </div>
                                    <h1 style={{fontFamily: "'Cormorant', serif", fontSize: '2.25rem', fontWeight: 500, color: '#292524', lineHeight: 1.15, letterSpacing: '-0.02em', marginBottom: '0.5rem'}}>
                                        {language === 'es' ? `Bienvenida, ${userName}` : `Welcome, ${userName}`}
                                    </h1>
                                    <p style={{color: '#78716c', fontSize: '1rem', lineHeight: 1.6}}>
                                        {language === 'es'
                                            ? 'Tu espacio de acompa√±amiento personalizado.'
                                            : 'Your personalized support space.'}
                                    </p>
                                </div>
                                <div style={{fontSize: '3rem', opacity: 0.85}}>üå∏</div>
                            </div>

                            {/* Acuarela */}
                            <div style={{
                                borderRadius: '1rem',
                                overflow: 'hidden',
                                marginTop: '1.5rem',
                                boxShadow: '0 4px 20px rgba(0,0,0,0.08)',
                                position: 'relative'
                            }}>
                                <img
                                    src="./assets/acuarela.jpg"
                                    alt={language === 'es' ? 'Lumera ‚Äî con cari√±o' : 'Lumera ‚Äî with love'}
                                    style={{
                                        width: '100%',
                                        maxHeight: '220px',
                                        objectFit: 'cover',
                                        display: 'block'
                                    }}
                                    onError={(e) => { e.target.style.display = 'none'; }}
                                />
                                <div style={{
                                    position: 'absolute',
                                    bottom: 0, left: 0, right: 0,
                                    background: 'linear-gradient(transparent, rgba(245,240,255,0.8))',
                                    padding: '2rem 1.5rem 1rem',
                                    fontFamily: "'Cormorant', serif",
                                    fontStyle: 'italic',
                                    color: '#5b21b6',
                                    fontSize: '1rem'
                                }}>
                                    {language === 'es' ? '"No est√°s sola en este camino." üíú' : '"You are not alone on this path." üíú'}
                                </div>
                            </div>
                        </div>

                        {/* M√âTRICAS PREMIUM */}
                        {currentUser && currentUser.bmi && currentUser.tdee && (
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div style={{background: 'white', borderRadius: '1rem', padding: '1.25rem', boxShadow: '0 2px 16px rgba(0,0,0,0.05)', border: '1px solid rgba(167,139,250,0.15)', textAlign: 'center'}}>
                                    <p style={{fontSize: '0.7rem', fontWeight: 600, color: '#a78bfa', letterSpacing: '0.08em', marginBottom: '0.4rem', textTransform: 'uppercase'}}>IMC</p>
                                    <p style={{fontSize: '2rem', fontWeight: 700, background: 'linear-gradient(135deg,#a78bfa,#c084fc)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', marginBottom: '0.2rem'}}>{currentUser.bmi}</p>
                                    <p style={{fontSize: '0.75rem', color: '#a8a29e'}}>{getBMICategory(currentUser.bmi, language)}</p>
                                </div>
                                <div style={{background: 'white', borderRadius: '1rem', padding: '1.25rem', boxShadow: '0 2px 16px rgba(0,0,0,0.05)', border: '1px solid rgba(251,191,36,0.2)', textAlign: 'center'}}>
                                    <p style={{fontSize: '0.7rem', fontWeight: 600, color: '#d97706', letterSpacing: '0.08em', marginBottom: '0.4rem', textTransform: 'uppercase'}}>üî• TDEE</p>
                                    <p style={{fontSize: '2rem', fontWeight: 700, background: 'linear-gradient(135deg,#f59e0b,#fbbf24)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', marginBottom: '0.2rem'}}>{currentUser.tdee}</p>
                                    <p style={{fontSize: '0.75rem', color: '#a8a29e'}}>kcal/d√≠a</p>
                                </div>
                                <div
                                    onClick={() => setShowEditProfile(true)}
                                    style={{background: 'white', borderRadius: '1rem', padding: '1.25rem', boxShadow: '0 2px 16px rgba(0,0,0,0.05)', border: '1px solid rgba(167,139,250,0.2)', textAlign: 'center', cursor: 'pointer'}}
                                >
                                    <p style={{fontSize: '1.75rem', marginBottom: '0.25rem'}}>‚öôÔ∏è</p>
                                    <p style={{fontSize: '0.75rem', fontWeight: 600, color: '#7c3aed'}}>{language === 'es' ? 'Editar perfil' : 'Edit profile'}</p>
                                </div>
                            </div>
                        )}

                        {/* STATUS PREMIUM */}
                        <div style={{
                            background: 'linear-gradient(135deg, #7c3aed 0%, #a855f7 100%)',
                            borderRadius: '1.25rem',
                            padding: '1.5rem',
                            color: 'white',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '1rem',
                            boxShadow: '0 8px 24px rgba(124,58,237,0.2)'
                        }}>
                            <div style={{fontSize: '2.5rem'}}>‚ú®</div>
                            <div>
                                <p style={{fontWeight: 600, fontSize: '1rem', marginBottom: '0.25rem'}}>
                                    {isTrialDay3
                                        ? (language === 'es' ? 'üåü √öltimo d√≠a ‚Äî ve tus patrones completos' : 'üåü Last day ‚Äî see your full patterns')
                                        : isInTrial
                                            ? (language === 'es' ? `Trial activo ¬∑ ${trialDaysLeft} d√≠as restantes` : `Active trial ¬∑ ${trialDaysLeft} days left`)
                                            : (language === 'es' ? 'Suscripci√≥n Premium activa' : 'Premium subscription active')}
                                </p>
                                <p style={{fontSize: '0.85rem', opacity: 0.9}}>
                                    {isTrialDay3
                                        ? (language === 'es'
                                            ? 'LUMI ha analizado tus s√≠ntomas. ¬°Ya tienes tu primer patr√≥n! üíú'
                                            : 'LUMI has analyzed your symptoms. You have your first pattern! üíú')
                                        : (language === 'es'
                                            ? 'Acceso completo a todas las funciones de Lumera üíú'
                                            : 'Full access to all Lumera features üíú')}
                                </p>
                            </div>
                        </div>

                        {/* BOT√ìN CANCELAR SUSCRIPCI√ìN */}
                        {!isInTrial && (
                            <div style={{textAlign: 'center'}}>
                                <button
                                    onClick={handleCancelSubscription}
                                    style={{
                                        background: 'none',
                                        border: '1px solid rgba(120,113,108,0.25)',
                                        borderRadius: '0.75rem',
                                        padding: '0.6rem 1.4rem',
                                        fontSize: '0.8rem',
                                        color: '#a8a29e',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={e => { e.target.style.borderColor = '#ef4444'; e.target.style.color = '#ef4444'; }}
                                    onMouseLeave={e => { e.target.style.borderColor = 'rgba(120,113,108,0.25)'; e.target.style.color = '#a8a29e'; }}
                                >
                                    {language === 'es' ? 'Cancelar suscripci√≥n' : 'Cancel subscription'}
                                </button>
                                <p style={{fontSize: '0.72rem', color: '#d4b896', marginTop: '0.35rem'}}>
                                    {language === 'es'
                                        ? 'Mantendr√°s el acceso hasta fin del per√≠odo actual.'
                                        : 'You keep access until the end of the current period.'}
                                </p>
                            </div>
                        )}

                        {/* ACCESOS R√ÅPIDOS */}
                        <div>
                            <h2 style={{fontFamily: "'Cormorant', serif", fontSize: '1.5rem', fontWeight: 500, color: '#292524', marginBottom: '1rem'}}>
                                {language === 'es' ? 'Tu espacio' : 'Your space'}
                            </h2>
                            <div className="grid grid-cols-2 gap-3">
                                {[
                                    { icon: 'üìì', labelEs: 'Diario de s√≠ntomas', labelEn: 'Symptom journal', page: 'diario' },
                                    { icon: 'üß†', labelEs: 'Hablar con LUMI', labelEn: 'Talk to LUMI', page: 'lumi' },
                                    { icon: 'üçΩÔ∏è', labelEs: 'Plan nutricional', labelEn: 'Nutrition plan', page: 'nutricion' },
                                    { icon: 'üìä', labelEs: 'Mi progreso', labelEn: 'My progress', page: 'progreso' },
                                ].map(item => (
                                    <div
                                        key={item.page}
                                        onClick={() => setCurrentPage(item.page)}
                                        style={{
                                            background: 'white',
                                            borderRadius: '1.25rem',
                                            padding: '1.5rem 1rem',
                                            boxShadow: '0 2px 16px rgba(0,0,0,0.05)',
                                            border: '1px solid rgba(167,139,250,0.12)',
                                            cursor: 'pointer',
                                            textAlign: 'center'
                                        }}
                                    >
                                        <div style={{fontSize: '2rem', marginBottom: '0.5rem'}}>{item.icon}</div>
                                        <p style={{fontSize: '0.8rem', fontWeight: 600, color: '#44403c'}}>
                                            {language === 'es' ? item.labelEs : item.labelEn}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* MENSAJE MOTIVACIONAL */}
                        <div style={{
                            background: 'linear-gradient(135deg, #fdf2f8, #f5f0ff)',
                            borderRadius: '1.25rem',
                            padding: '1.5rem',
                            border: '1px solid rgba(236,72,153,0.1)',
                            textAlign: 'center'
                        }}>
                            <p style={{fontFamily: "'Cormorant', serif", fontSize: '1.25rem', fontWeight: 500, color: '#7c3aed', fontStyle: 'italic', lineHeight: 1.6}}>
                                {language === 'es'
                                    ? '"Conocerte mejor es el primer paso para cuidarte mejor." üåø'
                                    : '"Knowing yourself better is the first step to caring for yourself better." üåø'}
                            </p>
                        </div>

                    </div>
                );
            };

            const renderHome = () => {
                if (!currentUser) return renderLanding();

                const userName = currentUser.profile_name || (language === 'es' ? 'amiga' : 'friend');
                const trialDaysForRouting = getTrialDaysLeft();

                // Premium activo ‚Üí su propio dashboard
                if (currentUser?.subscription_status === 'active') {
                    return renderPremiumDashboard();
                }

                // Trial (d√≠as 1, 2 y 3) ‚Üí dashboard de onboarding + conversi√≥n
                const trialDaysLeft = trialDaysForRouting;
                const dayNum = Math.max(1, 4 - trialDaysLeft); // d√≠a 1, 2 o 3

                const bgCard = darkMode ? '#1c1917' : '#ffffff';
                const bgPage = darkMode ? '#0c0a09' : '#fafaf9';
                const textMain = darkMode ? '#e7e5e4' : '#292524';
                const textSub = darkMode ? '#a8a29e' : '#78716c';
                const borderSoft = darkMode ? 'rgba(167,139,250,0.18)' : 'rgba(167,139,250,0.15)';

                return (
                    <div className="pb-32 space-y-6" key={language} style={{background: bgPage}}>

                        {/* ‚îÄ‚îÄ HERO TRIAL ‚îÄ‚îÄ */}
                        <div style={{
                            background: 'linear-gradient(135deg, #7c3aed 0%, #a855f7 55%, #ec4899 100%)',
                            borderRadius: '1.5rem',
                            padding: '2rem 1.75rem',
                            color: 'white',
                            position: 'relative',
                            overflow: 'hidden'
                        }}>
                            {/* Countdown d√≠as */}
                            <div style={{
                                position: 'absolute', top: '1.25rem', right: '1.25rem',
                                background: 'rgba(255,255,255,0.18)',
                                borderRadius: '9999px',
                                padding: '0.3rem 0.9rem',
                                fontSize: '0.78rem',
                                fontWeight: 700,
                                backdropFilter: 'blur(4px)'
                            }}>
                                {language === 'es' ? `D√≠a ${dayNum} de 3` : `Day ${dayNum} of 3`}
                            </div>

                            <p style={{fontSize: '0.8rem', fontWeight: 600, opacity: 0.85, marginBottom: '0.4rem', letterSpacing: '0.06em', textTransform: 'uppercase'}}>
                                {language === 'es' ? '‚ú¶ PRUEBA GRATUITA' : '‚ú¶ FREE TRIAL'}
                            </p>
                            <h1 style={{fontFamily: "'Cormorant', serif", fontSize: '2rem', fontWeight: 500, lineHeight: 1.15, marginBottom: '0.75rem'}}>
                                {language === 'es' ? `Hola, ${userName} üíú` : `Hi, ${userName} üíú`}
                            </h1>
                            <p style={{fontSize: '0.95rem', opacity: 0.9, lineHeight: 1.6, marginBottom: '1.25rem'}}>
                                {language === 'es'
                                    ? 'Tienes 3 d√≠as para descubrir c√≥mo Lumera transforma tu bienestar en esta etapa. Explora todo sin l√≠mites.'
                                    : 'You have 3 days to discover how Lumera transforms your wellbeing at this stage. Explore everything without limits.'}
                            </p>

                            {/* Barra de progreso d√≠as */}
                            <div style={{display: 'flex', gap: '0.4rem'}}>
                                {[1,2,3].map(d => (
                                    <div key={d} style={{
                                        flex: 1, height: '6px', borderRadius: '9999px',
                                        background: d <= dayNum ? 'white' : 'rgba(255,255,255,0.3)'
                                    }}/>
                                ))}
                            </div>
                        </div>

                        {/* ‚îÄ‚îÄ C√ìMO USAR LUMERA ‚îÄ‚îÄ */}
                        <div style={{background: bgCard, borderRadius: '1.25rem', padding: '1.5rem', border: `1px solid ${borderSoft}`, boxShadow: '0 2px 16px rgba(0,0,0,0.05)'}}>
                            <h2 style={{fontFamily: "'Cormorant', serif", fontSize: '1.45rem', fontWeight: 500, color: textMain, marginBottom: '1rem'}}>
                                {language === 'es' ? '¬øC√≥mo sacar el m√°ximo a Lumera?' : 'How to get the most from Lumera?'}
                            </h2>
                            <div style={{display: 'flex', flexDirection: 'column', gap: '0.85rem'}}>
                                {[
                                    { step: '1', icon: 'üìù', es: 'Registra c√≥mo te sientes cada d√≠a ‚Äî sue√±o, energ√≠a, √°nimo, sofocos', en: 'Log how you feel each day ‚Äî sleep, energy, mood, hot flashes' },
                                    { step: '2', icon: 'üçΩÔ∏è', es: 'Revisa tu plan de nutrici√≥n adaptado a tus s√≠ntomas de hoy', en: 'Check your nutrition plan adapted to today\'s symptoms' },
                                    { step: '3', icon: 'üí™', es: 'Sigue tu rutina de ejercicios personalizada para esta etapa', en: 'Follow your personalized exercise routine for this stage' },
                                    { step: '4', icon: 'üß†', es: 'Habla con LUMI ‚Äî te escucha, analiza tus patrones y te orienta', en: 'Talk to LUMI ‚Äî she listens, analyzes your patterns and guides you' },
                                    { step: '5', icon: 'üìä', es: 'Al d√≠a 3 ver√°s tu primer patr√≥n real. Datos de tu cuerpo, no suposiciones', en: 'On day 3 you\'ll see your first real pattern. Data from your body, not guesses' },
                                ].map(item => (
                                    <div key={item.step} style={{display: 'flex', alignItems: 'flex-start', gap: '0.85rem'}}>
                                        <div style={{
                                            minWidth: '2rem', height: '2rem', borderRadius: '9999px',
                                            background: 'linear-gradient(135deg, #7c3aed, #a855f7)',
                                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                                            color: 'white', fontWeight: 700, fontSize: '0.8rem', flexShrink: 0
                                        }}>{item.step}</div>
                                        <p style={{fontSize: '0.88rem', color: textSub, lineHeight: 1.55, paddingTop: '0.25rem'}}>
                                            <span style={{fontSize: '1rem', marginRight: '0.4rem'}}>{item.icon}</span>
                                            {language === 'es' ? item.es : item.en}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* ‚îÄ‚îÄ SI TE SIENTES AS√ç, USA LUMERA ‚îÄ‚îÄ */}
                        <div style={{background: bgCard, borderRadius: '1.25rem', padding: '1.5rem', border: `1px solid ${borderSoft}`, boxShadow: '0 2px 16px rgba(0,0,0,0.05)'}}>
                            <h2 style={{fontFamily: "'Cormorant', serif", fontSize: '1.45rem', fontWeight: 500, color: textMain, marginBottom: '0.25rem'}}>
                                {language === 'es' ? 'Si te sientes as√≠, Lumera es para ti' : 'If you feel this way, Lumera is for you'}
                            </h2>
                            <p style={{fontSize: '0.82rem', color: textSub, marginBottom: '1rem'}}>
                                {language === 'es' ? 'S√≠ntomas comunes que Lumera ayuda a gestionar' : 'Common symptoms Lumera helps you manage'}
                            </p>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.65rem'}}>
                                {[
                                    { icon: 'üî•', es: 'Sofocos y calores', en: 'Hot flashes' },
                                    { icon: 'üò¥', es: 'Dormir mal o poco', en: 'Poor sleep' },
                                    { icon: '‚ö°', es: 'Fatiga constante', en: 'Constant fatigue' },
                                    { icon: 'üåÄ', es: 'Niebla mental', en: 'Brain fog' },
                                    { icon: 'üíß', es: 'Retenci√≥n de l√≠quidos', en: 'Water retention' },
                                    { icon: 'üòü', es: 'Ansiedad o irritabilidad', en: 'Anxiety or irritability' },
                                    { icon: '‚öñÔ∏è', es: 'Cambios de peso', en: 'Weight changes' },
                                    { icon: 'üíú', es: 'Cambios de humor', en: 'Mood swings' },
                                ].map((item, i) => (
                                    <div key={i} style={{
                                        display: 'flex', alignItems: 'center', gap: '0.6rem',
                                        background: darkMode ? 'rgba(124,58,237,0.12)' : 'rgba(124,58,237,0.05)',
                                        borderRadius: '0.75rem', padding: '0.65rem 0.85rem',
                                        border: '1px solid rgba(124,58,237,0.12)'
                                    }}>
                                        <span style={{fontSize: '1.1rem'}}>{item.icon}</span>
                                        <span style={{fontSize: '0.82rem', color: textSub, fontWeight: 500}}>{language === 'es' ? item.es : item.en}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* ‚îÄ‚îÄ TABLA FREE vs PREMIUM ‚îÄ‚îÄ */}
                        <div style={{background: bgCard, borderRadius: '1.25rem', overflow: 'hidden', border: `1px solid ${borderSoft}`, boxShadow: '0 2px 16px rgba(0,0,0,0.05)'}}>
                            <div style={{background: 'linear-gradient(135deg, #7c3aed, #a855f7)', padding: '1.1rem 1.5rem'}}>
                                <h2 style={{color: 'white', fontFamily: "'Cormorant', serif", fontSize: '1.4rem', fontWeight: 500, margin: 0}}>
                                    {language === 'es' ? '¬øQu√© incluye cada plan?' : 'What does each plan include?'}
                                </h2>
                            </div>
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '0.83rem'}}>
                                <thead>
                                    <tr style={{background: darkMode ? 'rgba(124,58,237,0.15)' : 'rgba(124,58,237,0.06)'}}>
                                        <th style={{padding: '0.75rem 1rem', textAlign: 'left', color: textSub, fontWeight: 600}}>
                                            {language === 'es' ? 'Funci√≥n' : 'Feature'}
                                        </th>
                                        <th style={{padding: '0.75rem 0.5rem', textAlign: 'center', color: textSub, fontWeight: 600}}>
                                            {language === 'es' ? 'Gratis' : 'Free'}
                                        </th>
                                        <th style={{padding: '0.75rem 1rem', textAlign: 'center', color: '#7c3aed', fontWeight: 700}}>
                                            üíé Premium
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {[
                                        { es: 'Registro de s√≠ntomas', en: 'Symptom tracking',           free: true,  premium: true  },
                                        { es: 'Men√∫ nutricional b√°sico', en: 'Basic nutrition menu',    free: true,  premium: true  },
                                        { es: 'Mitos y consejos', en: 'Myths & tips',                   free: true,  premium: true  },
                                        { es: 'Men√∫ adaptado a s√≠ntomas', en: 'Symptom-adapted menu',   free: false, premium: true  },
                                        { es: 'Ejercicios personalizados', en: 'Personalized exercises', free: false, premium: true },
                                        { es: 'LUMI ‚Äî coach personal', en: 'LUMI ‚Äî personal coach',     free: false, premium: true  },
                                        { es: 'An√°lisis de patrones', en: 'Pattern analysis',           free: false, premium: true  },
                                        { es: 'Gr√°ficos de tendencias', en: 'Trend charts',             free: false, premium: true  },
                                        { es: 'Dashboard metab√≥lico', en: 'Metabolic dashboard',        free: false, premium: true  },
                                        { es: 'Comunidad premium', en: 'Premium community',             free: false, premium: true  },
                                    ].map((row, i) => (
                                        <tr key={i} style={{borderTop: `1px solid ${darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.05)'}`, background: i % 2 === 0 ? 'transparent' : (darkMode ? 'rgba(255,255,255,0.02)' : 'rgba(0,0,0,0.01)')}}>
                                            <td style={{padding: '0.65rem 1rem', color: textMain}}>{language === 'es' ? row.es : row.en}</td>
                                            <td style={{padding: '0.65rem 0.5rem', textAlign: 'center', fontSize: '1.1rem'}}>
                                                {row.free ? '‚úÖ' : '‚Äî'}
                                            </td>
                                            <td style={{padding: '0.65rem 1rem', textAlign: 'center', fontSize: '1.1rem'}}>
                                                {row.premium ? '‚úÖ' : '‚Äî'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* ‚îÄ‚îÄ CTA PREMIUM ‚îÄ‚îÄ */}
                        <div style={{
                            background: 'linear-gradient(135deg, #7c3aed 0%, #a855f7 55%, #ec4899 100%)',
                            borderRadius: '1.5rem',
                            padding: '2rem 1.75rem',
                            textAlign: 'center',
                            color: 'white',
                            boxShadow: '0 8px 32px rgba(124,58,237,0.25)'
                        }}>
                            <div style={{fontSize: '2.5rem', marginBottom: '0.75rem'}}>üíé</div>
                            <h2 style={{fontFamily: "'Cormorant', serif", fontSize: '1.8rem', fontWeight: 500, marginBottom: '0.5rem', lineHeight: 1.2}}>
                                {language === 'es' ? '¬øTe gusta lo que ves?' : 'Liking what you see?'}
                            </h2>
                            <p style={{fontSize: '0.92rem', opacity: 0.9, marginBottom: '1.5rem', lineHeight: 1.6}}>
                                {language === 'es'
                                    ? 'Al terminar el trial pierdes acceso a LUMI, ejercicios personalizados, patrones y gr√°ficos. Hazte premium y sigue teniendo a Lumera contigo cada d√≠a.'
                                    : 'When your trial ends you lose access to LUMI, personalized exercises, patterns and charts. Go premium and keep Lumera with you every day.'}
                            </p>
                            <button
                                onClick={() => setCurrentPage('premium')}
                                style={{
                                    background: 'white',
                                    color: '#7c3aed',
                                    fontWeight: 800,
                                    fontSize: '1.05rem',
                                    padding: '0.9rem 2.5rem',
                                    borderRadius: '9999px',
                                    border: 'none',
                                    cursor: 'pointer',
                                    boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                                    display: 'inline-block',
                                    marginBottom: '0.75rem',
                                    transition: 'transform 0.15s',
                                }}
                                onMouseEnter={e => e.target.style.transform = 'scale(1.04)'}
                                onMouseLeave={e => e.target.style.transform = 'scale(1)'}
                            >
                                ‚ú® {language === 'es' ? 'Hazte Premium ahora' : 'Go Premium now'}
                            </button>
                            <p style={{fontSize: '0.78rem', opacity: 0.8, margin: 0}}>
                                {language === 'es' ? 'Sin tarjeta durante el trial ¬∑ Cancela cuando quieras' : 'No card during trial ¬∑ Cancel anytime'}
                            </p>
                        </div>

                    </div>
                );
            };

            const renderNutrition = () => {
                const mealLabels = language === 'es' ? { 
                    Desayuno: 'Desayuno', 
                    Almuerzo: 'Almuerzo', 
                    Cena: 'Cena', 
                    Snack: 'Snack' 
                } : { 
                    Desayuno: 'Breakfast', 
                    Almuerzo: 'Lunch', 
                    Cena: 'Dinner', 
                    Snack: 'Snack' 
                };
                
                if (menusLoading) {
                    return (
                        <div className="pb-32 space-y-8">
                            <h2 className="text-3xl font-light gradient-text">{t[language].nutrition}</h2>
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-8 text-center`}>
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-rose-400 mx-auto mb-4"></div>
                                <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                                    {language === 'es' ? 'Cargando men√∫s...' : 'Loading menus...'}
                                </p>
                            </div>
                        </div>
                    );
                }
                
                // Funci√≥n para seleccionar men√∫ adaptado seg√∫n s√≠ntomas
                const getSelectedSymptom = () => {
                    const tier = getUserTier();

                    // Verificar si est√° en per√≠odo - m√∫ltiples formas de detectarlo
                    if (symptoms && symptoms.length > 0) {
                        const recent = symptoms.slice(-3);
                        const isOnPeriod = recent.some(s => 
                            s.period_active === true || 
                            s.is_period === true ||
                            s.on_period === true ||
                            (s.notes && (
                                s.notes.toLowerCase().includes('per√≠odo') ||
                                s.notes.toLowerCase().includes('periodo') ||
                                s.notes.toLowerCase().includes('period') ||
                                s.notes.toLowerCase().includes('regla') ||
                                s.notes.toLowerCase().includes('menstruaci√≥n')
                            ))
                        );
                        if (isOnPeriod) {
                            return 'periodo';
                        }
                    }

                    // Si no hay s√≠ntomas registrados, usar s√≠ntoma del quiz
                    const primarySymptom = currentUser?.primary_symptom || currentUser?.main_symptom;
                    const symptomMap = {
                        'hot_flashes': 'sofocos',
                        'sofocos': 'sofocos',
                        'fatigue': 'fatiga',
                        'fatiga': 'fatiga',
                        'baja_energia': 'fatiga',
                        'low_energy': 'fatiga',
                        'insomnia': 'insomnio',
                        'insomnio': 'insomnio',
                        'anxiety': 'ansiedad',
                        'ansiedad': 'ansiedad',
                        'brain_fog': 'niebla_mental',
                        'niebla_mental': 'niebla_mental',
                        'mood': 'cambios_humor',
                        'cambios_humor': 'cambios_humor'
                    };

                    // PREMIUM: completamente personalizado por s√≠ntomas recientes
                    if (tier === 'premium') {
                        if (symptoms && symptoms.length >= 1) {
                            const recent = symptoms.slice(0, 3); // Los m√°s recientes primero
                            const avgSleep = recent.reduce((sum, s) => sum + (s.sleep || 5), 0) / recent.length;
                            const avgEnergy = recent.reduce((sum, s) => sum + (s.energy || 5), 0) / recent.length;
                            const avgHotFlashes = recent.reduce((sum, s) => sum + (s.hot_flashes || s.hotFlashes || 0), 0) / recent.length;
                            const avgAnxiety = recent.reduce((sum, s) => sum + (s.anxiety || 0), 0) / recent.length;
                            const avgBrainFog = recent.reduce((sum, s) => sum + (s.brain_fog || s.brainFog || 0), 0) / recent.length;
                            const avgMood = recent.reduce((sum, s) => sum + (s.mood || 5), 0) / recent.length;
                            
                            // ORDEN CORREGIDO: m√°s espec√≠fico primero
                            if (avgEnergy <= 4) return 'fatiga';
                            if (avgSleep <= 4) return 'insomnio';
                            if (avgHotFlashes >= 4) return 'sofocos';
                            if (avgAnxiety >= 5) return 'ansiedad';
                            if (avgBrainFog >= 4) return 'niebla_mental';
                            if (avgMood <= 4) return 'cambios_humor';
                        }
                        // Si no hay s√≠ntomas, usar s√≠ntoma del quiz
                        if (primarySymptom && symptomMap[primarySymptom]) {
                            return symptomMap[primarySymptom];
                        }
                        return 'sofocos';
                    }

                    // TRIAL: personalizado seg√∫n s√≠ntomas
                    if (tier === 'trial') {
                        if (symptoms && symptoms.length > 0) {
                            const recent = symptoms.slice(0, 2);
                            const avgEnergy = recent.reduce((sum, s) => sum + (s.energy || 5), 0) / recent.length;
                            const avgSleep = recent.reduce((sum, s) => sum + (s.sleep || 5), 0) / recent.length;
                            const avgHotFlashes = recent.reduce((sum, s) => sum + (s.hot_flashes || s.hotFlashes || 0), 0) / recent.length;
                            
                            if (avgEnergy <= 4) return 'fatiga';
                            if (avgSleep <= 4) return 'insomnio';
                            if (avgHotFlashes >= 4) return 'sofocos';
                        }
                        // Si no hay s√≠ntomas, usar s√≠ntoma del quiz
                        if (primarySymptom && symptomMap[primarySymptom]) {
                            return symptomMap[primarySymptom];
                        }
                        return 'sofocos';
                    }

                    // FREE: men√∫ rotativo semanal
                    const weekNumber = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 1)) / 604800000);
                    const symptomsList = ['sofocos', 'fatiga', 'insomnio', 'ansiedad', 'niebla_mental', 'dolor_articular', 'cambios_humor', 'hinchazon'];
                    return symptomsList[weekNumber % symptomsList.length];
                };
                
                const selectedSymptom = getSelectedSymptom();
                console.log('üéØ S√≠ntoma seleccionado:', selectedSymptom);
                
                // Para periodo: usar sofocos como base si no hay men√∫ espec√≠fico
                const menuKey = selectedSymptom === 'periodo' ? 'sofocos' : selectedSymptom;
                let recipes = menus[language === 'es' ? 'es' : 'en'][menuKey] || 
                              menus[language === 'es' ? 'es' : 'en']['sofocos'] || [];

                return (
                    <div className="pb-32 space-y-8" key={`nutrition-${language}`}>
                        <h2 className="text-3xl font-light gradient-text">{t[language].nutrition}</h2>

                        <div className={`${darkMode ? 'bg-rose-900' : 'bg-amber-50'} rounded-xl shadow p-5 border-l-4 border-rose-400`}>
                            <div className="flex items-start gap-3">
                                <span className="text-2xl">üíú</span>
                                <p className={`text-sm ${darkMode ? 'text-purple-200' : 'text-rose-900'} font-medium leading-relaxed`}>
                                    {getLumiMessage('nutrition')}
                                </p>
                            </div>
                        </div>

                        {/* DASHBOARD METAB√ìLICO - Trial y Premium */}
                        {(getUserTier() === 'premium' || getUserTier() === 'trial') && (
                            <div className="relative rounded-2xl shadow-2xl overflow-hidden mb-8" style={{
                                background: 'linear-gradient(135deg, rgba(254, 240, 138, 0.3) 0%, rgba(251, 207, 232, 0.3) 25%, rgba(216, 180, 254, 0.3) 50%, rgba(165, 180, 252, 0.3) 75%, rgba(254, 202, 202, 0.3) 100%)'
                            }}>
                                {/* Overlay sutil */}
                                <div className="absolute inset-0 bg-white/60 dark:bg-gray-900/60"></div>
                                
                                {/* Contenido */}
                                <div className="relative z-10 p-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <div>
                                            <h3 className="text-2xl font-semibold gradient-text mb-2">
                                                üêç {language === 'es' ? 'Tu Transformaci√≥n' : 'Your Transformation'}
                                            </h3>
                                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                {language === 'es' ? 'Como la serpiente muda su piel, t√∫ est√°s transform√°ndote' : 'Like the snake sheds its skin, you are transforming'}
                                            </p>
                                        </div>
                                        <div className="flex gap-2">
                                            {chartData && (
                                                <button
                                                    onClick={() => setShowDashboardModal(true)}
                                                    className="text-purple-600 hover:text-purple-700 text-sm font-semibold"
                                                >
                                                    üìä {language === 'es' ? 'Ver gr√°ficos' : 'View charts'}
                                                </button>
                                            )}
                                            <button
                                                onClick={() => {
                                                    setEditWeight(currentUser?.weight || '');
                                                    setEditHeight(currentUser?.height || '');
                                                    setEditAge(currentUser?.age || '');
                                                    setEditActivityLevel(currentUser?.activity_level || 'moderate');
                                                    setEditGoal(currentUser?.goal || 'maintain');
                                                    setShowProfileModal(true);
                                                }}
                                                className="text-purple-600 hover:text-purple-700 text-sm font-semibold"
                                            >
                                                ‚úèÔ∏è {language === 'es' ? 'Editar' : 'Edit'}
                                            </button>
                                        </div>
                                    </div>

                                {getMetrics() ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className={`${darkMode ? 'bg-blue-900/40' : 'bg-blue-50'} p-4 rounded-xl`}>
                                            <p className={`text-xs ${darkMode ? 'text-blue-300' : 'text-blue-600'} font-semibold mb-1`}>
                                                IMC
                                            </p>
                                            <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                                {getMetrics().bmi}
                                            </p>
                                        </div>
                                        <div className={`${darkMode ? 'bg-green-900/40' : 'bg-green-50'} p-4 rounded-xl`}>
                                            <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'} font-semibold mb-1`}>
                                                TMB
                                            </p>
                                            <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                                {getMetrics().bmr}
                                            </p>
                                        </div>
                                        <div className={`${darkMode ? 'bg-purple-900/40' : 'bg-purple-50'} p-4 rounded-xl`}>
                                            <p className={`text-xs ${darkMode ? 'text-purple-300' : 'text-purple-600'} font-semibold mb-1`}>
                                                TDEE
                                            </p>
                                            <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                                {getMetrics().tdee}
                                            </p>
                                        </div>
                                        <div className={`${darkMode ? 'bg-pink-900/40' : 'bg-pink-50'} p-4 rounded-xl`}>
                                            <p className={`text-xs ${darkMode ? 'text-pink-300' : 'text-pink-600'} font-semibold mb-1`}>
                                                {language === 'es' ? 'Objetivo' : 'Target'}
                                            </p>
                                            <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                                {getMetrics().target}
                                            </p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className={`${darkMode ? 'bg-yellow-900/40 border-yellow-700' : 'bg-yellow-50 border-yellow-200'} border-2 border-dashed rounded-xl p-6 text-center`}>
                                        <p className={`text-sm ${darkMode ? 'text-yellow-200' : 'text-yellow-800'} mb-3`}>
                                            {language === 'es' 
                                                ? '‚ö†Ô∏è Completa tu perfil metab√≥lico para men√∫s ultra-personalizados'
                                                : '‚ö†Ô∏è Complete your metabolic profile for ultra-personalized menus'}
                                        </p>
                                        <button
                                            onClick={() => {
                                                setEditWeight(currentUser?.weight || '');
                                                setEditHeight(currentUser?.height || '');
                                                setEditAge(currentUser?.age || '');
                                                setEditActivityLevel(currentUser?.activity_level || 'moderate');
                                                setEditGoal(currentUser?.goal || 'maintain');
                                                setShowProfileModal(true);
                                            }}
                                            className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition"
                                        >
                                            {language === 'es' ? 'Completar Ahora' : 'Complete Now'}
                                        </button>
                                    </div>
                                )}
                                </div>
                            </div>
                        )}

                        {/* GR√ÅFICOS DE TENDENCIA - Trial y Premium con s√≠ntomas */}
                        {(getUserTier() === 'premium' || getUserTier() === 'trial') && symptoms.length >= 3 && (
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-6 mb-8`}>
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 className="text-lg font-semibold gradient-text">
                                            üìä {language === 'es' ? 'Tus Tendencias' : 'Your Trends'}
                                        </h3>
                                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                            {language === 'es' ? '√öltimos 7 d√≠as' : 'Last 7 days'}
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => setCurrentPage('symptoms')}
                                        className="text-xs text-purple-600 font-semibold hover:underline"
                                    >
                                        {language === 'es' ? 'Ver detalle ‚Üí' : 'See detail ‚Üí'}
                                    </button>
                                </div>

                                {/* Mini tarjetas de promedio */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                    {[
                                        { label: language === 'es' ? 'Sue√±o' : 'Sleep', key: 'sleep', color: 'purple', icon: 'üò¥' },
                                        { label: language === 'es' ? 'Energ√≠a' : 'Energy', key: 'energy', color: 'pink', icon: '‚ö°' },
                                        { label: language === 'es' ? '√Ånimo' : 'Mood', key: 'mood', color: 'blue', icon: 'üíú' },
                                        { label: language === 'es' ? 'Sofocos' : 'Hot flashes', key: 'hot_flashes', color: 'orange', icon: 'üî•' }
                                    ].map(metric => {
                                        const last7 = symptoms.slice(0, 7);
                                        const avg = last7.reduce((sum, s) => sum + (s[metric.key] || 0), 0) / last7.length;
                                        const prev7 = symptoms.slice(7, 14);
                                        const prevAvg = prev7.length > 0 ? prev7.reduce((sum, s) => sum + (s[metric.key] || 0), 0) / prev7.length : avg;
                                        const trend = avg > prevAvg ? '‚Üë' : avg < prevAvg ? '‚Üì' : '‚Üí';
                                        const trendColor = metric.key === 'hot_flashes' 
                                            ? (avg < prevAvg ? 'text-green-500' : avg > prevAvg ? 'text-red-500' : 'text-gray-400')
                                            : (avg > prevAvg ? 'text-green-500' : avg < prevAvg ? 'text-red-500' : 'text-gray-400');
                                        return (
                                            <div key={metric.key} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-xl p-3 text-center`}>
                                                <div className="text-lg mb-1">{metric.icon}</div>
                                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} mb-1`}>{metric.label}</p>
                                                <p className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{avg.toFixed(1)}</p>
                                                <p className={`text-sm font-semibold ${trendColor}`}>{trend}</p>
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* Barra visual simple para cada m√©trica */}
                                {[
                                    { label: language === 'es' ? 'Sue√±o' : 'Sleep', key: 'sleep', color: '#9333ea' },
                                    { label: language === 'es' ? 'Energ√≠a' : 'Energy', key: 'energy', color: '#ec4899' },
                                    { label: language === 'es' ? '√Ånimo' : 'Mood', key: 'mood', color: '#06b6d4' }
                                ].map(metric => {
                                    const last7 = symptoms.slice(0, 7).reverse();
                                    return (
                                        <div key={metric.key} className="mb-3">
                                            <p className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{metric.label}</p>
                                            <div className="flex items-end gap-1 h-10">
                                                {last7.map((s, i) => {
                                                    const val = s[metric.key] || 0;
                                                    const height = (val / 10) * 100;
                                                    return (
                                                        <div
                                                            key={i}
                                                            className="flex-1 rounded-t-sm transition-all"
                                                            style={{ height: height + '%', backgroundColor: metric.color, opacity: 0.7 + (i / last7.length) * 0.3 }}
                                                            title={val + '/10'}
                                                        />
                                                    );
                                                })}
                                            </div>
                                            <div className="flex justify-between mt-1">
                                                <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                                    {language === 'es' ? 'hace 7 d√≠as' : '7 days ago'}
                                                </span>
                                                <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                                    {language === 'es' ? 'hoy' : 'today'}
                                                </span>
                                            </div>
                                        </div>
                                    );
                                })}

                                {/* Para trial: mensaje para upgrade */}
                            </div>
                        )}

                        {/* PREVIEW gr√°ficos para TRIAL - d√≠a 3 */}
                        {getUserTier() === 'trial' && symptoms.length >= 3 && (
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-6 mb-8 relative overflow-hidden`}>
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-semibold gradient-text">
                                        üìä {language === 'es' ? 'Tus Tendencias' : 'Your Trends'}
                                    </h3>
                                    <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full font-semibold">
                                        {language === 'es' ? 'üíé Premium' : 'üíé Premium'}
                                    </span>
                                </div>

                                {/* Preview borroso */}
                                <div className="relative">
                                    <div className="blur-sm opacity-50 pointer-events-none">
                                        <div className="grid grid-cols-4 gap-3 mb-4">
                                            {['üò¥', '‚ö°', 'üíú', 'üî•'].map((icon, i) => (
                                                <div key={i} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-xl p-3 text-center`}>
                                                    <div className="text-lg mb-1">{icon}</div>
                                                    <p className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>7.{i}</p>
                                                    <p className="text-sm text-green-500">‚Üë</p>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex items-end gap-1 h-12">
                                            {[6,7,5,8,7,9,8].map((v, i) => (
                                                <div key={i} className="flex-1 rounded-t-sm bg-purple-400" style={{ height: (v/10*100) + '%' }} />
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Overlay CTA */}
                                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                                        <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2 text-center`}>
                                            {language === 'es' 
                                                ? '¬°Ya tienes datos suficientes para ver tus patrones!' 
                                                : 'You have enough data to see your patterns!'}
                                        </p>
                                        <button
                                            onClick={() => setCurrentPage('premium')}
                                            className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-lg font-semibold text-sm hover:opacity-90 transition"
                                        >
                                            {language === 'es' ? 'üíé Desbloquear tendencias' : 'üíé Unlock trends'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg overflow-hidden`}>
                            <div className="bg-gradient-to-r from-rose-400 to-amber-300 text-white p-6">
                                <h3 className="text-2xl font-semibold">{language === 'es' ? '‚ú® Tu Men√∫ de Hoy' : '‚ú® Your Menu Today'}</h3>
                                <p className="text-sm opacity-90 mt-1">
                                    {getUserTier() === 'free'
                                        ? (language === 'es' ? 'Tu men√∫ de esta semana' : 'Your menu this week')
                                        : (language === 'es' ? 'Adaptado seg√∫n c√≥mo te sientes' : 'Adapted based on how you feel')}
                                </p>
                            </div>
                            
                            <div className="p-8 space-y-8">
                                {recipes.map((recipe, idx) => (
                                    <div key={idx} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-xl p-6 border-l-4 border-rose-400 space-y-6`}>
                                        {/* HEADER CON NOMBRE Y CALOR√çAS */}
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1">
                                                <h4 className="text-2xl font-bold mb-2 gradient-text">{recipe.name}</h4>
                                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>
                                                    {mealLabels[recipe.meal] || recipe.meal}
                                                </p>
                                                
                                                {/* HORARIO RECOMENDADO */}
                                                {recipe.horario && (
                                                    <div className={`${darkMode ? 'bg-blue-900' : 'bg-blue-100'} inline-block px-4 py-2 rounded-lg`}>
                                                        <p className={`text-sm font-bold ${darkMode ? 'text-blue-200' : 'text-blue-900'}`}>
                                                            üïê {language === 'es' ? 'Hora recomendada' : 'Recommended time'}: {recipe.horario}
                                                        </p>
                                                    </div>
                                                )}
                                            </div>
                                            <span className={`${darkMode ? 'bg-purple-900' : 'bg-purple-100'} text-purple-700 px-4 py-2 rounded-xl text-lg font-bold`}>
                                                {recipe.calories} cal
                                            </span>
                                        </div>

                                        {/* POR QU√â ESTE HORARIO - CIENCIA */}
                                        {recipe.whyHorario && (
                                            <div className={`${darkMode ? 'bg-indigo-900' : 'bg-indigo-50'} p-4 rounded-lg border-l-4 border-indigo-500`}>
                                                <p className={`text-sm ${darkMode ? 'text-indigo-200' : 'text-indigo-900'} leading-relaxed`}>
                                                    <strong className="font-bold">‚è∞ {language === 'es' ? '¬øPor qu√© a esta hora?' : 'Why at this time?'}</strong><br/>
                                                    {recipe.whyHorario}
                                                </p>
                                            </div>
                                        )}

                                        {/* POR QU√â ESTE MEN√ö - BENEFICIOS */}
                                        <div className={`${darkMode ? 'bg-purple-900' : 'bg-purple-50'} p-4 rounded-lg border-l-4 border-purple-500`}>
                                            <p className={`text-sm ${darkMode ? 'text-purple-200' : 'text-purple-900'} font-medium leading-relaxed`}>
                                                <strong className="font-bold">üíú {language === 'es' ? '¬øPor qu√© este men√∫?' : 'Why this menu?'}</strong><br/>
                                                {recipe.why}
                                            </p>
                                        </div>

                                        {/* INGREDIENTES CON DETALLES CIENT√çFICOS */}
                                        <div>
                                            <h5 className="text-lg font-bold mb-4 flex items-center gap-2">
                                                <span>ü•ó</span>
                                                {t[language].ingredients}
                                            </h5>
                                            <div className="space-y-4">
                                                {recipe.ingredients.map((ing, i) => {
                                                    // Detectar si es string (Supabase sin parsear) u objeto (parseado o fallback)
                                                    const isString = typeof ing === 'string';
                                                    const ingredientName = isString ? ing : (ing.ingredient || ing.name);
                                                    const hasDetails = !isString && (ing.qty || ing.why);
                                                    
                                                    return (
                                                        <div key={i} className={`${darkMode ? 'bg-gray-600' : 'bg-white'} p-4 rounded-lg border-l-4 border-amber-500`}>
                                                            {/* Nombre y cantidad */}
                                                            <div className="flex justify-between items-center mb-2">
                                                                <p className={`font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                                                    {ingredientName}
                                                                </p>
                                                                {hasDetails && ing.qty && (
                                                                    <span className={`${darkMode ? 'bg-amber-800' : 'bg-amber-200'} text-amber-900 px-3 py-1 rounded-full text-sm font-bold`}>
                                                                        {ing.qty}{ing.unit || ''}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            
                                                            {/* Por qu√© este ingrediente - CIENCIA (solo si hay) */}
                                                            {hasDetails && ing.why && (
                                                                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-3 leading-relaxed`}>
                                                                    <strong className="text-green-600">üí° {language === 'es' ? 'Beneficio' : 'Benefit'}:</strong> {ing.why}
                                                                </p>
                                                            )}
                                                        
                                                        {/* Versiones: asequible y gourmet (solo si hay) */}
                                                        {hasDetails && (ing.eco || ing.gourmet) && (
                                                            <div className="flex gap-2 text-xs flex-wrap mt-2">
                                                                {ing.eco && (
                                                                    <div className={`${darkMode ? 'bg-blue-800' : 'bg-blue-100'} px-3 py-1 rounded-full`}>
                                                                        <span className={`${darkMode ? 'text-blue-200' : 'text-blue-900'} font-semibold`}>
                                                                            üí∞ {language === 'es' ? 'Asequible' : 'Budget'}: {ing.eco}
                                                                        </span>
                                                                    </div>
                                                                )}
                                                                {ing.gourmet && (
                                                                    <div className={`${darkMode ? 'bg-amber-800' : 'bg-amber-100'} px-3 py-1 rounded-full`}>
                                                                        <span className={`${darkMode ? 'text-amber-200' : 'text-amber-900'} font-semibold`}>
                                                                            ‚ú® Gourmet: {ing.gourmet}
                                                                        </span>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        {/* PREPARACI√ìN */}
                                        <div>
                                            <h5 className="text-lg font-bold mb-4 flex items-center gap-2">
                                                <span>üë®‚Äçüç≥</span>
                                                {t[language].preparation}
                                            </h5>
                                            <ol className={`space-y-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                {recipe.steps.map((step, i) => (
                                                    <li key={i} className="flex gap-3">
                                                        <span className="flex-shrink-0 w-6 h-6 bg-gradient-to-r from-rose-400 to-amber-300 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                                            {i + 1}
                                                        </span>
                                                        <span className="flex-1 leading-relaxed">{step}</span>
                                                    </li>
                                                ))}
                                            </ol>
                                        </div>

                                        {/* COOKING TIPS - IA para trial y premium */}
                                        {getUserTier() !== 'free' && (
                                            <div className={`${darkMode ? 'bg-green-900/40' : 'bg-green-50'} p-4 rounded-lg border-l-4 border-green-500`}>
                                                <div className="flex items-center justify-between mb-3">
                                                    <h5 className="text-sm font-bold flex items-center gap-2">
                                                        <span>üí°</span>
                                                        {language === 'es' ? 'Consejos para preservar nutrientes' : 'Tips to preserve nutrients'}
                                                    </h5>
                                                    {!aiCookingTips[recipe.name] && (
                                                        <button
                                                            onClick={() => fetchCookingTips(recipe)}
                                                            disabled={loadingTips[recipe.name]}
                                                            className="text-xs bg-green-500 text-white px-3 py-1 rounded-full font-semibold hover:bg-green-600 transition disabled:opacity-50"
                                                        >
                                                            {loadingTips[recipe.name] 
                                                                ? '‚è≥ Generando...' 
                                                                : '‚ú® Ver consejos'}
                                                        </button>
                                                    )}
                                                </div>
                                                
                                                {/* Tips est√°ticos (siempre visibles) */}
                                                {recipe.cookingTips && recipe.cookingTips.length > 0 && !aiCookingTips[recipe.name] && (
                                                    <p className={`text-sm ${darkMode ? 'text-green-100' : 'text-green-800'} leading-relaxed`}>
                                                        {recipe.cookingTips[0].tip || recipe.cookingTips[0]}
                                                    </p>
                                                )}
                                                
                                                {/* Tips generados por IA */}
                                                {aiCookingTips[recipe.name] && (
                                                    <div className="space-y-2">
                                                        {aiCookingTips[recipe.name].map((tip, i) => (
                                                            <div key={i} className="flex items-start gap-2">
                                                                <span className="text-green-500 font-bold text-sm mt-0.5">‚úì</span>
                                                                <p className={`text-sm ${darkMode ? 'text-green-100' : 'text-green-800'} leading-relaxed`}>
                                                                    {tip}
                                                                </p>
                                                            </div>
                                                        ))}
                                                        <p className={`text-xs mt-2 ${darkMode ? 'text-green-400' : 'text-green-600'} italic`}>
                                                            ‚ú® {language === 'es' ? 'Consejos personalizados para esta receta' : 'Personalized tips for this recipe'}
                                                        </p>
                                                    </div>
                                                )}
                                                
                                                {/* Estado cargando */}
                                                {loadingTips[recipe.name] && (
                                                    <div className="flex items-center gap-2 mt-2">
                                                        <div className="w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                                                        <p className={`text-sm ${darkMode ? 'text-green-300' : 'text-green-700'}`}>
                                                            {language === 'es' ? 'LUMI est√° analizando los ingredientes...' : 'LUMI is analyzing the ingredients...'}
                                                        </p>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* NUTRIENT TIPS - CIENCIA DETR√ÅS */}
                                        {recipe.nutrientTips && recipe.nutrientTips.length > 0 && (
                                            <div>
                                                <h5 className="text-lg font-bold mb-4 flex items-center gap-2">
                                                    <span>üî¨</span>
                                                    {language === 'es' ? 'Ciencia detr√°s de este men√∫' : 'Science behind this menu'}
                                                </h5>
                                                <div className="space-y-3">
                                                    {recipe.nutrientTips.map((tip, i) => (
                                                        <div key={i} className={`${darkMode ? 'bg-blue-900' : 'bg-blue-50'} p-4 rounded-lg border-l-4 border-blue-500`}>
                                                            <p className={`font-bold mb-2 ${darkMode ? 'text-blue-200' : 'text-blue-900'}`}>
                                                                {tip.icon} {tip.title}
                                                            </p>
                                                            <p className={`text-sm ${darkMode ? 'text-blue-100' : 'text-blue-800'} leading-relaxed`}>
                                                                {tip.tip}
                                                            </p>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className={`${darkMode ? 'bg-indigo-900' : 'bg-indigo-50'} rounded-xl p-6 border-l-4 border-indigo-500`}>
                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                {language === 'es'
                                    ? 'üí° Este men√∫ se adapta seg√∫n tus s√≠ntomas registrados. Vuelve ma√±ana para un men√∫ diferente basado en c√≥mo te sientes.'
                                    : 'üí° This menu adapts based on your logged symptoms. Come back tomorrow for a different menu based on how you feel.'}
                            </p>
                        </div>
                    </div>
                );
            };

            const renderExercise = () => {
                const allExercises = getExercises();
                const objectives = { strength: language === 'es' ? 'üí™ Ganar Fuerza' : 'üí™ Build Strength', weightLoss: language === 'es' ? '‚ö° Perder Peso' : '‚ö° Lose Weight', hormonal: language === 'es' ? 'üßò Equilibrio Hormonal' : 'üßò Hormonal Balance' };
                
                // Funci√≥n para filtrar ejercicios seg√∫n nivel de usuario
                const getFiltered = () => {
                    if (!allExercises || allExercises.length === 0) return [];
                    const tier = getUserTier();

                    // FREE: est√°ticos por semana
                    if (tier === 'free') {
                        const today = new Date();
                        const startOfYear = new Date(today.getFullYear(), 0, 1);
                        const weekNumber = Math.floor(((today - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
                        const startIdx = (weekNumber * 3) % allExercises.length;
                        const result = [];
                        for (let i = 0; i < 3; i++) {
                            result.push(allExercises[(startIdx + i) % allExercises.length]);
                        }
                        return result;
                    }

                    // TRIAL / PREMIUM: detectar s√≠ntomas - usar slice(0,3) porque ya vienen DESC
                    let hasJointPain = false, hasLowEnergy = false, hasHighAnxiety = false, hasLowSleep = false;
                    let inPeriod = isInPeriodDays();
                    
                    if (symptoms && symptoms.length > 0) {
                        const recent = symptoms.slice(0, 3); // Los m√°s recientes (BD los devuelve DESC)
                        recent.forEach(s => {
                            if ((s.hot_flashes || s.hotFlashes || 0) >= 6) hasJointPain = true; // sofocos altos ‚Üí no HIIT
                            if ((s.energy || 10) <= 4) hasLowEnergy = true;
                            if ((s.anxiety || 0) >= 5) hasHighAnxiety = true;
                            if ((s.sleep || 10) <= 4) hasLowSleep = true;
                        });
                    }

                    // En periodo ‚Üí ejercicios suaves espec√≠ficos
                    if (inPeriod) {
                        return [
                            {
                                name: language === 'es' ? 'Yoga Restaurativo' : 'Restorative Yoga',
                                duration: '30 min', difficulty: language === 'es' ? 'F√°cil' : 'Easy', freq: language === 'es' ? 'Estos d√≠as' : 'These days',
                                why: language === 'es' ? 'Estos d√≠as tu cuerpo pide descanso, no esfuerzo. Este yoga le da exactamente eso: calma y espacio para recuperarse.' : 'These days your body asks for rest, not effort. This yoga gives exactly that: calm and space to recover.',
                                science: language === 'es' ? 'Estudios muestran que este tipo de yoga reduce el dolor estos d√≠as hasta un 30-40%. Tu cuerpo lo agradece.' : 'Studies show this type of yoga reduces pain these days up to 30-40%. Your body appreciates it.',
                                steps: language === 'es'
                                    ? ['Posturas: Ni√±o, piernas en pared, savasana', 'Mant√©n cada postura 3-5 minutos', 'Pon manta bajo rodillas si necesitas', 'Respiraci√≥n profunda: 4 seg entrada, 6 seg salida', 'No fuerces ‚Äî estos d√≠as pide descanso', 'Equipo: Colchoneta, manta']
                                    : ['Poses: Child\'s, legs up wall, savasana', 'Hold each pose 3-5 minutes', 'Put blanket under knees if needed', 'Deep breathing: 4 sec in, 6 sec out', 'Don\'t force ‚Äî these days ask for rest', 'Equipment: Mat, blanket']
                            },
                            {
                                name: language === 'es' ? 'Caminata Suave' : 'Gentle Walk',
                                duration: '20 min', difficulty: language === 'es' ? 'F√°cil' : 'Easy', freq: language === 'es' ? 'Estos d√≠as' : 'These days',
                                why: language === 'es' ? 'No necesitas hacer mucho estos d√≠as. Caminar suave ya es suficiente. Le ayuda a tu cuerpo a sentirse mejor sin pedirte nada.' : 'You don\'t need to do much these days. Walking gently is enough. It helps your body feel better without asking anything of you.',
                                science: language === 'es' ? 'Con 20 minutos caminando tu cuerpo libera algo que calma el dolor de forma natural. Es un regalo f√°cil para ti.' : 'In 20 minutes of walking your body releases something that naturally calms pain. It\'s an easy gift to yourself.',
                                steps: language === 'es'
                                    ? ['Ritmo tranquilo, sin prisa', 'Al aire libre si es posible', 'Si tienes c√≥licos fuertes, espera a que bajen', 'Respira profundo y disfruta', 'Equipo: Zapatillas c√≥modas']
                                    : ['Relaxed pace, no rush', 'Outdoors if possible', 'If cramps are strong, wait until they ease', 'Breathe deep and enjoy', 'Equipment: Comfortable shoes']
                            },
                            {
                                name: language === 'es' ? 'Estiramiento P√©lvico' : 'Pelvic Stretch',
                                duration: '15 min', difficulty: language === 'es' ? 'F√°cil' : 'Easy', freq: language === 'es' ? 'Estos d√≠as' : 'These days',
                                why: language === 'es' ? 'Va directo a donde duele. Es ese estiramiento que la mayor√≠a no conoce pero que funciona muy bien para la zona baja.' : 'Goes directly to where it hurts. It\'s the stretch most don\'t know but works really well for the lower area.',
                                science: language === 'es' ? 'Muchas mujeres reportan que con solo 2-3 semanas de esto notan menos tensi√≥n en la zona baja. Es simple pero muy efectivo.' : 'Many women report that with just 2-3 weeks of this they notice less tension in the lower area. Simple but very effective.',
                                steps: language === 'es'
                                    ? ['Tumbada boca arriba, rodillas flexionadas', 'Cruza una pierna formando n√∫mero 4', 'Tira suavemente de la otra pierna hacia ti', 'Mant√©n 30 seg, respira profundo', 'Cambia de lado', 'Luego: rodillas al pecho, balanc√©ate suave']
                                    : ['Lie on back, knees bent', 'Cross one leg forming figure 4', 'Gently pull the other leg toward you', 'Hold 30 sec, breathe deep', 'Switch sides', 'Then: knees to chest, gently rock']
                            }
                        ];
                    }
                    
                    // Filtrar seg√∫n s√≠ntomas
                    let filtered = allExercises.filter(ex => {
                        if (hasJointPain && (ex.name.toLowerCase().includes('hiit') || ex.name.toLowerCase().includes('saltar') || ex.name.toLowerCase().includes('jump'))) return false;
                        if (hasLowEnergy && (ex.difficulty === 'Alta' || ex.difficulty === 'High')) return false;
                        return true;
                    });

                    // Ansiedad alta o mal sue√±o ‚Üí reordenar: suaves primero
                    if (hasHighAnxiety || hasLowSleep) {
                        filtered.sort((a, b) => {
                            const softA = (a.difficulty === 'F√°cil' || a.difficulty === 'Easy') ? 0 : 1;
                            const softB = (b.difficulty === 'F√°cil' || b.difficulty === 'Easy') ? 0 : 1;
                            return softA - softB;
                        });
                    }
                    
                    return filtered.slice(0, 3);
                };
                
                const exercises = getFiltered();

                return (
                    <div className="pb-32 space-y-8" key={`exercise-${language}`}>
                        <div>
                            <h2 className="text-3xl font-light gradient-text">{t[language].exercise}</h2>
                            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{objectives[exerciseGoal]}</p>
                        </div>

                        <div className={`${darkMode ? 'bg-rose-900' : 'bg-amber-50'} rounded-xl shadow p-5 border-l-4 border-rose-400`}>
                            <div className="flex items-start gap-3">
                                <span className="text-2xl">üíú</span>
                                <p className={`text-sm ${darkMode ? 'text-purple-200' : 'text-rose-900'} font-medium leading-relaxed`}>
                                    {getLumiMessage('exercise')}
                                </p>
                            </div>
                        </div>

                        {/* EJERCICIOS PERSONALIZADOS - Trial y Premium */}
                        {(getUserTier() === 'premium' || getUserTier() === 'trial') && (
                            <div className={`${darkMode ? 'bg-gray-800 border-purple-700' : 'bg-purple-50 border-purple-200'} rounded-xl p-5 border`}>
                                <div className="flex items-center justify-between mb-3">
                                    <div>
                                        <h3 className={`font-semibold ${darkMode ? 'text-purple-200' : 'text-purple-800'}`}>
                                            üíé {language === 'es' ? 'Rutina personalizada para ti' : 'Personalized routine for you'}
                                        </h3>
                                        <p className={`text-xs mt-1 ${darkMode ? 'text-purple-300' : 'text-purple-600'}`}>
                                            {language === 'es' 
                                                ? 'Basada en tus s√≠ntomas recientes y condiciones de salud' 
                                                : 'Based on your recent symptoms and health conditions'}
                                        </p>
                                    </div>
                                    {!aiExercises && (
                                        <button
                                            onClick={fetchPersonalizedExercises}
                                            disabled={loadingExercises}
                                            className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90 transition disabled:opacity-50 whitespace-nowrap"
                                        >
                                            {loadingExercises 
                                                ? (language === 'es' ? '‚è≥ Generando...' : '‚è≥ Generating...')
                                                : (language === 'es' ? '‚ú® Personalizar' : '‚ú® Personalize')}
                                        </button>
                                    )}
                                    {aiExercises && (
                                        <button
                                            onClick={() => setAiExercises(null)}
                                            className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} underline`}
                                        >
                                            {language === 'es' ? 'Ver est√°ndar' : 'View standard'}
                                        </button>
                                    )}
                                </div>

                                {loadingExercises && (
                                    <div className="flex items-center gap-3 py-4">
                                        <div className="w-5 h-5 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                                        <p className={`text-sm ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>
                                            {language === 'es' 
                                                ? 'Analizando tus s√≠ntomas para crear tu rutina...' 
                                                : 'Analyzing your symptoms to create your routine...'}
                                        </p>
                                    </div>
                                )}

                                {aiExercises && (
                                    <div className="space-y-3 mt-3">
                                        {aiExercises.map((ex, i) => (
                                            <div key={i} className={`${darkMode ? 'bg-gray-700' : 'bg-white'} rounded-lg p-4`}>
                                                <div className="flex items-start justify-between gap-2 mb-2">
                                                    <h4 className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{ex.name}</h4>
                                                    <div className="flex gap-2 shrink-0">
                                                        <span className={`text-xs px-2 py-1 rounded-full ${darkMode ? 'bg-rose-900 text-rose-200' : 'bg-rose-100 text-rose-700'}`}>{ex.duration}</span>
                                                        <span className={`text-xs px-2 py-1 rounded-full ${darkMode ? 'bg-gray-600 text-gray-200' : 'bg-gray-100 text-gray-600'}`}>{ex.difficulty}</span>
                                                    </div>
                                                </div>
                                                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'} mb-2`}>{ex.why}</p>
                                                {ex.steps && (
                                                    <ol className="space-y-1">
                                                        {ex.steps.map((step, j) => (
                                                            <li key={j} className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} flex gap-2`}>
                                                                <span className="text-purple-500 font-bold shrink-0">{j+1}.</span>
                                                                {step}
                                                            </li>
                                                        ))}
                                                    </ol>
                                                )}
                                                {ex.youtube && (
                                                    <div className="mt-4 p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                                                        <p className="text-sm font-medium text-red-800 mb-2">
                                                            üé• {language === 'es' ? 'Video de referencia:' : 'Reference video:'}
                                                        </p>
                                                        <a
                                                            href={ex.youtube}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="text-red-600 underline text-sm hover:text-red-800"
                                                        >
                                                            {language === 'es' ? 'Ver en YouTube ‚Üí' : 'Watch on YouTube ‚Üí'}
                                                        </a>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        <p className={`text-xs ${darkMode ? 'text-purple-400' : 'text-purple-600'} italic text-center mt-2`}>
                                            ‚ú® {language === 'es' ? 'Rutina adaptada a c√≥mo te has sentido esta semana' : 'Routine adapted to how you\'ve felt this week'}
                                        </p>
                                    </div>
                                )}

                                {!aiExercises && !loadingExercises && symptoms.length === 0 && (
                                    <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} mt-2`}>
                                        {language === 'es' 
                                            ? 'Registra algunos s√≠ntomas para personalizar tu rutina' 
                                            : 'Track some symptoms to personalize your routine'}
                                    </p>
                                )}
                            </div>
                        )}

                        {/* NUDGE FREE ‚Üí PREMIUM */}
                        {getUserTier() === 'free' && (
                            <div className={`${darkMode ? 'bg-purple-900/40 border-purple-700' : 'bg-purple-50 border-purple-200'} rounded-xl p-4 border flex items-start gap-3`}>
                                <span className="text-xl">‚ú®</span>
                                <div>
                                    <p className={`text-sm font-semibold ${darkMode ? 'text-purple-200' : 'text-purple-800'}`}>
                                        {language === 'es' ? 'Con Premium, estos ejercicios se adaptan cada d√≠a seg√∫n c√≥mo te sientes' : 'With Premium, these exercises adapt every day based on how you feel'}
                                    </p>
                                    <p className={`text-xs mt-1 ${darkMode ? 'text-purple-300' : 'text-purple-600'}`}>
                                        {language === 'es' 
                                            ? 'Si tienes dolor articular, bajo √°nimo o est√°s en periodo, Lumera lo detecta y ajusta autom√°ticamente.' 
                                            : 'If you have joint pain, low mood or are on your period, Lumera detects it and adjusts automatically.'}
                                    </p>
                                </div>
                            </div>
                        )}

                        <div className="flex gap-4 overflow-x-auto pb-4">
                            {['strength', 'weightLoss', 'hormonal'].map((goal) => (
                                <button key={goal} onClick={() => setExerciseGoal(goal)} className={`px-6 py-3 rounded-lg font-semibold whitespace-nowrap transition ${exerciseGoal === goal ? 'bg-rose-500 text-white' : darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'}`}>
                                    {goal === 'strength' ? t[language].strength : goal === 'weightLoss' ? t[language].weightLoss : t[language].hormonal}
                                </button>
                            ))}
                        </div>

                        <div className="space-y-6">
                            {exercises.map((ex, idx) => (
                                <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg overflow-hidden`}>
                                    <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6">
                                        <h3 className="text-2xl font-semibold mb-2">{ex.name}</h3>
                                        <div className="flex gap-4 text-sm flex-wrap">
                                            <span>‚è± {ex.duration}</span>
                                            <span>üí™ {ex.difficulty}</span>
                                            <span>üìÖ {ex.freq}</span>
                                        </div>
                                    </div>

                                    <div className="p-6 space-y-4">
                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-yellow-50'} p-4 rounded-lg border-l-4 border-yellow-500`}>
                                            <p className={`text-sm font-semibold mb-2 ${darkMode ? 'text-yellow-300' : 'text-yellow-900'}`}>üí° {t[language].why}:</p>
                                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{ex.why}</p>
                                        </div>

                                        {ex.steps && ex.steps.length > 0 && (
                                            <div className={`${darkMode ? 'bg-gray-700' : 'bg-green-50'} p-4 rounded-lg border-l-4 border-green-600`}>
                                                <p className={`text-sm font-semibold mb-3 ${darkMode ? 'text-green-300' : 'text-green-900'}`}>üìã {language === 'es' ? 'C√≥mo hacerlo' : 'How to do it'}:</p>
                                                <ol className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} space-y-2 list-decimal list-inside`}>
                                                    {ex.steps.map((step, i) => (
                                                        <li key={i}>{step}</li>
                                                    ))}
                                                </ol>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className={`${darkMode ? 'bg-indigo-900' : 'bg-indigo-50'} rounded-xl p-6 border-l-4 border-indigo-500`}>
                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                {getUserTier() === 'free'
                                    ? (language === 'es'
                                        ? 'üí° Con Premium, estos ejercicios se adaptan cada d√≠a seg√∫n c√≥mo te sientes.'
                                        : 'üí° With Premium, these exercises adapt every day based on how you feel.')
                                    : (language === 'es'
                                        ? 'üí° Estos ejercicios se adaptan seg√∫n tus restricciones y energ√≠a.'
                                        : 'üí° These exercises adapt based on your restrictions and energy.')}
                            </p>
                        </div>
                    </div>
                );
            };

            const renderSymptoms = () => {
                return (
                    <div className="pb-32 space-y-8" key={`symptoms-${language}`}>
                        <h2 className="text-3xl font-light gradient-text">{t[language].symptoms}</h2>
                        
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 space-y-6`}>
                            <h3 className="font-semibold text-lg">{language === 'es' ? 'Registra tu d√≠a' : 'Track your day'}</h3>
                            
                            <div className="space-y-4">
                                {[
                                    { key: 'sleep', label: language === 'es' ? 'Calidad del sue√±o' : 'Sleep quality', emoji: 'üò¥' },
                                    { key: 'energy', label: language === 'es' ? 'Nivel de energ√≠a' : 'Energy level', emoji: '‚ö°' },
                                    { key: 'mood', label: language === 'es' ? '√Ånimo' : 'Mood', emoji: 'üòä' },
                                    { key: 'hotFlashes', label: language === 'es' ? 'Sofocos' : 'Hot flashes', emoji: 'üî•' },
                                    { key: 'anxiety', label: language === 'es' ? 'Ansiedad' : 'Anxiety', emoji: 'üò∞' },
                                    { key: 'vaginalDryness', label: language === 'es' ? 'Sequedad vaginal' : 'Vaginal dryness', emoji: 'üíß' },
                                    { key: 'brainFog', label: language === 'es' ? 'Niebla mental' : 'Brain fog', emoji: 'üå´Ô∏è' },
                                    { key: 'memory', label: language === 'es' ? 'Memoria/Claridad' : 'Memory/Clarity', emoji: 'üß†' }
                                ].map((item) => (
                                    <div key={item.key}>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-sm font-semibold">{item.emoji} {item.label}</label>
                                            <span className="text-amber-700 font-bold">{symptomForm[item.key]}/10</span>
                                        </div>
                                        <input type="range" min="0" max="10" value={symptomForm[item.key]} onChange={(e) => setSymptomForm({...symptomForm, [item.key]: parseInt(e.target.value)})} className="w-full accent-rose-500"/>
                                    </div>
                                ))}

                                <div>
                                    <label className="block text-sm font-semibold mb-2">{language === 'es' ? 'Fecha' : 'Date'}</label>
                                    <input type="date" value={symptomForm.date} onChange={(e) => setSymptomForm({...symptomForm, date: e.target.value})} className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}/>
                                </div>
                            </div>

                            <button onClick={() => {
                                const newSymptoms = [...symptoms, symptomForm];
                                setSymptoms(newSymptoms);
                                setSymptomForm({ sleep: 5, energy: 5, mood: 5, hotFlashes: 0, anxiety: 5, vaginalDryness: 0, brainFog: 0, memory: 5, date: new Date().toISOString().split('T')[0] });
                                // Verificar patrones despu√©s de guardar
                                setTimeout(() => checkAndShowPattern(newSymptoms), 500);
                                // Mostrar notificaci√≥n personalizada
                                const notification = document.createElement('div');
                                notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-rose-400 to-amber-300 text-white px-6 py-4 rounded-xl shadow-2xl z-50 max-w-md';
                                notification.innerHTML = `
                                    <div class="flex items-start gap-3">
                                        <div class="text-3xl">üíú</div>
                                        <div>
                                            <p class="font-bold mb-1">${language === 'es' ? '¬°S√≠ntoma registrado!' : 'Symptom recorded!'}</p>
                                            <p class="text-sm opacity-90">${newSymptoms.length >= 3 && !patternShown ? (language === 'es' ? '¬°LUMI tiene algo que mostrarte! Revisa el aviso especial üíú' : 'LUMI has something to show you! Check the special notice üíú') : (language === 'es' ? 'Gracias. Esto me ayuda a acompa√±arte mejor. Tu men√∫ te est√° esperando en ü•ó Nutrici√≥n' : 'Thank you. This helps me support you better. Your menu is waiting in ü•ó Nutrition')}</p>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(notification);
                                setTimeout(() => notification.remove(), 5000);
                            }} className="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-white py-3 rounded-lg font-semibold hover:shadow-lg">
                                {t[language].addRecord}
                            </button>
                        </div>

                        {symptoms.length > 0 && (
                            <>
                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                    <h3 className="font-semibold text-lg mb-4">üìà {language === 'es' ? 'Tendencia de Sue√±o' : 'Sleep Trend'}</h3>
                                    <canvas ref={chartRefSleep} style={{maxHeight: '300px'}}></canvas>
                                </div>

                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                    <h3 className="font-semibold text-lg mb-4">üìà {language === 'es' ? 'Tendencia de Energ√≠a' : 'Energy Trend'}</h3>
                                    <canvas ref={chartRefEnergy} style={{maxHeight: '300px'}}></canvas>
                                </div>

                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                    <h3 className="font-semibold text-lg mb-4">üìà {language === 'es' ? 'Tendencia de √Ånimo' : 'Mood Trend'}</h3>
                                    <canvas ref={chartRefMood} style={{maxHeight: '300px'}}></canvas>
                                </div>

                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                    <h3 className="font-semibold text-lg mb-4">üìà {language === 'es' ? 'Tendencia de Sofocos' : 'Hot Flashes Trend'}</h3>
                                    <canvas ref={chartRefHotFlashes} style={{maxHeight: '300px'}}></canvas>
                                </div>

                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-semibold text-lg">üìä {language === 'es' ? 'Resumen General' : 'Overall Summary'}</h3>
                                        <button onClick={async () => {
                                            const { jsPDF } = window.jspdf;
                                            const doc = new jsPDF();
                                            
                                            doc.setFontSize(20);
                                            doc.text('Lumera - Reporte de S√≠ntomas', 20, 20);
                                            
                                            doc.setFontSize(12);
                                            doc.text(`${language === 'es' ? 'Usuaria' : 'User'}: ${currentUser.profile_name}`, 20, 40);
                                            doc.text(`${language === 'es' ? 'Fecha' : 'Date'}: ${new Date().toLocaleDateString()}`, 20, 50);
                                            
                                            const avgSleep = (symptoms.reduce((a, s) => a + s.sleep, 0) / symptoms.length).toFixed(1);
                                            const avgEnergy = (symptoms.reduce((a, s) => a + s.energy, 0) / symptoms.length).toFixed(1);
                                            const avgMood = (symptoms.reduce((a, s) => a + s.mood, 0) / symptoms.length).toFixed(1);
                                            
                                            doc.setFontSize(14);
                                            doc.text(language === 'es' ? 'Promedios' : 'Averages', 20, 70);
                                            doc.setFontSize(11);
                                            doc.text(`${language === 'es' ? 'Sue√±o' : 'Sleep'}: ${avgSleep}/10`, 20, 85);
                                            doc.text(`${language === 'es' ? 'Energ√≠a' : 'Energy'}: ${avgEnergy}/10`, 20, 95);
                                            doc.text(`${language === 'es' ? '√Ånimo' : 'Mood'}: ${avgMood}/10`, 20, 105);
                                            
                                            doc.text(`${language === 'es' ? 'Total de registros' : 'Total records'}: ${symptoms.length}`, 20, 120);
                                            
                                            doc.save(`Lumera_Sintomas_${new Date().toISOString().split('T')[0]}.pdf`);
                                        }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700">
                                            üì• {language === 'es' ? 'Descargar PDF' : 'Download PDF'}
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-blue-50'} p-4 rounded-lg`}>
                                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>{language === 'es' ? 'Promedio Sue√±o' : 'Avg Sleep'}</p>
                                            <p className="text-2xl font-bold text-blue-600">{(symptoms.reduce((a, s) => a + s.sleep, 0) / symptoms.length).toFixed(1)}/10</p>
                                        </div>
                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-rose-50'} p-4 rounded-lg`}>
                                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>{language === 'es' ? 'Promedio Energ√≠a' : 'Avg Energy'}</p>
                                            <p className="text-2xl font-bold text-rose-500">{(symptoms.reduce((a, s) => a + s.energy, 0) / symptoms.length).toFixed(1)}/10</p>
                                        </div>
                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-cyan-50'} p-4 rounded-lg`}>
                                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>{language === 'es' ? 'Promedio √Ånimo' : 'Avg Mood'}</p>
                                            <p className="text-2xl font-bold text-cyan-600">{(symptoms.reduce((a, s) => a + s.mood, 0) / symptoms.length).toFixed(1)}/10</p>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                );
            };

            // PER√çODO
            const renderPeriod = () => {
                return (
                    <div className="pb-32 space-y-8" key={`period-${language}`}>
                        <h2 className="text-3xl font-light gradient-text">{t[language].period}</h2>
                        
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 space-y-6`}>
                            <h3 className="font-semibold text-lg">{language === 'es' ? 'Registra tu per√≠odo' : 'Record your period'}</h3>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-semibold mb-2">{language === 'es' ? 'Intensidad (1-10)' : 'Intensity (1-10)'}</label>
                                    <input type="range" min="1" max="10" value={periodForm.intensity} onChange={(e) => setPeriodForm({...periodForm, intensity: parseInt(e.target.value)})} className="w-full accent-rose-500"/>
                                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{periodForm.intensity}/10</p>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-2">{language === 'es' ? 'Duraci√≥n (d√≠as)' : 'Duration (days)'}</label>
                                    <input type="range" min="1" max="10" value={periodForm.duration} onChange={(e) => setPeriodForm({...periodForm, duration: parseInt(e.target.value)})} className="w-full accent-rose-500"/>
                                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{periodForm.duration} {language === 'es' ? 'd√≠as' : 'days'}</p>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-2">{language === 'es' ? 'S√≠ntomas' : 'Symptoms'}</label>
                                    <input type="text" placeholder={language === 'es' ? 'Ej: c√≥licos, hinchaz√≥n' : 'E.g: cramps, bloating'} value={periodForm.symptoms} onChange={(e) => setPeriodForm({...periodForm, symptoms: e.target.value})} className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}/>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-2">{language === 'es' ? 'Fecha' : 'Date'}</label>
                                    <input type="date" value={periodForm.date} onChange={(e) => setPeriodForm({...periodForm, date: e.target.value})} className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}/>
                                </div>
                            </div>

                            <button onClick={() => {
                                setPeriodLog([...periodLog, periodForm]);
                                setPeriodForm({ intensity: 5, duration: 5, symptoms: '', date: new Date().toISOString().split('T')[0] });
                                alert(language === 'es' ? 'Per√≠odo registrado ‚úì' : 'Period recorded ‚úì');
                            }} className="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-white py-3 rounded-lg font-semibold hover:shadow-lg">
                                {t[language].addRecord}
                            </button>
                        </div>

                        {periodLog.length > 0 && (
                            <>
                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-semibold text-lg">üìà {language === 'es' ? 'Tendencia de Per√≠odo' : 'Period Trend'}</h3>
                                        <button onClick={() => {
                                            const { jsPDF } = window.jspdf;
                                            const doc = new jsPDF();
                                            
                                            doc.setFontSize(20);
                                            doc.text('Lumera - Reporte de Per√≠odo', 20, 20);
                                            
                                            doc.setFontSize(12);
                                            doc.text(`${language === 'es' ? 'Usuaria' : 'User'}: ${currentUser.profile_name}`, 20, 40);
                                            doc.text(`${language === 'es' ? 'Fecha' : 'Date'}: ${new Date().toLocaleDateString()}`, 20, 50);
                                            
                                            doc.setFontSize(14);
                                            doc.text(language === 'es' ? 'Resumen de Registros' : 'Records Summary', 20, 70);
                                            doc.setFontSize(11);
                                            
                                            const avgIntensity = (periodLog.reduce((a, p) => a + p.intensity, 0) / periodLog.length).toFixed(1);
                                            const avgDuration = (periodLog.reduce((a, p) => a + p.duration, 0) / periodLog.length).toFixed(1);
                                            
                                            doc.text(`${language === 'es' ? 'Intensidad promedio' : 'Avg intensity'}: ${avgIntensity}/10`, 20, 85);
                                            doc.text(`${language === 'es' ? 'Duraci√≥n promedio' : 'Avg duration'}: ${avgDuration} d√≠as`, 20, 95);
                                            doc.text(`${language === 'es' ? 'Total de ciclos registrados' : 'Total cycles recorded'}: ${periodLog.length}`, 20, 105);
                                            
                                            doc.save(`Lumera_Periodo_${new Date().toISOString().split('T')[0]}.pdf`);
                                        }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700">
                                            üì• {language === 'es' ? 'Descargar PDF' : 'Download PDF'}
                                        </button>
                                    </div>
                                    <canvas ref={chartRefPeriod} style={{maxHeight: '300px'}}></canvas>
                                </div>

                                {/* AN√ÅLISIS DE TENDENCIA - aparece con 3+ registros */}
                                {periodLog.length >= 3 && (
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                        <h3 className="font-semibold text-lg mb-4">üå∏ {language === 'es' ? 'Tendencia de tu ciclo' : 'Your cycle trend'}</h3>
                                        {(() => {
                                            const intensities = periodLog.map(p => p.intensity);
                                            const durations = periodLog.map(p => p.duration);
                                            const avgIntensity = (intensities.reduce((a, b) => a + b, 0) / intensities.length).toFixed(1);
                                            const avgDuration = (durations.reduce((a, b) => a + b, 0) / durations.length).toFixed(1);
                                            const lastIntensity = intensities[intensities.length - 1];
                                            const prevIntensity = intensities[intensities.length - 2];
                                            const intensityTrend = lastIntensity > prevIntensity ? 'up' : lastIntensity < prevIntensity ? 'down' : 'stable';

                                            // Calcular intervalos entre per√≠odos
                                            const intervals = [];
                                            for (let i = 1; i < periodLog.length; i++) {
                                                const d1 = new Date(periodLog[i - 1].date);
                                                const d2 = new Date(periodLog[i].date);
                                                intervals.push(Math.round((d2 - d1) / (1000 * 60 * 60 * 24)));
                                            }
                                            const avgInterval = intervals.length > 0 ? (intervals.reduce((a, b) => a + b, 0) / intervals.length).toFixed(0) : null;
                                            const irregular = intervals.length >= 2 && (Math.max(...intervals) - Math.min(...intervals)) > 14;

                                            return (
                                                <div className="space-y-3">
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-rose-50'} p-4 rounded-lg text-center`}>
                                                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>{language === 'es' ? 'Intensidad avg' : 'Avg intensity'}</p>
                                                            <p className="text-2xl font-bold text-rose-500">{avgIntensity}<span className="text-sm font-normal">/10</span></p>
                                                            {intensityTrend !== 'stable' && (
                                                                <p className={`text-xs mt-1 ${intensityTrend === 'up' ? 'text-rose-500' : 'text-emerald-500'}`}>
                                                                    {intensityTrend === 'up' ? '‚Üë' : '‚Üì'} {language === 'es' ? 'vs anterior' : 'vs previous'}
                                                                </p>
                                                            )}
                                                        </div>
                                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-purple-50'} p-4 rounded-lg text-center`}>
                                                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>{language === 'es' ? 'Duraci√≥n avg' : 'Avg duration'}</p>
                                                            <p className="text-2xl font-bold text-purple-600">{avgDuration}<span className="text-sm font-normal"> {language === 'es' ? 'd√≠as' : 'days'}</span></p>
                                                        </div>
                                                    </div>

                                                    {avgInterval && (
                                                        <div className={`${darkMode ? 'bg-gray-700' : 'bg-amber-50'} p-4 rounded-lg`}>
                                                            <p className={`text-sm ${darkMode ? 'text-amber-200' : 'text-amber-800'}`}>
                                                                <span className="font-semibold">‚è±Ô∏è {language === 'es' ? 'Intervalo promedio' : 'Avg interval'}:</span> {avgInterval} {language === 'es' ? 'd√≠as entre per√≠odos' : 'days between periods'}
                                                                {irregular && (
                                                                    <span className={`block text-xs mt-1 ${darkMode ? 'text-amber-300' : 'text-amber-600'}`}>
                                                                        {language === 'es' 
                                                                            ? '‚ö° Tu ciclo muestra irregularidad. Es muy com√∫n en esta etapa. LUMI puede ayudarte a manejar los d√≠as de incertidumbre.' 
                                                                            : '‚ö° Your cycle shows irregularity. It\'s very common at this stage. LUMI can help you navigate the uncertain days.'}
                                                                    </span>
                                                                )}
                                                            </p>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })()}
                                    </div>
                                )}

                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                    <h3 className="font-semibold text-lg mb-4">{language === 'es' ? 'Tu Historial' : 'Your History'}</h3>
                                    <div className="space-y-3">
                                        {periodLog.map((p, idx) => (
                                            <div key={idx} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-lg`}>
                                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>{p.date}</p>
                                                <p className="text-sm"><span className="font-semibold">{language === 'es' ? 'Intensidad' : 'Intensity'}:</span> {p.intensity}/10 | <span className="font-semibold">{language === 'es' ? 'Duraci√≥n' : 'Duration'}:</span> {p.duration} d√≠as</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                );
            };

            // MITOS
            const renderMyths = () => {
                const { myths } = getMythsAndTips();
                
                return (
                    <div className="pb-32 space-y-6" key={`myths-${language}`}>
                        <h2 className="text-3xl font-light gradient-text">{t[language].myths}</h2>
                        
                        {myths && Array.isArray(myths) && myths.length > 0 ? myths.map((myth, idx) => (
                            <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg overflow-hidden`}>
                                <div className={`${darkMode ? 'bg-gray-700' : 'bg-rose-50'} border-l-4 border-rose-400 p-6`}>
                                    <h3 className={`text-lg font-semibold ${darkMode ? 'text-rose-400' : 'text-rose-900'} mb-2`}>‚ùå {myth.myth}</h3>
                                </div>
                                
                                <div className="p-6 space-y-4">
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-green-50'} border-l-4 border-green-600 p-4 rounded-lg`}>
                                        <p className={`font-semibold ${darkMode ? 'text-green-400' : 'text-green-900'} mb-2`}>‚úÖ {myth.truth}</p>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-blue-50'} border-l-4 border-blue-600 p-4 rounded-lg`}>
                                        <p className={`font-semibold mb-2 ${darkMode ? 'text-blue-400' : 'text-blue-900'}`}>üî¨ {language === 'es' ? 'Base Cient√≠fica' : 'Science'}</p>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-3`}>{myth.science}</p>
                                        {myth.source && (
                                            <a 
                                                href={myth.source} 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                className={`text-xs ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-800'} underline inline-flex items-center gap-1`}
                                            >
                                                üìÑ {language === 'es' ? 'Ver estudio cient√≠fico' : 'View scientific study'}
                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                                </svg>
                                            </a>
                                        )}
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-amber-50'} border-l-4 border-rose-400 p-4 rounded-lg`}>
                                        <p className={`font-semibold mb-2 ${darkMode ? 'text-amber-400' : 'text-rose-900'}`}>üí° {language === 'es' ? 'Qu√© Hacer' : 'What to Do'}</p>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{myth.action}</p>
                                    </div>
                                </div>
                            </div>
                        )) : (
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                <p className="text-gray-600 dark:text-gray-400">{language === 'es' ? 'Cargando mitos...' : 'Loading myths...'}</p>
                            </div>
                        )}
                    </div>
                );
            };

            // CONSEJOS
            const renderTips = () => {
                const { tips } = getMythsAndTips();
                
                return (
                    <div className="pb-32 space-y-6" key={`tips-${language}`}>
                        <h2 className="text-3xl font-light gradient-text">{t[language].tips}</h2>
                        
                        {tips.map((tip, idx) => (
                            <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg overflow-hidden`}>
                                <div className="bg-gradient-to-r from-rose-400 to-amber-300 text-white p-6">
                                    <h3 className="text-2xl font-semibold">{tip.emoji} {tip.title}</h3>
                                </div>

                                <div className="p-6 space-y-4">
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-yellow-50'} border-l-4 border-yellow-500 p-4 rounded-lg`}>
                                        <p className={`font-semibold mb-2 ${darkMode ? 'text-yellow-300' : 'text-yellow-900'}`}>üí° {language === 'es' ? 'Por qu√© es importante' : 'Why it matters'}</p>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{tip.why}</p>
                                    </div>

                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-green-50'} border-l-4 border-green-600 p-4 rounded-lg`}>
                                        <p className={`font-semibold mb-2 ${darkMode ? 'text-green-300' : 'text-green-900'}`}>‚úÖ {language === 'es' ? 'C√≥mo hacerlo' : 'How to do it'}</p>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-line`}>{tip.how}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            // TALLERES
            const renderWorkshops = () => {
                return (
                    <div className="pb-32 space-y-6" key={`workshops-${language}`}>
                        <h2 className="text-3xl font-light gradient-text">{t[language].workshops}</h2>
                        <div className="grid md:grid-cols-2 gap-6">
                            {[
                                { title: language === 'es' ? 'Nutrici√≥n sin Culpa' : 'Nutrition Without Guilt', date: '15 Dic', type: 'webinar' },
                                { title: language === 'es' ? 'Ejercicio que Empodera' : 'Empowering Exercise', date: '20 Dic', type: 'workshop' }
                            ].map((w, idx) => (
                                <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                                    <h3 className="text-xl font-semibold mb-4">{w.title}</h3>
                                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>üìÖ {w.date}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // COMUNIDAD
            const renderCommunity = () => {
                // Publicar mensaje
                const handlePostMessage = async () => {
                    if (!communityMessage.trim()) return;
                    
                    try {
                        const { data, error } = await supabase
                            .from('community_posts')
                            .insert([{
                                user_id: currentUser.id,
                                user_name: currentUser.profile_name || 'An√≥nima',
                                message: communityMessage.trim(),
                                language: language,
                                is_approved: true  // Auto-aprobar por ahora
                            }])
                            .select();
                        
                        if (error) {
                            console.error('Error posting message:', error);
                            alert(language === 'es' ? 'Error al publicar mensaje' : 'Error posting message');
                        } else {
                            // Agregar el nuevo post a la lista
                            setCommunityPosts([data[0], ...communityPosts]);
                            setCommunityMessage('');
                            
                            // Notificaci√≥n de √©xito
                            const notification = document.createElement('div');
                            notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-rose-400 to-amber-300 text-white px-6 py-4 rounded-xl shadow-2xl z-50 max-w-md';
                            notification.innerHTML = `
                                <div class="flex items-start gap-3">
                                    <div class="text-3xl">üíú</div>
                                    <div>
                                        <p class="font-bold mb-1">${language === 'es' ? '¬°Mensaje compartido!' : 'Message shared!'}</p>
                                        <p class="text-sm opacity-90">${language === 'es' ? 'Gracias por compartir tu historia con la comunidad' : 'Thank you for sharing your story with the community'}</p>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 4000);
                        }
                    } catch (err) {
                        console.error('Error:', err);
                        alert(language === 'es' ? 'Error al publicar' : 'Error posting');
                    }
                };
                
                return (
                    <div className="pb-32 space-y-8" key={`community-${language}`}>
                        <h2 className="text-3xl font-light gradient-text">{t[language].community}</h2>
                        
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                            <h3 className="font-semibold text-lg mb-4">{language === 'es' ? 'üíú Comparte tu Historia' : 'üíú Share Your Story'}</h3>
                            <textarea 
                                value={communityMessage} 
                                onChange={(e) => setCommunityMessage(e.target.value)} 
                                placeholder={language === 'es' ? 'Cu√©ntanos c√≥mo te sientes, qu√© ha mejorado, o qu√© te ayuda d√≠a a d√≠a...' : 'Tell us how you feel, what has improved, or what helps you daily...'} 
                                className={`w-full px-4 py-3 border rounded-lg mb-4 resize-none ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} 
                                rows="4"
                                maxLength="500"
                            />
                            <div className="flex justify-between items-center mb-4">
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                    {communityMessage.length}/500
                                </p>
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                    {language === 'es' ? '‚ú® Tu mensaje ser√° visible para toda la comunidad' : '‚ú® Your message will be visible to the entire community'}
                                </p>
                            </div>
                            <button 
                                onClick={handlePostMessage}
                                disabled={!communityMessage.trim()}
                                className="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-white py-3 rounded-lg font-semibold hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {language === 'es' ? 'Compartir Mensaje' : 'Share Message'}
                            </button>
                        </div>

                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6`}>
                            <h3 className="font-semibold text-lg mb-6">{language === 'es' ? 'Historias de Nuestra Comunidad' : 'Community Stories'}</h3>
                            
                            {loadingPosts ? (
                                <div className="text-center py-8">
                                    <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                                        {language === 'es' ? 'Cargando historias...' : 'Loading stories...'}
                                    </p>
                                </div>
                            ) : communityPosts.length === 0 ? (
                                <div className="text-center py-8">
                                    <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                                        {language === 'es' ? 'S√© la primera en compartir tu historia üíú' : 'Be the first to share your story üíú'}
                                    </p>
                                </div>
                            ) : (
                                <div className="grid md:grid-cols-2 gap-6">
                                    {communityPosts.map((post) => (
                                        <div key={post.id} className={`${darkMode ? 'bg-gray-700' : 'bg-amber-50'} rounded-xl p-6 border-l-4 border-rose-400`}>
                                            <div className="flex justify-between items-start mb-3">
                                                <h4 className="font-semibold">üë© {post.user_name}</h4>
                                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                    üìÖ {new Date(post.created_at).toLocaleDateString(language === 'es' ? 'es-ES' : 'en-US', { 
                                                        year: 'numeric', 
                                                        month: 'short', 
                                                        day: 'numeric' 
                                                    })}
                                                </p>
                                            </div>
                                            <p className={`italic ${darkMode ? 'text-gray-300' : 'text-gray-700'} leading-relaxed`}>
                                                "{post.message}"
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // RENDERIZAR CONTENIDO
            const renderContent = () => {
                if (!currentUser) return null;
                
                // P√°ginas premium que requieren suscripci√≥n
                const premiumPages = ['workshops', 'community']; // nutrition y exercise tienen freemium interno
                
                if (premiumPages.includes(currentPage) && !isPremium()) {
                    return (
                        <div className="text-center py-20">
                            <div className="mb-6">
                                <div className="inline-block p-8 bg-gradient-to-br from-purple-100 to-pink-100 rounded-full mb-6">
                                    <svg className="w-24 h-24 text-amber-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                </div>
                            </div>
                            <h2 className="text-3xl font-bold mb-4 gradient-text">{language === 'es' ? 'Contenido Premium' : 'Premium Content'}</h2>
                            <p className="text-xl text-gray-600 mb-8 max-w-md mx-auto">
                                {language === 'es' ? 'Desbloquea todas las funcionalidades de Lumera' : 'Unlock all Lumera features'}
                            </p>
                            <div className="max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8 mb-6">
                                <div className="mb-6">
                                    <div className="text-5xl font-bold gradient-text mb-2">{PRICES[getRegion()].price}</div>
                                    <div className="text-sm text-gray-600">{language === 'es' ? 'por mes' : 'per month'}</div>
                                </div>
                                <ul className="text-left space-y-3 mb-8">
                                    <li className="flex items-start">
                                        <svg className="w-6 h-6 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                        </svg>
                                        <span>{language === 'es' ? 'Men√∫s personalizados semanales' : 'Personalized weekly menus'}</span>
                                    </li>
                                    <li className="flex items-start">
                                        <svg className="w-6 h-6 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                        </svg>
                                        <span>{language === 'es' ? 'Rutinas de ejercicio adaptadas' : 'Adapted exercise routines'}</span>
                                    </li>
                                    <li className="flex items-start">
                                        <svg className="w-6 h-6 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                        </svg>
                                        <span>{language === 'es' ? 'Seguimiento de s√≠ntomas y an√°lisis' : 'Symptom tracking and analysis'}</span>
                                    </li>
                                </ul>
                                <button onClick={() => setShowPlanModal(true)} className="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-white py-4 rounded-lg font-semibold text-lg hover:shadow-lg">
                                    üíé {language === 'es' ? 'Suscribirme' : 'Subscribe'}
                                </button>
                            </div>
                        </div>
                    );
                }
                
                switch(currentPage) {
                    case 'home': return renderHome();
                    case 'nutrition': return renderNutrition();
                    case 'exercise': return renderExercise();
                    case 'symptoms': return renderSymptoms();
                    case 'period': return renderPeriod();
                    case 'myths': return renderMyths();
                    case 'tips': return renderTips();
                    case 'workshops': return renderWorkshops();
                    case 'community': return renderCommunity();
                    default: return renderHome();
                }
            };

            if (loading) return <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-50 flex items-center justify-center"><h1 className="text-4xl gradient-text">Lumera</h1></div>;
            
            // DEBUG: Ver estado actual
            console.log('RENDER STATE:', { showAuth, showQuiz, session: !!session, currentUser: !!currentUser });
            
            // LANDING PAGE CON HERO ELEGANTE
            if (showAuth) return (
                <div className="min-h-screen" style={{background: '#fafaf9'}}>
                    {/* NAVBAR ELEGANTE */}
                    <nav className="navbar-elegant fixed top-0 w-full z-50">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <svg width="32" height="32" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                        <linearGradient id="flameGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style={{stopColor:'#d4af7f',stopOpacity:1}} />
                                            <stop offset="100%" style={{stopColor:'#e8c89f',stopOpacity:1}} />
                                        </linearGradient>
                                    </defs>
                                    <path d="M 32 12 A 20 20 0 0 0 32 52 A 16 16 0 0 1 32 16 Z" fill="#b8a8d8"/>
                                    <path d="M 40 32 Q 40 26 42 22 Q 42 28 40 35 Q 38 28 38 22 Q 40 26 40 32" fill="url(#flameGrad)"/>
                                </svg>
                                <h1 className="text-2xl font-medium tracking-tight" style={{color: '#78716c', fontFamily: 'Cormorant, serif'}}>
                                    LUMERA
                                </h1>
                            </div>
                            
                            <div className="flex items-center space-x-4">
                                <button
                                    onClick={() => setLanguage(language === 'es' ? 'en' : 'es')}
                                    className="px-4 py-2 rounded-full text-sm font-medium transition-all"
                                    style={{
                                        background: 'rgba(120, 113, 108, 0.08)',
                                        color: '#78716c'
                                    }}
                                >
                                    üåê {language.toUpperCase()}
                                </button>
                            </div>
                        </div>
                    </nav>

                    {/* HERO ELEGANTE CON DOS COLUMNAS - OPTIMIZADO M√ìVIL */}
                    <div className="pt-24" style={{
                        background: '#1a1a18',
                        minHeight: '100vh',
                        display: 'flex',
                        alignItems: 'center',
                        position: 'relative',
                        overflow: 'hidden'
                    }}>
                        {/* VIDEO FONDO */}
                        <video
                            autoPlay
                            muted
                            loop
                            playsInline
                            style={{
                                position: 'absolute',
                                top: 0,
                                left: 0,
                                width: '100%',
                                height: '100%',
                                objectFit: 'cover',
                                zIndex: 0,
                                opacity: 0.55
                            }}
                        >
                            <source src="https://raw.githubusercontent.com/bibianabertuarios-wq/Lumera/main/Morning%20sun%20rays%20through%20dense%20pine%20forest%2C%20floating%20mist%2C%20warm%20tones%2C%20atmospheric%20and%20cinematic.%20Movement%20in%20the%20leaves%20from%20bottom%20to%20top%2C%20like%20a%20light%20breeze%2C%20and%20a%20little%20girl%20with%20a%20red%20cape%2C%20seen%20from%20behind%2C%20looking%20up%20at%20the%20sky..mp4" type="video/mp4" />
                        </video>

                        {/* OVERLAY GRADIENTE PARA LEGIBILIDAD */}
                        <div style={{
                            position: 'absolute',
                            top: 0,
                            left: 0,
                            width: '100%',
                            height: '100%',
                            background: 'linear-gradient(to right, rgba(250, 245, 240, 0.92) 0%, rgba(250, 245, 240, 0.7) 40%, rgba(250, 245, 240, 0.3) 70%, rgba(250, 245, 240, 0.1) 100%)',
                            zIndex: 1
                        }}></div>
                        
                        <div className="max-w-7xl mx-auto px-4 md:px-6 py-8 md:py-20 w-full" style={{position: 'relative', zIndex: 2}}>
                            <div className="grid md:grid-cols-2 gap-8 md:gap-16 items-center">
                                {/* CONTENIDO IZQUIERDO - COMPACTO */}
                                <div style={{display: 'flex', flexDirection: 'column', gap: '1.5rem'}}>
                                    <div className="badge-subtle" style={{display: 'inline-block', width: 'fit-content'}}>
                                        {language === 'es' ? 'Para mujeres que est√°n viviendo una transformaci√≥n' : 'For women experiencing transformation'}
                                    </div>
                                    
                                    <div>
                                        <h2 className="hero-title-hybrid" style={{marginBottom: '0.75rem', fontSize: 'clamp(1.75rem, 5vw, 3rem)'}}>
                                            {language === 'es' ? 'Cuando tu cuerpo cambia,' : 'When your body changes,'}
                                            <br/>
                                            <span className="hero-subtitle-hybrid">
                                                {language === 'es' ? 'tener un plan lo cambia todo' : 'having a plan changes everything'}
                                            </span>
                                        </h2>
                                        
                                        <p className="text-lg md:text-xl leading-relaxed" style={{color: '#78716c', marginTop: '1rem'}}>
                                            {language === 'es' 
                                                ? 'No est√°s sola. Acompa√±amiento personalizado que entiende esta etapa.'
                                                : 'You are not alone. Personalized support that understands this stage.'}
                                        </p>
                                    </div>
                                    
                                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                                        <p className="text-sm" style={{color: '#a8a29e'}}>
                                            {language === 'es' ? 'Sin tarjeta ‚Ä¢ Cancela cuando quieras' : 'No card required ‚Ä¢ Cancel anytime'}
                                        </p>
                                    </div>
                                </div>
                                
                                {/* FORMULARIO DERECHO - COMPACTO */}
                                <div className="card-elegant" style={{animation: 'float 6s ease-in-out infinite'}}>
                                    <div className="text-center mb-6">
                                        <h3 className="text-2xl md:text-3xl font-light mb-2" style={{color: '#44403c', fontFamily: 'Cormorant, serif'}}>
                                            {language === 'es' ? 'Empieza tu prueba gratuita' : 'Start your free trial'}
                                        </h3>
                                        <p className="text-sm" style={{color: '#78716c'}}>
                                            {language === 'es' ? '3 d√≠as para descubrir Lumera' : '3 days to discover Lumera'}
                                        </p>
                                    </div>
                                    
                                    <div className="flex gap-2 mb-4">
                                        <button 
                                            onClick={() => setAuthMode('register')} 
                                            className={`flex-1 py-2.5 rounded-xl font-semibold transition text-sm md:text-base ${authMode === 'register' ? 'btn-cta-elegant' : ''}`}
                                            style={authMode !== 'register' ? {background: 'rgba(120, 113, 108, 0.08)', color: '#78716c'} : {}}
                                        >
                                            {language === 'es' ? 'Crear Cuenta' : 'Sign Up'}
                                        </button>
                                        <button 
                                            onClick={() => setAuthMode('login')} 
                                            className={`flex-1 py-2.5 rounded-xl font-semibold transition text-sm md:text-base ${authMode === 'login' ? 'btn-cta-elegant' : ''}`}
                                            style={authMode !== 'login' ? {background: 'rgba(120, 113, 108, 0.08)', color: '#78716c'} : {}}
                                        >
                                            {language === 'es' ? 'Iniciar Sesi√≥n' : 'Login'}
                                        </button>
                                    </div>
                                    
                                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem', marginBottom: '1rem'}}>
                                        <input
                                            type="email"
                                            placeholder={language === 'es' ? 'Tu correo electr√≥nico' : 'Your email'}
                                            value={authData.email}
                                            onChange={(e) => setAuthData({...authData, email: e.target.value})}
                                            className="input-elegant w-full"
                                        />
                                        
                                        <input
                                            type="password"
                                            placeholder={language === 'es' ? 'Contrase√±a' : 'Password'}
                                            value={authData.password}
                                            onChange={(e) => setAuthData({...authData, password: e.target.value})}
                                            className="input-elegant w-full"
                                        />
                                        
                                        {authMode === 'login' && (
                                            <button
                                                type="button"
                                                onClick={() => setShowPasswordReset(true)}
                                                className="text-xs text-purple-600 hover:text-purple-800 text-right transition"
                                            >
                                                {language === 'es' ? '¬øOlvidaste tu contrase√±a?' : 'Forgot your password?'}
                                            </button>
                                        )}
                                    </div>
                                    
                                    {authMode === 'register' && (
                                        <div className="mb-4 space-y-2 text-xs bg-amber-50/60 p-4 rounded-2xl border border-purple-100">
                                            <p className="font-bold text-sm text-rose-900 mb-2">
                                                {language === 'es' ? '‚ö†Ô∏è Confirmaciones Importantes' : '‚ö†Ô∏è Important Confirmations'}
                                            </p>
                                            
                                            <label className="flex items-start gap-2 cursor-pointer group">
                                                <input type="checkbox" required className="mt-1 w-4 h-4 text-amber-700 rounded focus:ring-2 focus:ring-amber-300 flex-shrink-0"/>
                                                <span className="text-gray-700 group-hover:text-gray-900 leading-tight">
                                                    {language === 'es' 
                                                        ? 'Confirmo que soy mayor de 18 a√±os.' 
                                                        : 'I confirm I am over 18 years old.'}
                                                </span>
                                            </label>
                                            
                                            <label className="flex items-start gap-2 cursor-pointer group">
                                                <input type="checkbox" required className="mt-1 w-4 h-4 text-amber-700 rounded flex-shrink-0"/>
                                                <span className="text-gray-700 font-medium group-hover:text-gray-900 leading-tight">
                                                    {language === 'es' 
                                                        ? 'Entiendo que Lumera es una herramienta de bienestar y NO sustituye consejo m√©dico profesional.' 
                                                        : 'I understand that Lumera is a wellness tool and does NOT replace professional medical advice.'}
                                                </span>
                                            </label>
                                            
                                            <label className="flex items-start gap-2 cursor-pointer group">
                                                <input type="checkbox" required className="mt-1 w-4 h-4 text-amber-700 rounded"/>
                                                <span className="text-gray-700 font-medium group-hover:text-gray-900">
                                                    {language === 'es' 
                                                        ? <>Acepto la <a href={language === 'es' ? '/privacidad' : '/privacy'} target="_blank" style={{color: '#a78bfa', textDecoration: 'underline'}}>Pol√≠tica de Privacidad</a> y protecci√≥n de datos.</>
                                                        : <>I accept the <a href={language === 'es' ? '/privacidad' : '/privacy'} target="_blank" style={{color: '#a78bfa', textDecoration: 'underline'}}>Privacy Policy</a> and data protection.</>}
                                                </span>
                                            </label>
                                            
                                            <label className="flex items-start gap-3 cursor-pointer group">
                                                <input type="checkbox" required className="mt-1 w-4 h-4 text-amber-700 rounded"/>
                                                <span className="text-gray-700 font-medium group-hover:text-gray-900">
                                                    {language === 'es' 
                                                        ? <>Acepto los <a href={language === 'es' ? '/terminos' : '/terms'} target="_blank" style={{color: '#a78bfa', textDecoration: 'underline'}}>T√©rminos de Uso</a> y respeto la propiedad intelectual de Lumera.</>
                                                        : <>I accept the <a href={language === 'es' ? '/terminos' : '/terms'} target="_blank" style={{color: '#a78bfa', textDecoration: 'underline'}}>Terms of Use</a> and respect Lumera's intellectual property.</>}
                                                </span>
                                            </label>
                                        </div>
                                    )}
                                    
                                    <button
                                        onClick={authMode === 'login' ? handleLogin : handleRegister}
                                        className="btn-cta-elegant w-full"
                                    >
                                        {authMode === 'login' 
                                            ? (language === 'es' ? 'Entrar' : 'Login') 
                                            : (language === 'es' ? 'Crear cuenta' : 'Create account')}
                                    </button>
                                    
                                    {/* BOT√ìN DE GOOGLE */}
                                    <div className="flex items-center gap-3 my-4">
                                        <div className="flex-1 border-t border-gray-300"></div>
                                        <span className="text-xs text-gray-500">
                                            {language === 'es' ? 'o contin√∫a con' : 'or continue with'}
                                        </span>
                                        <div className="flex-1 border-t border-gray-300"></div>
                                    </div>
                                    
                                    <button
                                        onClick={handleGoogleLogin}
                                        className="w-full bg-white border border-gray-300 hover:border-gray-400 text-gray-700 py-3 px-4 rounded-xl font-medium transition flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-5 h-5" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                        Google
                                    </button>
                                    
                                    <p className="text-center text-sm mt-4" style={{color: '#78716c'}}>
                                        {authMode === 'signup' 
                                            ? (language === 'es' ? '¬øYa tienes cuenta?' : 'Already have an account?')
                                            : (language === 'es' ? '¬øNo tienes cuenta?' : 'Don\'t have an account?')}
                                        {' '}
                                        <button
                                            type="button"
                                            onClick={() => setAuthMode(authMode === 'signup' ? 'login' : 'signup')}
                                            className="font-medium"
                                            style={{color: '#7c3aed'}}
                                        >
                                            {authMode === 'signup' 
                                                ? (language === 'es' ? 'Inicia sesi√≥n' : 'Log in')
                                                : (language === 'es' ? 'Reg√≠strate' : 'Sign up')}
                                        </button>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* FEATURES ELEGANTES */}
                    <div className="py-24 px-6" style={{background: 'white'}}>
                        <div className="max-w-7xl mx-auto">
                            <div className="text-center mb-16">
                                <h3 className="text-3xl font-light mb-4" style={{color: '#292524', fontFamily: 'Cormorant, serif'}}>
                                    {language === 'es' ? 'Todo lo que necesitas en un lugar' : 'Everything you need in one place'}
                                </h3>
                                <div className="divider-elegant"></div>
                            </div>
                            <div className="grid md:grid-cols-3 gap-8">
                                <div className="card-elegant text-center fade-in-up">
                                    <div className="text-5xl mb-6">üçΩÔ∏è</div>
                                    <h3 className="text-2xl font-light mb-4" style={{color: '#44403c', fontFamily: 'Cormorant, serif'}}>
                                        {language === 'es' ? 'Men√∫s que alivian' : 'Menus that relieve'}
                                    </h3>
                                    <p className="leading-relaxed" style={{color: '#78716c'}}>
                                        {language === 'es' 
                                            ? 'Recetas adaptadas para reducir s√≠ntomas como hinchaz√≥n y sofocos. Con evidencia cient√≠fica.'
                                            : 'Recipes adapted to reduce symptoms like bloating and hot flashes. Evidence-based.'}
                                    </p>
                                </div>
                                
                                <div className="card-elegant text-center fade-in-up">
                                    <div className="text-5xl mb-6">üí™</div>
                                    <h3 className="text-2xl font-light mb-4" style={{color: '#44403c', fontFamily: 'Cormorant, serif'}}>
                                        {language === 'es' ? 'Ejercicio sin riesgo' : 'Safe movement'}
                                    </h3>
                                    <p className="leading-relaxed" style={{color: '#78716c'}}>
                                        {language === 'es' 
                                            ? 'Movimiento seguro para esta etapa. Sin impacto, sin dolor, solo bienestar.'
                                            : 'Exercise designed for this stage. No impact, no pain, just wellness.'}
                                    </p>
                                </div>
                                
                                <div className="card-elegant text-center fade-in-up">
                                    <div className="text-5xl mb-6">üí¨</div>
                                    <h3 className="text-2xl font-light mb-4" style={{color: '#44403c', fontFamily: 'Cormorant, serif'}}>
                                        {language === 'es' ? 'Tu gu√≠a personal' : 'Your personal guide'}
                                    </h3>
                                    <p className="leading-relaxed" style={{color: '#78716c'}}>
                                        {language === 'es' 
                                            ? 'Acompa√±amiento cuando lo necesites. Respuestas, planes adaptados, seguimiento.'
                                            : 'Support when you need it. Answers, adapted plans, tracking.'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* STATS STRIP */}
                    <div className="py-12 px-6" style={{background: 'linear-gradient(135deg, #faf5ff 0%, #fff7ed 100%)'}}>
                        <div className="max-w-4xl mx-auto">
                            <div className="grid grid-cols-3 gap-6 text-center">
                                <div>
                                    <p className="text-4xl font-light mb-1" style={{color: '#7c3aed', fontFamily: 'Cormorant, serif'}}>120+</p>
                                    <p className="text-sm" style={{color: '#78716c'}}>{language === 'es' ? 'Recetas cient√≠ficas' : 'Science-based recipes'}</p>
                                </div>
                                <div>
                                    <p className="text-4xl font-light mb-1" style={{color: '#7c3aed', fontFamily: 'Cormorant, serif'}}>3</p>
                                    <p className="text-sm" style={{color: '#78716c'}}>{language === 'es' ? 'Regiones adaptadas' : 'Adapted regions'}</p>
                                </div>
                                <div>
                                    <p className="text-4xl font-light mb-1" style={{color: '#7c3aed', fontFamily: 'Cormorant, serif'}}>100%</p>
                                    <p className="text-sm" style={{color: '#78716c'}}>{language === 'es' ? 'Personalizado' : 'Personalized'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* TESTIMONIOS */}
                    <div className="py-24 px-6" style={{background: 'white'}}>
                        <div className="max-w-5xl mx-auto">
                            <div className="text-center mb-16">
                                <h3 className="text-3xl font-light mb-4" style={{color: '#292524', fontFamily: 'Cormorant, serif'}}>
                                    {language === 'es' ? 'Lo que dicen otras mujeres' : 'What other women say'}
                                </h3>
                                <div className="divider-elegant"></div>
                            </div>
                            <div className="grid md:grid-cols-3 gap-6">
                                <div className="testimonial-card">
                                    <p className="text-sm leading-relaxed mt-6 mb-4" style={{color: '#78716c'}}>
                                        {language === 'es' 
                                            ? 'Por fin entiendo lo que le pasa a mi cuerpo. Los men√∫s de Lumera me han ayudado a reducir el hinchaz√≥n en semanas.'
                                            : 'I finally understand what\'s happening to my body. Lumera\'s menus helped reduce my bloating in weeks.'}
                                    </p>
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full flex items-center justify-center text-sm" style={{background: 'linear-gradient(135deg, #a78bfa, #c084fc)'}}>üë©</div>
                                        <div>
                                            <p className="text-sm font-semibold" style={{color: '#44403c'}}>
                                                {language === 'es' ? 'Mar√≠a, 46 a√±os' : 'Maria, 46'}
                                            </p>
                                            <p className="text-xs" style={{color: '#a8a29e'}}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="testimonial-card">
                                    <p className="text-sm leading-relaxed mt-6 mb-4" style={{color: '#78716c'}}>
                                        {language === 'es' 
                                            ? 'El chat de LUMI es incre√≠ble. Cuando me angustio por los sofocos, puedo hablar con alguien que realmente entiende.'
                                            : 'The LUMI chat is incredible. When I get anxious about hot flashes, I can talk to someone who truly understands.'}
                                    </p>
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full flex items-center justify-center text-sm" style={{background: 'linear-gradient(135deg, #a78bfa, #c084fc)'}}>üë©</div>
                                        <div>
                                            <p className="text-sm font-semibold" style={{color: '#44403c'}}>
                                                {language === 'es' ? 'Laura, 43 a√±os' : 'Laura, 43'}
                                            </p>
                                            <p className="text-xs" style={{color: '#a8a29e'}}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="testimonial-card">
                                    <p className="text-sm leading-relaxed mt-6 mb-4" style={{color: '#78716c'}}>
                                        {language === 'es' 
                                            ? 'Los ejercicios son perfectos para esta etapa. Nada de impacto, pero me siento mucho m√°s fuerte y con m√°s energ√≠a.'
                                            : 'The exercises are perfect for this stage. No impact, but I feel so much stronger and more energized.'}
                                    </p>
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full flex items-center justify-center text-sm" style={{background: 'linear-gradient(135deg, #a78bfa, #c084fc)'}}>üë©</div>
                                        <div>
                                            <p className="text-sm font-semibold" style={{color: '#44403c'}}>
                                                {language === 'es' ? 'Carmen, 48 a√±os' : 'Carmen, 48'}
                                            </p>
                                            <p className="text-xs" style={{color: '#a8a29e'}}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* CTA FINAL */}
                    <div className="py-24 px-6" style={{background: 'linear-gradient(135deg, rgba(167, 139, 250, 0.08) 0%, rgba(253, 164, 175, 0.08) 100%)'}}>
                        <div className="max-w-2xl mx-auto text-center">
                            <h3 className="text-3xl font-light mb-4" style={{color: '#292524', fontFamily: 'Cormorant, serif'}}>
                                {language === 'es' ? 'Empieza tu transformaci√≥n hoy' : 'Start your transformation today'}
                            </h3>
                            <p className="mb-8 leading-relaxed" style={{color: '#78716c'}}>
                                {language === 'es' 
                                    ? 'Prueba Lumera gratis durante 3 d√≠as. Sin compromisos, sin tarjeta de cr√©dito.'
                                    : 'Try Lumera free for 3 days. No commitments, no credit card.'}
                            </p>
                            <button
                                onClick={() => { document.querySelector('.card-elegant')?.scrollIntoView({behavior: 'smooth', block: 'center'}); }}
                                className="btn-cta-elegant inline-block"
                                style={{padding: '1rem 2.5rem', fontSize: '1.1rem'}}
                            >
                                {language === 'es' ? 'Comenzar gratis ‚Üí' : 'Get started free ‚Üí'}
                            </button>
                            <p className="text-xs mt-4" style={{color: '#a8a29e'}}>
                                {language === 'es' ? 'Sin tarjeta ‚Ä¢ Cancela cuando quieras ‚Ä¢ Disponible en ES y EN' : 'No card ‚Ä¢ Cancel anytime ‚Ä¢ Available in ES and EN'}
                            </p>
                        </div>
                    </div>

                    {/* MODAL RESETEO CONTRASE√ëA */}
                    {showPasswordReset && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={() => setShowPasswordReset(false)}>
                            <div 
                                className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6"
                                onClick={(e) => e.stopPropagation()}>
                                
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold gradient-text">
                                        {language === 'es' ? 'üîë Resetear Contrase√±a' : 'üîë Reset Password'}
                                    </h3>
                                    <button 
                                        onClick={() => setShowPasswordReset(false)}
                                        className="text-gray-600 hover:text-gray-900 text-2xl"
                                    >
                                        √ó
                                    </button>
                                </div>

                                <p className="text-sm mb-4 text-gray-600">
                                    {language === 'es' 
                                        ? 'Te enviaremos un email con instrucciones para crear una nueva contrase√±a.'
                                        : 'We\'ll send you an email with instructions to create a new password.'}
                                </p>

                                <input
                                    type="email"
                                    placeholder={language === 'es' ? 'Tu correo electr√≥nico' : 'Your email'}
                                    value={resetEmail}
                                    onChange={(e) => setResetEmail(e.target.value)}
                                    className="input-elegant w-full mb-6"
                                />

                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowPasswordReset(false)}
                                        className="flex-1 py-3 rounded-lg font-semibold transition bg-gray-200 hover:bg-gray-300"
                                    >
                                        {language === 'es' ? 'Cancelar' : 'Cancel'}
                                    </button>
                                    <button
                                        onClick={handlePasswordReset}
                                        className="flex-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition"
                                    >
                                        {language === 'es' ? 'Enviar Email' : 'Send Email'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
            
            
            // IMPORTANTE: Solo mostrar quiz si hay sesi√≥n v√°lida
            if (showQuiz && session) return renderQuiz();
            
            // Si showQuiz es true pero no hay sesi√≥n, forzar auth
            if (showQuiz && !session) {
                setShowQuiz(false);
                setShowAuth(true);
                return null;
            }

            return (
                <div className={darkMode ? 'bg-gray-900 text-white' : 'bg-gray-50'}>
                    <header className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} shadow sticky top-0 z-40 border-b`}>
                        <div className="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <svg width="32" height="32" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                        <linearGradient id="flameGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style={{stopColor:'#d4af7f',stopOpacity:1}} />
                                            <stop offset="100%" style={{stopColor:'#e8c89f',stopOpacity:1}} />
                                        </linearGradient>
                                    </defs>
                                    <path d="M 32 12 A 20 20 0 0 0 32 52 A 16 16 0 0 1 32 16 Z" fill="#b8a8d8"/>
                                    <path d="M 40 32 Q 40 26 42 22 Q 42 28 40 35 Q 38 28 38 22 Q 40 26 40 32" fill="url(#flameGrad)"/>
                                </svg>
                                <h1 className="text-2xl font-light gradient-text">Lumera</h1>
                            </div>
                            <div className="flex items-center gap-3">
                                <select value={language} onChange={(e) => setLanguage(e.target.value)} className={`px-3 py-2 rounded text-sm border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-100 border-gray-300'}`}>
                                    <option value="es">üá™üá∏</option>
                                    <option value="en">üá¨üáß</option>
                                </select>
                                <button onClick={() => setDarkMode(!darkMode)} className={`px-3 py-2 rounded text-sm ${darkMode ? 'bg-yellow-500 text-black' : 'bg-gray-200'}`}>
                                    {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                                </button>
                                {getUserTier() === 'premium' ? (
                                    <div className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full">
                                        <span className="text-white text-sm font-semibold">üíé Premium</span>
                                    </div>
                                ) : (
                                    <button onClick={() => setShowPlanModal(true)} className="px-4 py-2 rounded text-sm font-semibold bg-gradient-to-r from-rose-400 to-amber-300 text-white hover:opacity-90 transition">
                                        üíé {language === 'es' ? 'Hazte Premium' : 'Go Premium'}
                                    </button>
                                )}
                                <button onClick={handleLogout} className="text-sm text-gray-600 dark:text-gray-400">{language === 'es' ? 'Salir' : 'Exit'}</button>
                            </div>
                        </div>
                    </header>

                    {/* BANNER TRIAL MEJORADO */}
                    {currentUser && currentUser.subscription_status !== 'active' && getTrialDaysLeft() > 0 && (
                        <div className={`${darkMode ? 'bg-gradient-to-r from-purple-900 to-pink-900' : 'bg-gradient-to-r from-rose-100 to-amber-100'} border-b ${darkMode ? 'border-gray-700' : 'border-rose-200'} px-4 py-3`}>
                            <div className="max-w-4xl mx-auto flex items-center justify-between flex-wrap gap-3">
                                <div className="flex items-center gap-3">
                                    <span className="text-2xl">
                                        {getTrialDaysLeft() === 3 ? '‚ú®' : getTrialDaysLeft() === 2 ? 'üíú' : '‚è∞'}
                                    </span>
                                    <div>
                                        <p className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                            {getTrialDaysLeft() === 3 && (language === 'es' 
                                                ? 'D√≠a 1 de 3 de tu prueba gratuita'
                                                : 'Day 1 of 3 of your free trial')}
                                            {getTrialDaysLeft() === 2 && (language === 'es'
                                                ? 'D√≠a 2 de 3 - ¬øYa viste tus planes personalizados?'
                                                : 'Day 2 of 3 - Have you seen your personalized plans?')}
                                            {getTrialDaysLeft() === 1 && (language === 'es'
                                                ? '‚è∞ √öltimo d√≠a de tu prueba'
                                                : '‚è∞ Last day of your trial')}
                                        </p>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                            {getTrialDaysLeft() === 3 && (language === 'es'
                                                ? 'Explora todo Lumera sin l√≠mites'
                                                : 'Explore all of Lumera without limits')}
                                            {getTrialDaysLeft() === 2 && (language === 'es'
                                                ? 'Ma√±ana es tu √∫ltimo d√≠a de acceso completo'
                                                : 'Tomorrow is your last day of full access')}
                                            {getTrialDaysLeft() === 1 && (language === 'es'
                                                ? 'Como agradecimiento: 20% off si te suscribes hoy'
                                                : 'As a thank you: 20% off if you subscribe today')}
                                        </p>
                                    </div>
                                </div>
                                <button
                                    onClick={() => setShowPlanModal(true)}
                                    className={`px-4 py-2 rounded-full font-semibold whitespace-nowrap text-sm ${
                                        darkMode 
                                            ? 'bg-white text-purple-900 hover:bg-gray-100' 
                                            : 'bg-gradient-to-r from-rose-500 to-amber-500 text-white hover:opacity-90'
                                    } transition`}
                                >
                                    {getTrialDaysLeft() === 1 
                                        ? (language === 'es' ? 'Activar descuento' : 'Activate discount')
                                        : (language === 'es' ? 'Suscribirse' : 'Subscribe')
                                    }
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* BANNER POST-TRIAL */}
                    {currentUser && currentUser.subscription_status !== 'active' && getTrialDaysLeft() === 0 && (
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-amber-50'} border-b ${darkMode ? 'border-gray-700' : 'border-amber-200'} px-4 py-3`}>
                            <div className="max-w-4xl mx-auto flex items-center justify-between flex-wrap gap-3">
                                <div className="flex items-center gap-3">
                                    <span className="text-2xl">üîí</span>
                                    <div>
                                        <p className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                            {language === 'es' 
                                                ? 'Tu prueba termin√≥ - Suscr√≠bete para continuar'
                                                : 'Your trial ended - Subscribe to continue'}
                                        </p>
                                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                            {language === 'es'
                                                ? 'Todav√≠a puedes usar el tracker de s√≠ntomas y contenido b√°sico'
                                                : 'You can still use symptom tracker and basic content'}
                                        </p>
                                    </div>
                                </div>
                                <button
                                    onClick={() => setShowPlanModal(true)}
                                    className="px-4 py-2 rounded-full font-semibold bg-gradient-to-r from-rose-500 to-amber-500 text-white hover:opacity-90 transition text-sm"
                                >
                                    {language === 'es' ? 'Ver planes' : 'View plans'}
                                </button>
                            </div>
                        </div>
                    )}

                    <main className="max-w-6xl mx-auto px-4 py-8" key={`content-${currentPage}-${language}`}>
                        {renderContent()}
                    </main>

                    {/* Footer con disclaimer y enlaces legales */}
                    <footer className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-gray-50 border-gray-200'} border-t py-6 mb-20`}>
                        <div className="max-w-6xl mx-auto px-4">
                            <div className="text-center mb-4">
                                <p className="text-xs text-gray-600 dark:text-gray-400 mb-2">
                                    {language === 'es'
                                        ? '‚ö†Ô∏è Lumera es una herramienta de bienestar, no sustituye consejo m√©dico profesional.'
                                        : '‚ö†Ô∏è Lumera is a wellness tool, not a substitute for professional medical advice.'}
                                </p>
                                <div className="flex justify-center gap-4 text-xs">
                                    <a href="mailto:support@lumera.app" className="text-amber-700 hover:underline">
                                        {language === 'es' ? 'Soporte' : 'Support'}
                                    </a>
                                    <a href="mailto:privacy@lumera.app" className="text-amber-700 hover:underline">
                                        {language === 'es' ? 'Privacidad' : 'Privacy'}
                                    </a>
                                    <a href="mailto:hello@lumera.app" className="text-amber-700 hover:underline">
                                        {language === 'es' ? 'Contacto' : 'Contact'}
                                    </a>
                                </div>
                            </div>
                            <p className="text-xs text-center text-gray-500">
                                ¬© 2025 Lumera. {language === 'es' ? 'Todos los derechos reservados.' : 'All rights reserved.'}
                            </p>
                        </div>
                    </footer>

                    <nav className={`fixed bottom-0 left-0 right-0 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-t shadow-lg`}>
                        <div className="max-w-6xl mx-auto flex justify-around overflow-x-auto">
                            {[
                                { page: 'home', label: t[language].home, emoji: 'üìä', premium: false },
                                { page: 'nutrition', label: t[language].nutrition, emoji: 'ü•ó', premium: true },
                                { page: 'exercise', label: t[language].exercise, emoji: 'üí™', premium: true },
                                { page: 'symptoms', label: t[language].symptoms, emoji: 'üìù', premium: true },
                                { page: 'period', label: t[language].period, emoji: 'üìÖ', premium: true },
                                { page: 'myths', label: t[language].myths, emoji: '‚ùå', premium: false },
                                { page: 'tips', label: t[language].tips, emoji: '‚ú®', premium: false },
                                { page: 'community', label: t[language].community, emoji: 'üíú', premium: true }
                            ].map((item) => (
                                <button key={item.page} onClick={() => setCurrentPage(item.page)}
                                    className={`py-4 px-3 text-xs sm:text-sm border-t-4 transition whitespace-nowrap ${
                                        currentPage === item.page
                                            ? ('border-rose-400 ' + (darkMode ? 'bg-gray-700' : 'bg-amber-50') + ' text-amber-700')
                                            : (darkMode ? 'border-gray-700 text-gray-400' : 'border-gray-200 text-gray-600')
                                    }`}>
                                    <div>{item.emoji}{item.premium && !isPremium() && ' üîí'}</div>
                                    <div className="text-xs">{item.label}</div>
                                </button>
                            ))}
                        </div>
                    </nav>

                    {/* BOT√ìN FLOTANTE LUMI CON BADGE ANIMADO - ACTUALIZADO ‚ú® */}
                    {currentUser && (
                        <button
                            onClick={() => {
                                if (unreadLumiMessages > 0) {
                                    setShowProactiveModal(true);
                                } else {
                                    setShowLumiChat(true);
                                }
                            }}
                            className="fixed bottom-24 right-6 z-50 bg-gradient-to-r from-rose-400 to-amber-300 text-white rounded-full p-4 shadow-2xl hover:scale-110 transition transform relative"
                            title={language === 'es' ? 'Habla con LUMI - Tu coach personal' : 'Talk to LUMI - Your personal coach'}>
                            
                            {/* BADGE ANIMADO */}
                            {unreadLumiMessages > 0 && (
                                <div className="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center animate-bounce shadow-lg">
                                    {unreadLumiMessages}
                                </div>
                            )}
                            
                            <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            
                            {/* PULSO ANIMADO CUANDO HAY MENSAJES */}
                            {unreadLumiMessages > 0 && (
                                <span className="absolute inset-0 rounded-full bg-rose-400 animate-ping opacity-75"></span>
                            )}
                        </button>
                    )}

                    {/* MODAL CHAT LUMI */}
                    {showLumiChat && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4" onClick={() => setShowLumiChat(false)}>
                            <div 
                                className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-t-3xl sm:rounded-3xl shadow-2xl w-full sm:w-96 h-[80vh] sm:h-[600px] flex flex-col`}
                                onClick={(e) => e.stopPropagation()}>
                                
                                {/* Header */}
                                <div className="bg-gradient-to-r from-rose-400 to-amber-300 text-white p-4 rounded-t-3xl flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                        </svg>
                                        <div>
                                            <h3 className="font-semibold text-lg">Lumi</h3>
                                            <p className="text-xs opacity-90">
                                                {!isPremium() && `${dailyQuestions}/5 ${language === 'es' ? 'preguntas hoy' : 'questions today'}`}
                                            </p>
                                        </div>
                                    </div>
                                    <button onClick={() => setShowLumiChat(false)} className="text-white hover:bg-white/20 rounded-full p-2">
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>

                                {/* Messages */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {lumiMessages.length === 0 && (
                                        <div className="text-center py-8">
                                            <svg className="w-14 h-14 mx-auto mb-4 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                            </svg>
                                            <p className={`text-sm font-semibold ${darkMode ? 'text-purple-300' : 'text-purple-700'} mb-3`}>
                                                {language === 'es' ? 'üíú Hola, soy LUMI' : 'üíú Hi, I\'m LUMI'}
                                            </p>
                                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} leading-relaxed px-2`}>
                                                {currentUser?.profile_name 
                                                    ? (language === 'es' 
                                                        ? `Hola ${currentUser.profile_name}. No tienes que contarme todo de un golpe. Voy a ir conoci√©ndote poco a poco mientras registras c√≥mo te sientes cada d√≠a. As√≠ puedo acompa√±arte mejor. ¬øPor qu√© no me cuentas c√≥mo est√°s hoy?`
                                                        : `Hi ${currentUser.profile_name}. You don't have to tell me everything at once. I'll get to know you little by little as you log how you feel each day. That way I can support you better. Why don't you tell me how you're doing today?`)
                                                    : (language === 'es'
                                                        ? 'No tienes que contarme todo de un golpe. Voy a ir conoci√©ndote poco a poco mientras registras c√≥mo te sientes cada d√≠a. ¬øPor qu√© no me cuentas c√≥mo est√°s hoy?'
                                                        : 'You don\'t have to tell me everything at once. I\'ll get to know you little by little as you log how you feel each day. Why don\'t you tell me how you\'re doing today?')}
                                            </p>
                                        </div>
                                    )}
                                    
                                    {lumiMessages.map((msg, i) => (
                                        <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[80%] rounded-2xl px-4 py-2 ${
                                                msg.role === 'user'
                                                    ? 'bg-gradient-to-r from-rose-400 to-amber-300 text-white'
                                                    : darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-900'
                                            }`}>
                                                <p className="text-sm leading-relaxed">{msg.content}</p>
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {lumiLoading && (
                                        <div className="flex justify-start">
                                            <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-2xl px-4 py-2`}>
                                                <div className="flex gap-1">
                                                    <div className="w-2 h-2 bg-rose-500 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                                                    <div className="w-2 h-2 bg-rose-500 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                                                    <div className="w-2 h-2 bg-rose-500 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Input */}
                                <div className="border-t p-4">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={lumiInput}
                                            onChange={(e) => setLumiInput(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && sendToLumi()}
                                            placeholder={language === 'es' ? 'Escribe tu pregunta...' : 'Type your question...'}
                                            className={`flex-1 px-4 py-3 rounded-full border ${
                                                darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-300'
                                            } focus:outline-none focus:ring-2 focus:ring-rose-400`}
                                            disabled={lumiLoading}
                                        />
                                        <button
                                            onClick={sendToLumi}
                                            disabled={!lumiInput.trim() || lumiLoading}
                                            className="bg-gradient-to-r from-rose-400 to-amber-300 text-white rounded-full p-3 disabled:opacity-50 hover:scale-105 transition">
                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL MENSAJES PROACTIVOS DE LUMI - NUEVO ‚ú® */}
                    {showProactiveModal && proactiveMessages.length > 0 && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" onClick={() => {
                            setShowProactiveModal(false);
                            markMessagesAsRead();
                        }}>
                            <div 
                                className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] overflow-hidden flex flex-col`}
                                onClick={(e) => e.stopPropagation()}>
                                
                                {/* Header ‚Äî distinto para saludo vs d√≠a 3 patr√≥n */}
                                <div style={{
                                    background: proactiveMessages[0]?.message_type === 'pattern_insight'
                                        ? 'linear-gradient(135deg, #7c3aed, #a855f7)'
                                        : 'linear-gradient(135deg, #fb923c, #fbbf24)',
                                    padding: '1.25rem'
                                }}>
                                    <div className="flex items-center gap-3">
                                        <div style={{fontSize: '2.5rem'}}>
                                            {proactiveMessages[0]?.message_type === 'pattern_insight' ? 'üîç' : '‚òÄÔ∏è'}
                                        </div>
                                        <div>
                                            <h3 style={{fontWeight: 700, fontSize: '1.05rem', color: 'white', margin: 0}}>
                                                {proactiveMessages[0]?.message_type === 'pattern_insight'
                                                    ? (language === 'es' ? 'LUMI encontr√≥ tus patrones' : 'LUMI found your patterns')
                                                    : (language === 'es' ? 'LUMI te saluda' : 'LUMI says hi')}
                                            </h3>
                                            <p style={{fontSize: '0.78rem', color: 'rgba(255,255,255,0.85)', margin: 0, marginTop: '0.15rem'}}>
                                                {proactiveMessages[0]?.message_type === 'pattern_insight'
                                                    ? (language === 'es' ? '‚ú¶ D√≠a 3 ¬∑ An√°lisis completado' : '‚ú¶ Day 3 ¬∑ Analysis complete')
                                                    : (language === 'es' ? '‚ú¶ Tu coach personal' : '‚ú¶ Your personal coach')}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Messages */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {proactiveMessages.map((msg, idx) => (
                                        <div key={msg.id} className={`${darkMode ? 'bg-gray-700' : 'bg-purple-50'} rounded-xl p-4 border-l-4 border-purple-500`}>
                                            {/* Tipo de mensaje con emoji */}
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="text-xl">
                                                    {msg.message_type === 'pattern_detected' && 'üîç'}
                                                    {msg.message_type === 'greeting' && '‚òÄÔ∏è'}
                                                    {msg.message_type === 'check_in' && 'üí¨'}
                                                    {msg.message_type === 'encouragement' && 'üå∏'}
                                                </span>
                                                <span className={`text-xs font-semibold ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>
                                                    {msg.message_type === 'pattern_detected' && (language === 'es' ? 'Patr√≥n detectado' : 'Pattern detected')}
                                                    {msg.message_type === 'greeting' && (language === 'es' ? 'Saludo' : 'Greeting')}
                                                    {msg.message_type === 'check_in' && (language === 'es' ? 'Seguimiento' : 'Check-in')}
                                                    {msg.message_type === 'encouragement' && (language === 'es' ? '√Ånimo' : 'Encouragement')}
                                                </span>
                                            </div>
                                            
                                            {/* Texto del mensaje */}
                                            <p className={`text-sm leading-relaxed ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                {msg.message_text}
                                            </p>
                                            
                                            {/* Timestamp */}
                                            <p className={`text-xs mt-2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                                {new Date(msg.created_at).toLocaleTimeString(language === 'es' ? 'es-ES' : 'en-US', { 
                                                    hour: '2-digit', 
                                                    minute: '2-digit' 
                                                })}
                                            </p>
                                        </div>
                                    ))}
                                </div>

                                {/* Actions */}
                                <div className="p-4 border-t space-y-2">
                                    {/* D√≠a 3 trial ‚Üí bot√≥n ver patr√≥n prominente */}
                                    {proactiveMessages[0]?.message_type === 'pattern_insight' && symptoms.length >= 3 && (
                                        <button
                                            onClick={() => {
                                                setShowProactiveModal(false);
                                                markMessagesAsRead();
                                                const result = analyzePatterns(symptoms);
                                                if (result && result.length > 0) {
                                                    setPatternResult(result);
                                                    setShowPatternModal(true);
                                                    setPatternShown(true);
                                                }
                                            }}
                                            style={{
                                                width: '100%',
                                                background: 'linear-gradient(135deg, #7c3aed, #a855f7)',
                                                color: 'white',
                                                fontWeight: 700,
                                                fontSize: '0.95rem',
                                                padding: '0.85rem',
                                                borderRadius: '0.875rem',
                                                border: 'none',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            üìä {language === 'es' ? 'Ver mi patr√≥n de s√≠ntomas' : 'See my symptom pattern'}
                                        </button>
                                    )}
                                    <div className="flex gap-3">
                                        <button 
                                            onClick={() => {
                                                setShowProactiveModal(false);
                                                markMessagesAsRead();
                                                setShowLumiChat(true);
                                            }}
                                            className="flex-1 bg-gradient-to-r from-rose-400 to-amber-300 text-white py-3 rounded-xl font-semibold text-sm">
                                            üí¨ {language === 'es' ? 'Hablar con LUMI' : 'Talk to LUMI'}
                                        </button>
                                        <button 
                                            onClick={() => {
                                                setShowProactiveModal(false);
                                                markMessagesAsRead();
                                            }}
                                            className={`flex-1 py-3 rounded-xl font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-700'}`}>
                                            {language === 'es' ? 'Cerrar' : 'Close'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL SELECCI√ìN DE PLAN */}
                    {showPlanModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" onClick={() => setShowPlanModal(false)}>
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-lg`} onClick={(e) => e.stopPropagation()}>
                                <div className="bg-gradient-to-r from-rose-400 to-amber-300 text-white p-6">
                                    <h3 className="font-bold text-2xl mb-1">{language === 'es' ? 'Elige tu plan' : 'Choose your plan'}</h3>
                                    <p className="text-sm opacity-90">{language === 'es' ? 'Cancela cuando quieras' : 'Cancel anytime'}</p>
                                </div>
                                <div className="p-6 space-y-4">
                                    <button onClick={() => { setShowPlanModal(false); handleSubscribe('monthly'); }} className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-50 hover:bg-gray-100'} rounded-xl p-5 text-left border-2 border-transparent hover:border-rose-400 transition`}>
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <h4 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>{language === 'es' ? 'Mensual' : 'Monthly'}</h4>
                                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{language === 'es' ? 'M√°xima flexibilidad' : 'Maximum flexibility'}</p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-2xl font-bold text-rose-500">{PRICES[userRegion].monthly}</div>
                                                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{language === 'es' ? 'por mes' : 'per month'}</div>
                                            </div>
                                        </div>
                                    </button>
                                    <button onClick={() => { setShowPlanModal(false); handleSubscribe('annual'); }} className={`w-full bg-gradient-to-r from-rose-50 to-amber-50 ${darkMode ? 'from-rose-900/20 to-amber-900/20' : ''} rounded-xl p-5 text-left border-2 border-rose-400 hover:border-rose-500 transition relative`}>
                                        <div className="absolute top-2 right-2 bg-rose-500 text-white text-xs font-bold px-2 py-1 rounded-full">{language === 'es' ? `Ahorra ${PRICES[userRegion].annualSavings}` : `Save ${PRICES[userRegion].annualSavings}`}</div>
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <h4 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>{language === 'es' ? 'Anual' : 'Annual'}</h4>
                                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{language === 'es' ? 'Mejor precio' : 'Best value'}</p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-2xl font-bold text-rose-500">{PRICES[userRegion].annual}</div>
                                                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{language === 'es' ? 'por a√±o' : 'per year'}</div>
                                                <div className={`text-xs line-through ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{PRICES[userRegion].annualOriginal}</div>
                                            </div>
                                        </div>
                                    </button>
                                </div>
                                <div className="p-4 border-t">
                                    <button onClick={() => setShowPlanModal(false)} className={`w-full py-3 rounded-xl font-semibold ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-700'}`}>{language === 'es' ? 'Cancelar' : 'Cancel'}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL PATR√ìN D√çA 3 - LUMI TE MUESTRA TU PRIMER PATR√ìN */}
                    {showPatternModal && patternResult && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60">
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-md overflow-hidden max-h-[90vh] overflow-y-auto`}>
                                {/* Header */}
                                <div className="bg-gradient-to-r from-purple-500 to-rose-400 p-6 text-white text-center">
                                    <div className="text-4xl mb-2">üîç</div>
                                    <h3 className="text-xl font-bold">
                                        {language === 'es' ? 'LUMI encontr√≥ algo' : 'LUMI found something'}
                                    </h3>
                                    <p className="text-sm opacity-90 mt-1">
                                        {language === 'es' ? 'Tus 3 d√≠as en Lumera' : 'Your 3 days in Lumera'}
                                    </p>
                                </div>

                                {/* GR√ÅFICO 3 D√çAS */}
                                <div className={`mx-4 mt-5 p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                    <p className={`text-xs font-semibold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                        üìä {language === 'es' ? 'Tus √∫ltimos 3 d√≠as' : 'Your last 3 days'}
                                    </p>
                                    <canvas id="patternChart" height="140"></canvas>
                                </div>

                                {/* N√∫meros resumen */}
                                <div className="px-4 mt-4 grid grid-cols-3 gap-2">
                                    {(() => {
                                        const last3 = symptoms.slice(-3);
                                        const avg = (key) => last3.length > 0 ? (last3.reduce((a, s) => a + (s[key] || 0), 0) / last3.length).toFixed(1) : '0';
                                        return [
                                            { label: language === 'es' ? 'Sue√±o' : 'Sleep', val: avg('sleep'), icon: 'üò¥' },
                                            { label: language === 'es' ? 'Energ√≠a' : 'Energy', val: avg('energy'), icon: '‚ö°' },
                                            { label: language === 'es' ? '√Ånimo' : 'Mood', val: avg('mood'), icon: 'üíú' }
                                        ].map((item, i) => (
                                            <div key={i} className={`${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200'} rounded-lg p-3 text-center border`}>
                                                <div className="text-lg">{item.icon}</div>
                                                <div className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{item.val}</div>
                                                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{item.label}</div>
                                            </div>
                                        ));
                                    })()}
                                </div>

                                {/* Patrones */}
                                <div className="p-4 pt-4 space-y-3">
                                    {patternResult.map((p, idx) => (
                                        <div key={idx} className={`${darkMode ? 'bg-gray-700' : 'bg-purple-50'} rounded-xl p-4 border-l-4 border-purple-500`}>
                                            <p className={`text-sm leading-relaxed ${darkMode ? 'text-purple-200' : 'text-purple-900'}`}>
                                                üíú {p.message}
                                            </p>
                                        </div>
                                    ))}

                                    {/* Mensaje motivacional */}
                                    <div className={`${darkMode ? 'bg-emerald-900/40 border-emerald-700' : 'bg-emerald-50 border-emerald-300'} rounded-xl p-4 border`}>
                                        <p className={`text-sm font-semibold ${darkMode ? 'text-emerald-200' : 'text-emerald-800'} mb-1`}>
                                            üå± {language === 'es' ? 'Recuerda' : 'Remember'}
                                        </p>
                                        <p className={`text-xs ${darkMode ? 'text-emerald-300' : 'text-emerald-700'}`}>
                                            {language === 'es' 
                                                ? 'Estos cambios son parte natural de tu cuerpo en esta etapa. Estudios muestran que nutrici√≥n + ejercicio adaptado reducen s√≠ntomas 40-60%. Ya est√°s dando el primer paso.' 
                                                : 'These changes are a natural part of your body at this stage. Studies show adapted nutrition + exercise reduce symptoms 40-60%. You\'re already taking the first step.'}
                                        </p>
                                    </div>
                                </div>

                                {/* Botones */}
                                <div className="p-4 space-y-2">
                                    {/* Si es d√≠a 3 de trial, mostrar CTA de conversi√≥n prominente */}
                                    {getTrialDaysLeft() <= 1 && getUserTier() !== 'premium' && (
                                        <div style={{
                                            background: 'linear-gradient(135deg, #7c3aed, #a855f7)',
                                            borderRadius: '0.875rem',
                                            padding: '1rem',
                                            textAlign: 'center',
                                            marginBottom: '0.5rem'
                                        }}>
                                            <p style={{color: 'white', fontWeight: 700, fontSize: '0.95rem', marginBottom: '0.25rem'}}>
                                                {language === 'es' ? 'üíé ¬øQuieres seguir viendo estos patrones?' : 'üíé Want to keep seeing these patterns?'}
                                            </p>
                                            <p style={{color: 'rgba(255,255,255,0.85)', fontSize: '0.78rem', marginBottom: '0.75rem'}}>
                                                {language === 'es' ? 'Suscr√≠bete y LUMI seguir√° analizando cada d√≠a.' : 'Subscribe and LUMI will keep analyzing every day.'}
                                            </p>
                                            <button
                                                onClick={() => { setShowPatternModal(false); setCurrentPage('premium'); }}
                                                style={{
                                                    background: 'white',
                                                    color: '#7c3aed',
                                                    fontWeight: 700,
                                                    fontSize: '0.88rem',
                                                    padding: '0.55rem 1.5rem',
                                                    borderRadius: '9999px',
                                                    border: 'none',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                {language === 'es' ? '‚ú® Quiero continuar' : '‚ú® I want to continue'}
                                            </button>
                                        </div>
                                    )}
                                    <div className="flex gap-3">
                                        <button 
                                            onClick={() => { setShowPatternModal(false); setCurrentPage('symptoms'); }}
                                            className="flex-1 bg-gradient-to-r from-purple-500 to-rose-400 text-white py-3 rounded-xl font-semibold text-sm">
                                            {language === 'es' ? 'Ver mis gr√°ficas' : 'See my charts'}
                                        </button>
                                        <button 
                                            onClick={() => setShowPatternModal(false)}
                                            className={`flex-1 py-3 rounded-xl font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-700'}`}>
                                            {language === 'es' ? 'Entendido' : 'Got it'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Renderiza el chart cuando se abre el modal */}
                    {showPatternModal && patternResult && (() => {
                        setTimeout(() => {
                            const canvas = document.getElementById('patternChart');
                            if (!canvas) return;
                            if (canvas.__chartInstance) canvas.__chartInstance.destroy();
                            const ctx = canvas.getContext('2d');
                            const last3 = symptoms.slice(0, 3).reverse();
                            const labels = last3.map((s, i) => {
                                const dateStr = s.symptom_date || s.date;
                                if (dateStr) {
                                    const d = new Date(dateStr);
                                    return language === 'es' 
                                        ? ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'][d.getDay()]
                                        : ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
                                }
                                return language === 'es' ? 'D√≠a ' + (i+1) : 'Day ' + (i+1);
                            });
                            canvas.__chartInstance = new window.Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [
                                        { label: language === 'es' ? 'Sue√±o' : 'Sleep', data: last3.map(s => s.sleep || 0), borderColor: '#60a5fa', tension: 0.4, fill: false, pointRadius: 4, pointBackgroundColor: '#60a5fa' },
                                        { label: language === 'es' ? 'Energ√≠a' : 'Energy', data: last3.map(s => s.energy || 0), borderColor: '#fbbf24', tension: 0.4, fill: false, pointRadius: 4, pointBackgroundColor: '#fbbf24' },
                                        { label: language === 'es' ? '√Ånimo' : 'Mood', data: last3.map(s => s.mood || 0), borderColor: '#a78bfa', tension: 0.4, fill: false, pointRadius: 4, pointBackgroundColor: '#a78bfa' }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    scales: {
                                        y: { min: 0, max: 10, ticks: { stepSize: 2, color: darkMode ? '#9ca3af' : '#6b7280', font: { size: 10 } }, grid: { color: darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.06)' } },
                                        x: { ticks: { color: darkMode ? '#9ca3af' : '#6b7280', font: { size: 11 } }, grid: { display: false } }
                                    },
                                    plugins: { legend: { labels: { color: darkMode ? '#d1d5db' : '#374151', font: { size: 10 }, boxWidth: 10 } } }
                                }
                            });
                        }, 120);
                        return null;
                    })()}



                    {/* MODAL GU√çA: SIN PERIODO / PERIODO IRREGULAR */}
                    {currentUser && periodLog.length > 0 && getMonthsWithoutPeriod() >= 12 && currentPage === 'period' && (
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 mt-4 border-2 border-purple-300`}>
                            <div className="text-center mb-4">
                                <div className="text-3xl mb-2">üå±</div>
                                <h3 className={`text-lg font-bold ${darkMode ? 'text-purple-200' : 'text-purple-800'}`}>
                                    {language === 'es' ? 'Algo importante' : 'Something important'}
                                </h3>
                            </div>

                            <p className={`text-sm leading-relaxed text-center mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                {language === 'es'
                                    ? `Llevas m√°s de ${getMonthsWithoutPeriod()} meses sin registrar un per√≠odo. Si realmente no te ha venido durante este tiempo, es posible que tu cuerpo est√© en una nueva fase. Eso est√° bien. No es el final de nada. Si no lo has consultado con un profesional de salud, puede ser un buen momento para hacerlo.`
                                    : `You've gone more than ${getMonthsWithoutPeriod()} months without logging a period. If it really hasn't come during this time, your body might be in a new phase. That's okay. It's not the end of anything. If you haven't spoken to a health professional about it, it might be a good time to do so.`}
                            </p>

                            {/* Qu√© esperar */}
                            <div className={`${darkMode ? 'bg-purple-900' : 'bg-purple-50'} rounded-lg p-4 mb-4`}>
                                <p className={`text-sm font-semibold mb-2 ${darkMode ? 'text-purple-200' : 'text-purple-800'}`}>
                                    {language === 'es' ? '¬øQu√© puede pasar?' : 'What might happen?'}
                                </p>
                                <ul className={`text-xs space-y-1.5 ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>
                                    {(language === 'es' 
                                        ? ['Cambios en el sue√±o ‚Äî puede volverse m√°s ligero o interrumpido debido a cambios hormonales', 'Sofocos m√°s frecuentes o intensos, especialmente por la noche', 'Cambios de humor relacionados con la variabilidad hormonal', 'Mayor sensibilidad al estr√©s', 'Cambios en el metabolismo y en c√≥mo tu cuerpo maneja los nutrientes', 'Tu nivel de energ√≠a puede variar m√°s de un d√≠a a otro']
                                        : ['Sleep changes ‚Äî it may become lighter or interrupted due to hormonal shifts', 'More frequent or intense hot flashes, especially at night', 'Mood changes linked to hormonal variability', 'Greater sensitivity to stress', 'Metabolism changes and how your body processes nutrients', 'Your energy levels may vary more from day to day']
                                    ).map((item, i) => (
                                        <li key={i} className="flex items-start gap-1.5">
                                            <span className="text-purple-400 mt-0.5">‚Ä¢</span>
                                            <span>{item}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>

                            {/* Algo esperanzador */}
                            <div className={`${darkMode ? 'bg-emerald-900' : 'bg-emerald-50'} rounded-lg p-4 border-l-4 border-emerald-500`}>
                                <p className={`text-sm leading-relaxed ${darkMode ? 'text-emerald-200' : 'text-emerald-800'}`}>
                                    <span className="font-semibold">‚ú® {language === 'es' ? 'Y tambi√©n esto:' : 'And also this:'}</span>{' '}
                                    {language === 'es'
                                        ? 'Muchas mujeres reportan que en esta fase recuperan energ√≠a, sienten m√°s claridad mental y encuentran una nueva relaci√≥n con su cuerpo. Es un cambio, no una p√©rdida. Y Lumera te acompa√±ar√° en cada paso.'
                                        : 'Many women report that in this phase they regain energy, feel more mental clarity, and find a new relationship with their body. It\'s a change, not a loss. And Lumera will be with you every step of the way.'}
                                </p>
                            </div>
                        </div>
                    )}

                    {/* MODAL EDITAR PERFIL - COMPACTO Y VISUAL */}
                    {showEditProfile && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={() => setShowEditProfile(false)}>
                            <div 
                                className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-md p-6`}
                                onClick={(e) => e.stopPropagation()}>
                                
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold gradient-text">
                                        {language === 'es' ? '‚öôÔ∏è Editar Perfil' : '‚öôÔ∏è Edit Profile'}
                                    </h3>
                                    <button 
                                        onClick={() => setShowEditProfile(false)}
                                        className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-900'} text-2xl`}
                                    >
                                        √ó
                                    </button>
                                </div>

                                <div className="grid grid-cols-2 gap-3 mb-6">
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 text-center`}>
                                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>IMC Actual</p>
                                        <p className="text-lg font-bold gradient-text">{currentUser?.bmi || '-'}</p>
                                    </div>
                                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 text-center`}>
                                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>TDEE Actual</p>
                                        <p className="text-lg font-bold gradient-text">{currentUser?.tdee || '-'}</p>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
                                            {language === 'es' ? '‚öñÔ∏è Peso (kg)' : '‚öñÔ∏è Weight (kg)'}
                                        </label>
                                        <input 
                                            type="number" 
                                            step="0.1"
                                            value={editingWeight || currentUser?.weight || ''}
                                            onChange={(e) => setEditingWeight(e.target.value)}
                                            placeholder={currentUser?.weight?.toString() || ''}
                                            className={`w-full px-4 py-3 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                        />
                                    </div>

                                    <div>
                                        <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
                                            {language === 'es' ? 'üí™ Nivel de Actividad' : 'üí™ Activity Level'}
                                        </label>
                                        <select 
                                            value={editingActivity || currentUser?.activity_level || 'moderate'}
                                            onChange={(e) => setEditingActivity(e.target.value)}
                                            className={`w-full px-4 py-3 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                        >
                                            <option value="sedentary">{language === 'es' ? 'Sedentario' : 'Sedentary'}</option>
                                            <option value="light">{language === 'es' ? 'Ligero' : 'Light'}</option>
                                            <option value="moderate">{language === 'es' ? 'Moderado' : 'Moderate'}</option>
                                            <option value="active">{language === 'es' ? 'Activo' : 'Active'}</option>
                                            <option value="very_active">{language === 'es' ? 'Muy activo' : 'Very active'}</option>
                                        </select>
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-6">
                                    <button
                                        onClick={() => setShowEditProfile(false)}
                                        className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-800'}`}
                                    >
                                        {language === 'es' ? 'Cancelar' : 'Cancel'}
                                    </button>
                                    <button
                                        onClick={async () => {
                                            const weight = editingWeight || currentUser.weight;
                                            const activity = editingActivity || currentUser.activity_level;
                                            
                                            if (!weight || weight <= 0) {
                                                alert(language === 'es' ? 'Ingresa un peso v√°lido' : 'Enter a valid weight');
                                                return;
                                            }
                                            
                                            const metrics = await updateUserMetrics(
                                                currentUser.id,
                                                weight,
                                                currentUser.height,
                                                currentUser.age,
                                                activity
                                            );
                                            
                                            if (metrics) {
                                                setCurrentUser({
                                                    ...currentUser,
                                                    weight: parseFloat(weight),
                                                    activity_level: activity,
                                                    bmi: parseFloat(metrics.bmi),
                                                    tdee: parseInt(metrics.tdee)
                                                });
                                                
                                                setShowEditProfile(false);
                                                alert(language === 'es' ? '‚úÖ Perfil actualizado' : '‚úÖ Profile updated');
                                            } else {
                                                alert(language === 'es' ? 'Error al actualizar' : 'Error updating');
                                            }
                                        }}
                                        className="flex-1 bg-gradient-to-r from-rose-400 to-amber-300 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition"
                                    >
                                        {language === 'es' ? 'Guardar' : 'Save'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MODAL RESETEO DE CONTRASE√ëA */}
                    {showPasswordReset && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={() => setShowPasswordReset(false)}>
                            <div 
                                className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6"
                                onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold gradient-text">{language === 'es' ? 'üîë Resetear Contrase√±a' : 'üîë Reset Password'}</h3>
                                    <button onClick={() => setShowPasswordReset(false)} className="text-gray-600 hover:text-gray-900 text-2xl">√ó</button>
                                </div>
                                <p className="text-sm mb-4 text-gray-600">
                                    {language === 'es' ? 'Te enviaremos un email.' : 'We will send you an email.'}
                                </p>
                                <input type="email" placeholder="Email" value={resetEmail} onChange={(e) => setResetEmail(e.target.value)} className="input-elegant w-full mb-6" />
                                <button onClick={handlePasswordReset} className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition">
                                    {language === 'es' ? 'Enviar' : 'Send'}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* MODAL PERFIL METAB√ìLICO */}
                    {showProfileModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={() => setShowProfileModal(false)}>
                            <div 
                                className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-md p-6`}
                                onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold gradient-text">
                                        {language === 'es' ? 'üìä Perfil Metab√≥lico' : 'üìä Metabolic Profile'}
                                    </h3>
                                    <button onClick={() => setShowProfileModal(false)} className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} hover:text-gray-900 text-2xl`}>√ó</button>
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className={`text-sm font-semibold block mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            {language === 'es' ? 'Peso (kg)' : 'Weight (kg)'}
                                        </label>
                                        <input
                                            type="number"
                                            value={editWeight}
                                            onChange={(e) => setEditWeight(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-purple-500"
                                            placeholder="65"
                                        />
                                    </div>

                                    <div>
                                        <label className={`text-sm font-semibold block mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            {language === 'es' ? 'Altura (cm)' : 'Height (cm)'}
                                        </label>
                                        <input
                                            type="number"
                                            value={editHeight}
                                            onChange={(e) => setEditHeight(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-purple-500"
                                            placeholder="165"
                                        />
                                    </div>

                                    <div>
                                        <label className={`text-sm font-semibold block mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            {language === 'es' ? 'Edad' : 'Age'}
                                        </label>
                                        <input
                                            type="number"
                                            value={editAge}
                                            onChange={(e) => setEditAge(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-purple-500"
                                            placeholder="45"
                                        />
                                    </div>

                                    <div>
                                        <label className={`text-sm font-semibold block mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            {language === 'es' ? 'Nivel de Actividad' : 'Activity Level'}
                                        </label>
                                        <select
                                            value={editActivityLevel}
                                            onChange={(e) => setEditActivityLevel(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-purple-500"
                                        >
                                            <option value="sedentary">{language === 'es' ? 'Sedentario (poco ejercicio)' : 'Sedentary (little exercise)'}</option>
                                            <option value="light">{language === 'es' ? 'Ligero (1-3 d√≠as/semana)' : 'Light (1-3 days/week)'}</option>
                                            <option value="moderate">{language === 'es' ? 'Moderado (3-5 d√≠as/semana)' : 'Moderate (3-5 days/week)'}</option>
                                            <option value="active">{language === 'es' ? 'Activo (6-7 d√≠as/semana)' : 'Active (6-7 days/week)'}</option>
                                            <option value="very_active">{language === 'es' ? 'Muy activo (trabajo f√≠sico)' : 'Very active (physical job)'}</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className={`text-sm font-semibold block mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                            {language === 'es' ? 'Objetivo' : 'Goal'}
                                        </label>
                                        <select
                                            value={editGoal}
                                            onChange={(e) => setEditGoal(e.target.value)}
                                            className="w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-purple-500"
                                        >
                                            <option value="lose">{language === 'es' ? 'Perder peso' : 'Lose weight'}</option>
                                            <option value="maintain">{language === 'es' ? 'Mantener peso' : 'Maintain weight'}</option>
                                            <option value="gain">{language === 'es' ? 'Ganar peso' : 'Gain weight'}</option>
                                        </select>
                                    </div>

                                    <button
                                        onClick={saveMetabolicProfile}
                                        className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition mt-6"
                                    >
                                        {language === 'es' ? 'üíæ Guardar' : 'üíæ Save'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }; // Cierra LumeraApp

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LumeraApp />);
    </script>
</body>
</html>
